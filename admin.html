<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>BookStore Admin</title>
        <link rel="stylesheet" href="css/admin.css" />
    </head>
    <body>
        <header class="topbar">
            <div class="brand">
                <div class="logo">B</div>
                <div>BookStore Admin</div>
            </div>

            <nav class="navlist" aria-label="Main navigation">
                <div
                    class="nav-item active"
                    data-tab="dashboard"
                    onclick="switchTab('dashboard', this)"
                >
                    🏠 Dashboard
                </div>
                <div
                    class="nav-item"
                    data-tab="products"
                    onclick="switchTab('products', this)"
                >
                    📚 Sản phẩm
                </div>
                <div
                    class="nav-item"
                    data-tab="orders"
                    onclick="switchTab('orders', this)"
                >
                    🧾 Đơn hàng
                </div>
                <div
                    class="nav-item"
                    data-tab="users"
                    onclick="switchTab('users', this)"
                >
                    👥 Người dùng
                </div>
                <div
                    class="nav-item"
                    data-tab="import"
                    onclick="switchTab('import', this)"
                >
                    📦 Nhập hàng
                </div>
                <div
                    class="nav-item"
                    data-tab="pricing"
                    onclick="switchTab('pricing', this)"
                >
                    💲 Giá bán
                </div>
                <div
                    class="nav-item"
                    data-tab="inventory"
                    onclick="switchTab('inventory', this)"
                >
                    📊 Nhập xuất tồn
                </div>
            </nav>

            <div class="top-actions">
                <div class="btn-pill">Admin</div>
                <div class="btn-pill" onclick="logout()">Đăng xuất</div>
            </div>
        </header>

        <main class="container">
            <!-- DASHBOARD -->
            <section id="dashboard" class="tab">
                <h1 class="page-title">📊 Dashboard</h1>

                <div class="stats-grid" id="statsGrid">
                    <div class="card">
                        <div class="icon">📚</div>
                        <div class="meta">
                            <div class="label">Tổng sản phẩm</div>
                            <div class="value" id="statProducts">0</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="icon">💰</div>
                        <div class="meta">
                            <div class="label">Doanh thu</div>
                            <div class="value" id="statRevenue">0 ₫</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="icon">🛒</div>
                        <div class="meta">
                            <div class="label">Đơn hàng</div>
                            <div class="value" id="statOrders">0</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="icon">👥</div>
                        <div class="meta">
                            <div class="label">Người dùng</div>
                            <div class="value" id="statUsers">0</div>
                        </div>
                    </div>

                    <div
                        class="card"
                        id="lowStockCard"
                        style="display: none; border-left: 4px solid #f59e0b"
                    >
                        <div class="meta">
                            <div class="label">Sản phẩm sắp hết</div>
                            <div
                                class="value"
                                id="statLowStock"
                                style="font-weight: 800"
                            >
                                0
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel" style="margin-bottom: 22px">
                    <div
                        style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 12px;
                        "
                    >
                        <div class="section-title">⚡ Thao tác nhanh</div>
                        <div style="color: var(--muted); font-size: 14px">
                            Thêm, xem hoặc báo cáo nhanh
                        </div>
                    </div>
                    <div class="quick-grid">
                        <div
                            class="quick"
                            onclick="switchTab('products', document.querySelector('[data-tab=products]'))"
                        >
                            <div class="big">➕</div>
                            <div>Thêm sản phẩm</div>
                        </div>
                        <div
                            class="quick"
                            onclick="switchTab('orders', document.querySelector('[data-tab=orders]'))"
                        >
                            <div class="big">📦</div>
                            <div>Xem đơn hàng</div>
                        </div>
                        <div
                            class="quick"
                            onclick="switchTab('users', document.querySelector('[data-tab=users]'))"
                        >
                            <div class="big">👥</div>
                            <div>Quản lý người dùng</div>
                        </div>
                        <div class="quick" onclick="exportData()">
                            <div class="big">📈</div>
                            <div>Xuất dữ liệu</div>
                        </div>
                    </div>
                </div>

                <div class="panel" style="margin-bottom: 18px">
                    <div
                        style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 12px;
                        "
                    >
                        <div class="section-title">🛒 Đơn hàng gần đây</div>
                        <div
                            style="color: teal; cursor: pointer"
                            onclick="switchTab('orders', document.querySelector('[data-tab=orders]'))"
                        >
                            Xem tất cả →
                        </div>
                    </div>
                    <table class="table" id="recentOrdersTable">
                        <thead>
                            <tr>
                                <th>Mã đơn</th>
                                <th>Khách hàng</th>
                                <th>Ngày đặt</th>
                                <th>Tổng tiền</th>
                                <th>Trạng thái</th>
                            </tr>
                        </thead>
                        <tbody id="recentOrdersBody"></tbody>
                    </table>
                </div>

                <div class="panel">
                    <div
                        style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 12px;
                        "
                    >
                        <div class="section-title">🔥 Sản phẩm bán chạy</div>
                        <div
                            style="color: teal; cursor: pointer"
                            onclick="switchTab('products', document.querySelector('[data-tab=products]'))"
                        >
                            Xem tất cả →
                        </div>
                    </div>
                    <div id="topProducts" style="min-height: 120px"></div>
                </div>
            </section>

            <!-- PRODUCTS -->
            <section id="products" class="tab" style="display: none">
                <h1 class="page-title">📚 Quản lý sản phẩm</h1>

                <div class="panel" style="margin-bottom: 18px">
                    <div class="section-title">➕ Thêm/Sửa sản phẩm</div>
                    <form id="productForm" onsubmit="return false">
                        <input type="hidden" id="productId" />

                        <div class="form-row">
                            <div class="form-group">
                                <label>Tiêu đề *</label>
                                <input
                                    id="productTitle"
                                    placeholder="Nhập tên sách"
                                    required
                                />
                            </div>
                            <div class="form-group">
                                <label>Tác giả *</label>
                                <input
                                    id="productAuthor"
                                    placeholder="Tên tác giả"
                                    required
                                />
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Giá (VNĐ) *</label>
                                <input
                                    id="productPrice"
                                    type="number"
                                    placeholder="0"
                                    required
                                />
                            </div>
                            <!-- <div class="form-group">
                                <label>Số lượng tồn kho *</label>
                                <input
                                    id="productStock"
                                    type="number"
                                    placeholder="0"
                                    min="0"
                                />
                            </div> -->
                            <div class="form-group">
                                <label>Thể loại *</label>
                                <input
                                    id="productCategory"
                                    placeholder="VD: Văn học, Công nghệ..."
                                    required
                                />
                            </div>
                        </div>
                        <input type="hidden" id="productStock" value="0" />

                        <div class="form-group">
                            <label>Ảnh bìa *</label>
                            <input
                                type="file"
                                id="productImage"
                                accept="image/*"
                                onchange="previewProductImage(this)"
                            />
                            <div
                                id="productImagePreview"
                                style="margin-top: 10px; display: none"
                            >
                                <img
                                    id="productImagePreviewImg"
                                    src=""
                                    alt="Preview"
                                    style="
                                        max-width: 200px;
                                        max-height: 200px;
                                        border-radius: 8px;
                                        border: 1px solid #e6eef2;
                                    "
                                />
                            </div>
                            <small
                                style="
                                    color: var(--muted);
                                    font-size: 0.85rem;
                                    display: block;
                                    margin-top: 4px;
                                "
                            >
                                * Bắt buộc khi thêm mới, tùy chọn khi chỉnh sửa
                            </small>
                        </div>

                        <div class="form-group">
                            <label>Mô tả *</label>
                            <textarea
                                id="productDesc"
                                rows="3"
                                placeholder="Mô tả ngắn về sách..."
                                required
                            ></textarea>
                        </div>

                        <div style="display: flex; gap: 10px">
                            <button
                                style="
                                    background: var(--primary);
                                    color: white;
                                    flex: 1;
                                "
                                onclick="saveProduct()"
                            >
                                💾 Lưu sản phẩm
                            </button>
                            <button
                                style="background: #e5e7eb; color: #374151"
                                onclick="clearProductForm()"
                            >
                                🔄 Xóa form
                            </button>
                        </div>
                    </form>
                </div>

                <div class="panel">
                    <div
                        style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 12px;
                            flex-wrap: wrap;
                            gap: 12px;
                        "
                    >
                        <div class="section-title">📋 Danh sách sản phẩm</div>
                        <div style="display: flex; gap: 8px">
                            <input
                                id="searchProd"
                                placeholder="🔍 Tìm kiếm (ID, tên, tác giả)..."
                                style="
                                    width: 300px;
                                    padding: 8px;
                                    border: 1px solid #eef3f6;
                                    border-radius: 8px;
                                "
                                oninput="renderProductsList()"
                            />
                        </div>
                    </div>

                    <table class="table" id="productsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tiêu đề</th>
                                <th>Tác giả</th>
                                <th>Giá</th>
                                <th>Số lượng</th>
                                <th>Thể loại</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="productsBody"></tbody>
                    </table>

                    <!-- Pagination -->
                    <div
                        id="productsPagination"
                        style="
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            gap: 10px;
                            margin-top: 20px;
                            padding: 15px 0;
                            flex-wrap: wrap;
                        "
                    ></div>
                </div>
            </section>

            <!-- ORDERS -->
            <section id="orders" class="tab" style="display: none">
                <h1 class="page-title">🧾 Quản lý đơn hàng</h1>
                <div class="panel">
                    <div
                        style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 12px;
                            flex-wrap: wrap;
                            gap: 12px;
                        "
                    >
                        <div class="section-title">📦 Danh sách đơn hàng</div>
                        <div>
                            <input
                                id="searchOrder"
                                placeholder="🔍 Tìm mã đơn/khách"
                                style="
                                    padding: 8px;
                                    border: 1px solid #eef3f6;
                                    border-radius: 8px;
                                    width: 200px;
                                "
                                oninput="renderOrdersList()"
                            />
                        </div>
                    </div>

                    <table class="table">
                        <thead>
                            <tr>
                                <th>Mã đơn</th>
                                <th>Khách hàng</th>
                                <th>Ngày</th>
                                <th>Tổng tiền</th>
                                <th>Trạng thái</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="ordersBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- USERS -->
            <section id="users" class="tab" style="display: none">
                <h1 class="page-title">👥 Quản lý người dùng</h1>
                <div class="panel">
                    <div
                        style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 12px;
                        "
                    >
                        <div class="section-title">👤 Danh sách người dùng</div>
                    </div>

                    <table class="table">
                        <thead>
                            <tr>
                                <th>Email/Username</th>
                                <th>Trạng thái</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="usersBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- PRICING -->
            <!-- PRICING -->
            <section id="pricing" class="tab" style="display: none">
                <h1 class="page-title">💲 Quản lý Giá Bán Theo Sản Phẩm</h1>

                <!-- Thống kê tổng quan -->
                <div class="stats-grid" style="margin-bottom: 20px">
                    <div class="card">
                        <div class="icon">📊</div>
                        <div class="meta">
                            <div class="label">% Lợi nhuận TB</div>
                            <div class="value" id="avgProfit">0%</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="icon">💰</div>
                        <div class="meta">
                            <div class="label">Lợi nhuận/SP TB</div>
                            <div class="value" id="avgProfitAmount">0 ₫</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="icon">🔥</div>
                        <div class="meta">
                            <div class="label">SP lợi nhuận cao</div>
                            <div class="value" id="highProfitCount">0</div>
                        </div>
                    </div>
                </div>

                <!-- Cập nhật lợi nhuận hàng loạt -->
                <div
                    class="panel"
                    style="
                        margin-bottom: 18px;
                        background: #f0f9ff;
                        border-left: 4px solid #3b82f6;
                    "
                >
                  
                    <div class="form-row">
                        <div class="form-group">
                            <label>Chọn thể loại:</label>
                            <select
                                id="bulkUpdateCategory"
                                style="
                                    padding: 10px;
                                    border: 1px solid #eef3f6;
                                    border-radius: 8px;
                                    width: 100%;
                                "
                            >
                                <option value="">-- Chọn thể loại --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tỷ lệ lợi nhuận (%):</label>
                            <input
                                type="number"
                                id="bulkUpdateProfit"
                                placeholder="VD: 15"
                                min="0"
                                max="1000"
                                step="0.1"
                                style="
                                    padding: 10px;
                                    border: 1px solid #eef3f6;
                                    border-radius: 8px;
                                    width: 100%;
                                "
                            />
                        </div>
                        <div
                            class="form-group"
                            style="display: flex; align-items: flex-end"
                        >
                            <button
                                type="button"
                                onclick="bulkUpdateProfitByCategory()"
                                style="
                                    background: #3b82f6;
                                    color: white;
                                    padding: 10px 24px;
                                    border: none;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    width: 100%;
                                "
                            >
                                Cập nhật 
                            </button>
                        </div>
                    </div>
                  
                </div>

                <!-- Bảng quản lý giá -->
                <div class="panel">
                    <div class="section-title">
                        📋 Danh sách sản phẩm và giá bán
                    </div>

                    <div
                        style="
                            display: grid;
                            grid-template-columns: 2fr 1fr 1fr 1fr;
                            gap: 10px;
                            margin-bottom: 15px;
                        "
                    >
                        <input
                            type="text"
                            id="searchPricing"
                            placeholder="🔍 Tìm kiếm theo tên sách hoặc ID..."
                            style="
                                padding: 10px;
                                border: 1px solid #eef3f6;
                                border-radius: 8px;
                            "
                            oninput="renderPricingTable()"
                        />
                        <select
                            id="categoryFilterPricing"
                            style="
                                padding: 10px;
                                border: 1px solid #eef3f6;
                                border-radius: 8px;
                            "
                            onchange="renderPricingTable()"
                        >
                            <option value="">-- Tất cả thể loại --</option>
                        </select>
                        <input
                            type="number"
                            id="profitFilterMin"
                            placeholder="Lợi nhuận từ (%)"
                            min="0"
                            step="0.1"
                            style="
                                padding: 10px;
                                border: 1px solid #eef3f6;
                                border-radius: 8px;
                            "
                            oninput="renderPricingTable()"
                        />
                        <input
                            type="number"
                            id="profitFilterMax"
                            placeholder="Lợi nhuận đến (%)"
                            min="0"
                            step="0.1"
                            style="
                                padding: 10px;
                                border: 1px solid #eef3f6;
                                border-radius: 8px;
                            "
                            oninput="renderPricingTable()"
                        />
                    </div>

                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tên sách</th>
                                <th>Thể loại</th>
                                <th>Giá vốn (₫)</th>
                                <th>% Lợi nhuận</th>
                                <th>Giá bán (₫)</th>
                                <th>Lợi nhuận/SP (₫)</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="pricingTableBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- IMPORT -->
            <section id="import" class="tab" style="display: none">
                <h1 class="page-title">📦 Nhập hàng / Quản lý phiếu nhập</h1>

                <div class="panel" style="margin-bottom: 18px">
                    <div class="section-title">
                        ➕ Thêm / Hoàn thành Phiếu Nhập
                    </div>
                    <form id="importForm" onsubmit="return false">
                        <input type="hidden" id="importId" />
                        <div class="form-row">
                            <div class="form-group">
                                <label>Ngày nhập (dd/mm/yyyy):</label>
                                <input type="date" id="importDate" required />
                            </div>
                        </div>

                        <div
                            style="
                                margin-bottom: 20px;
                                padding: 15px;
                                background: #f0f9ff;
                                border-radius: 8px;
                                border-left: 3px solid #3b82f6;
                            "
                        >
                            <div
                                style="
                                    font-weight: 600;
                                    margin-bottom: 12px;
                                    color: #1e40af;
                                "
                            >
                                ➕ Thêm sản phẩm vào phiếu nhập
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Chọn sản phẩm:</label>
                                    <select
                                        id="importProductSelect"
                                        style="
                                            padding: 10px;
                                            border: 1px solid #eef3f6;
                                            border-radius: 8px;
                                            width: 100%;
                                        "
                                        onchange="fillProductId(this.value)"
                                    >
                                        <option value="">
                                            -- Chọn sản phẩm từ danh sách --
                                        </option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Hoặc nhập ID Sản phẩm:</label>
                                    <input
                                        type="text"
                                        id="importProductId"
                                        placeholder="b001"
                                    />
                                </div>
                                <div class="form-group">
                                    <label>Số lượng nhập:</label>
                                    <input
                                        type="number"
                                        id="importQuantity"
                                        placeholder="0"
                                        min="1"
                                    />
                                </div>
                                <div class="form-group">
                                    <label>Giá nhập (VNĐ) / 1 sản phẩm:</label>
                                    <input
                                        type="number"
                                        id="importPrice"
                                        placeholder="0"
                                        min="0"
                                    />
                                </div>
                            </div>
                            <button
                                type="button"
                                onclick="addProductToReceipt()"
                                style="
                                    background: #10b981;
                                    color: white;
                                    padding: 10px 20px;
                                    border: none;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: 600;
                                "
                            >
                                ➕ Thêm vào phiếu
                            </button>
                        </div>

                        <div id="importItemsList" style="margin-bottom: 20px">
                            <div style="font-weight: 600; margin-bottom: 12px">
                                📦 Danh sách sản phẩm trong phiếu:
                            </div>
                            <div
                                id="importItemsContainer"
                                style="min-height: 50px"
                            >
                                <div
                                    style="
                                        text-align: center;
                                        padding: 20px;
                                        color: var(--muted);
                                    "
                                >
                                    Chưa có sản phẩm nào trong phiếu
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px">
                            <button
                                type="button"
                                onclick="saveImportReceipt()"
                                style="
                                    background: teal;
                                    color: white;
                                    padding: 12px 24px;
                                    border: none;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: 600;
                                "
                            >
                                💾 Lưu phiếu nhập
                            </button>
                            <button
                                type="button"
                                onclick="resetImportForm()"
                                style="
                                    background: #ddd;
                                    color: #374151;
                                    padding: 12px 24px;
                                    border: none;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: 600;
                                "
                            >
                                🔄 Xóa form
                            </button>
                        </div>
                        <div
                            style="
                                margin-top: 12px;
                                padding: 12px;
                                background: #e8f5e9;
                                border-radius: 8px;
                                color: #2e7d32;
                                font-size: 14px;
                            "
                        >
                            <strong>💡 Hướng dẫn:</strong>
                            <ul style="margin: 8px 0 0 20px">
                                <li>
                                    Bước 1: Thêm các sản phẩm vào phiếu nhập
                                    bằng nút "➕ Thêm vào phiếu"
                                </li>
                                <li>
                                    Bước 2: Nhấn "💾 Lưu phiếu nhập" → Tạo phiếu
                                    nhập (chưa vào kho)
                                </li>
                                <li>
                                    Bước 3: Nhấn "✅ Hoàn thành" → Số lượng tự
                                    động cộng vào kho cho tất cả sản phẩm
                                </li>
                                <li>
                                    Lưu ý: Phiếu đã hoàn thành không thể sửa!
                                </li>
                            </ul>
                        </div>
                    </form>
                </div>

                <div class="panel">
                    <div class="section-title">📋 Danh sách Phiếu Nhập</div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Ngày nhập</th>
                                <th>Sản phẩm</th>
                                <th>Tổng số lượng</th>
                                <th>Tổng tiền</th>
                                <th>Trạng thái</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="importBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- INVENTORY TRACKING -->
            <section id="inventory" class="tab" style="display: none">
                <h1 class="page-title">📊 Tra cứu Nhập - Xuất - Tồn</h1>

                <div class="panel" style="margin-bottom: 18px">
                    <div
                        style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 12px;
                            flex-wrap: wrap;
                            gap: 12px;
                        "
                    >
                        <div class="section-title">🔍 Tìm kiếm và lọc</div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tìm kiếm sản phẩm:</label>
                            <input
                                id="inventorySearch"
                                placeholder="Nhập ID, tên sách hoặc tác giả..."
                                style="
                                    padding: 10px;
                                    border: 1px solid #eef3f6;
                                    border-radius: 8px;
                                "
                                oninput="renderInventoryList()"
                            />
                        </div>
                        <div class="form-group">
                            <label>Lọc theo thể loại:</label>
                            <select
                                id="inventoryCategoryFilter"
                                style="
                                    padding: 10px;
                                    border: 1px solid #eef3f6;
                                    border-radius: 8px;
                                "
                                onchange="renderInventoryList()"
                            >
                                <option value="">-- Tất cả thể loại --</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="section-title">
                        📋 Báo cáo Nhập - Xuất - Tồn
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tên sản phẩm</th>
                                <th>Tác giả</th>
                                <th>Tồn đầu kỳ</th>
                                <th>Tổng nhập</th>
                                <th>Tổng xuất</th>
                                <th>Tồn cuối kỳ</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryBody"></tbody>
                    </table>
                </div>
            </section>
        </main>

        <script>
            /* ===== STORAGE HELPERS ===== */
            const getProducts = () =>
                JSON.parse(localStorage.getItem('bs_products') || '[]')
            const saveProducts = (arr) =>
                localStorage.setItem('bs_products', JSON.stringify(arr))
            const getOrders = () =>
                JSON.parse(localStorage.getItem('orders') || '[]')
            const saveOrders = (arr) =>
                localStorage.setItem('orders', JSON.stringify(arr))
            const getUsers = () =>
                JSON.parse(localStorage.getItem('bs_users') || '[]')
            const saveUsers = (arr) =>
                localStorage.setItem('bs_users', JSON.stringify(arr))
            const getCategories = () =>
                JSON.parse(localStorage.getItem('bs_categories') || '[]')
            const saveCategories = (arr) =>
                localStorage.setItem('bs_categories', JSON.stringify(arr))

            /* ===== SEED DATA ===== */
            async function seedData() {
                // Load products từ books.json nếu chưa có
                if (getProducts().length === 0) {
                    try {
                        const res = await fetch('data/books.json')
                        const books = await res.json()
                        // Thêm stock mặc định cho mỗi sản phẩm
                        books.forEach((book) => {
                            if (book.stock === undefined) book.stock = 0
                        })
                        saveProducts(books)
                        console.log(
                            '✅ Đã load',
                            books.length,
                            'sản phẩm từ books.json'
                        )
                    } catch (e) {
                        console.warn(
                            '⚠️ Không load được books.json, sử dụng dữ liệu mẫu'
                        )
                        const sampleProducts = [
                            {
                                id: 'b001',
                                title: 'Atomic Habits',
                                author: 'James Clear',
                                price: 195000,
                                stock: 0,
                                category: 'Phát triển bản thân',
                                cover: 'https://images.unsplash.com/photo-1515378791036-0648a3ef77b2?w=800',
                                desc: 'Cẩm nang thay đổi thói quen hiệu quả',
                            },
                            {
                                id: 'b002',
                                title: 'Clean Code',
                                author: 'Robert C. Martin',
                                price: 250000,
                                stock: 0,
                                category: 'Công nghệ',
                                cover: 'https://images.unsplash.com/photo-1518770660439-4636190af475?w=800',
                                desc: 'Nguyên tắc viết code sạch',
                            },
                            {
                                id: 'b003',
                                title: 'Sapiens',
                                author: 'Yuval Noah Harari',
                                price: 180000,
                                stock: 0,
                                category: 'Lịch sử',
                                cover: 'https://images.unsplash.com/photo-1457369804613-52c61a468e7d?w=800',
                                desc: 'Lược sử loài người',
                            },
                        ]
                        saveProducts(sampleProducts)
                    }
                }

                // Load users từ users.json nếu chưa có
                if (getUsers().length === 0) {
                    try {
                        const res = await fetch('data/users.json')
                        const users = await res.json()
                        // Đảm bảo mỗi user có thuộc tính locked (boolean)
                        users.forEach((user) => {
                            if (
                                user.locked === undefined ||
                                user.locked === null
                            ) {
                                user.locked = false
                            } else {
                                // Chuyển đổi string/truthy thành boolean
                                user.locked =
                                    user.locked === true ||
                                    user.locked === 'true'
                            }
                        })
                        saveUsers(users)
                        console.log(
                            '✅ Đã load',
                            users.length,
                            'người dùng từ users.json'
                        )
                    } catch (e) {
                        console.warn(
                            '⚠️ Không load được users.json, bỏ qua (users sẽ được tạo khi đăng ký)'
                        )
                    }
                }

                // Load categories từ categories.json nếu chưa có
                if (getCategories().length === 0) {
                    try {
                        const res = await fetch('data/categories.json')
                        const categories = await res.json()
                        saveCategories(categories)
                        console.log(
                            '✅ Đã load',
                            categories.length,
                            'danh mục từ categories.json'
                        )
                    } catch (e) {
                        console.warn(
                            '⚠️ Không load được categories.json, bỏ qua (categories có thể được tạo thủ công)'
                        )
                    }
                }
            }

            /* ===== DASHBOARD ===== */
            function updateStats() {
                const products = getProducts()
                const orders = getOrders()
                const users = getUsers()

                document.getElementById('statProducts').textContent =
                    products.length

                const revenue = orders.reduce((s, o) => s + (o.total || 0), 0)
                document.getElementById('statRevenue').textContent =
                    revenue.toLocaleString('vi-VN') + ' ₫'

                document.getElementById('statOrders').textContent =
                    orders.length
                document.getElementById('statUsers').textContent = users.length

                // Đếm sản phẩm sắp hết (stock < 5)
                const lowStockProducts = products.filter(
                    (p) => (p.stock || 0) < 5 && (p.stock || 0) > 0
                )
                const outOfStockProducts = products.filter(
                    (p) => (p.stock || 0) === 0
                )
                const totalLowStock =
                    lowStockProducts.length + outOfStockProducts.length

                const lowStockCard = document.getElementById('lowStockCard')
                const statLowStock = document.getElementById('statLowStock')

                if (totalLowStock > 0) {
                    lowStockCard.style.display = 'flex'
                    statLowStock.textContent = totalLowStock
                    statLowStock.style.color =
                        outOfStockProducts.length > 0 ? '#dc2626' : '#f59e0b'
                } else {
                    lowStockCard.style.display = 'none'
                }
            }

            function renderRecentOrders() {
                const rows = document.getElementById('recentOrdersBody')
                const orders = getOrders().slice().reverse().slice(0, 5)

                if (orders.length === 0) {
                    rows.innerHTML =
                        '<tr><td colspan="5" class="empty" style="text-align:center;padding:40px">📭 Chưa có đơn hàng nào</td></tr>'
                    return
                }

                rows.innerHTML = orders
                    .map(
                        (o) => `
        <tr>
          <td><strong>${o.id}</strong></td>
          <td>${o.shippingAddress?.fullname || o.customer || 'N/A'}</td>
          <td>${o.date}</td>
          <td style="font-weight:700;color:var(--primary)">${o.total.toLocaleString(
              'vi-VN'
          )}₫</td>
          <td><span class="badge">${o.status}</span></td>
        </tr>
      `
                    )
                    .join('')
            }

            function renderTopProducts() {
                const el = document.getElementById('topProducts')
                const products = getProducts()

                if (products.length === 0) {
                    el.innerHTML =
                        '<div class="empty"><div style="font-size:50px">📚</div><div style="margin-top:12px">Chưa có sản phẩm nào</div></div>'
                    return
                }

                el.innerHTML =
                    '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:14px">' +
                    products
                        .slice(0, 4)
                        .map(
                            (p) => `
        <div style="background:#fff;border-radius:10px;padding:14px;display:flex;gap:12px;align-items:center;box-shadow:0 4px 12px rgba(9,40,58,0.04);border:1px solid #f0f4f6">
          <img src="${p.cover || p.image}" alt="${
                                p.title
                            }" style="width:50px;height:70px;object-fit:cover;border-radius:6px" onerror="this.src='https://via.placeholder.com/50x70?text=📖'">
          <div style="flex:1">
            <div style="font-weight:700;font-size:0.95rem;margin-bottom:4px">${
                p.title
            }</div>
            <div style="color:var(--muted);font-size:0.85rem;margin-bottom:6px">${
                p.author
            }</div>
            <div style="font-weight:700;color:var(--primary)">${(
                p.price || 0
            ).toLocaleString('vi-VN')} ₫</div>
          </div>
        </div>
      `
                        )
                        .join('') +
                    '</div>'
            }

            /* ===== PRODUCTS ===== */
            const PRODUCTS_PER_PAGE = 10
            let currentProductPage = 1

            function renderProductsList() {
                const q = (
                    document.getElementById('searchProd')?.value || ''
                ).toLowerCase()
                const allProducts = getProducts().filter(
                    (p) =>
                        p.title.toLowerCase().includes(q) ||
                        (p.author || '').toLowerCase().includes(q) ||
                        (p.category || '').toLowerCase().includes(q) ||
                        (p.id || '').toLowerCase().includes(q)
                )

                // Reset to page 1 when search changes
                if (document.getElementById('searchProd')?.value !== '') {
                    currentProductPage = 1
                }

                const totalPages = Math.ceil(
                    allProducts.length / PRODUCTS_PER_PAGE
                )
                const startIdx = (currentProductPage - 1) * PRODUCTS_PER_PAGE
                const products = allProducts.slice(
                    startIdx,
                    startIdx + PRODUCTS_PER_PAGE
                )

                const body = document.getElementById('productsBody')

                if (allProducts.length === 0) {
                    body.innerHTML =
                        '<tr><td colspan="7" class="empty" style="text-align:center;padding:40px">📭 Không tìm thấy sản phẩm</td></tr>'
                } else {
                    body.innerHTML = products
                        .map((p) => {
                            const stock = p.stock !== undefined ? p.stock : 0
                            const stockColor =
                                stock === 0
                                    ? 'color:#ef4444'
                                    : stock < 10
                                    ? 'color:#f59e0b'
                                    : 'color:#10b981'
                            return `
          <tr>
            <td><strong>${p.id}</strong></td>
            <td>${p.title}</td>
            <td>${p.author || ''}</td>
            <td style="font-weight:700;color:var(--primary)">${(
                p.price || 0
            ).toLocaleString('vi-VN')}₫</td>
            <td style="font-weight:700;${stockColor}">${stock}</td>
            <td>${p.category || ''}</td>
            <td>
              <button style="background:#3b82f6;color:white;margin-right:6px" onclick="editProduct('${
                  p.id
              }')">✏️ Sửa</button>
              <button style="background:#ef4444;color:white" onclick="removeProduct('${
                  p.id
              }')">🗑️ Xóa</button>
            </td>
          </tr>
        `
                        })
                        .join('')
                }

                // Render pagination
                const paginationDiv =
                    document.getElementById('productsPagination')
                if (totalPages <= 1) {
                    paginationDiv.innerHTML = ''
                } else {
                    let paginationHTML = ''

                    // Previous button
                    paginationHTML += `
                        <button onclick="gotoProductPage(${
                            currentProductPage - 1
                        })" 
                            ${
                                currentProductPage === 1
                                    ? 'disabled style="opacity:0.5;cursor:not-allowed"'
                                    : 'style="background:#3b82f6;color:white;padding:8px 12px;border:none;border-radius:6px;cursor:pointer"'
                            }>
                            ◀ Trước
                        </button>
                    `

                    // Page info
                    paginationHTML += `
                        <span style="color:#6b7280;font-weight:600;min-width:120px;text-align:center">
                            Trang ${currentProductPage} / ${totalPages}
                        </span>
                    `

                    // Next button
                    paginationHTML += `
                        <button onclick="gotoProductPage(${
                            currentProductPage + 1
                        })" 
                            ${
                                currentProductPage === totalPages
                                    ? 'disabled style="opacity:0.5;cursor:not-allowed"'
                                    : 'style="background:#3b82f6;color:white;padding:8px 12px;border:none;border-radius:6px;cursor:pointer"'
                            }>
                            Sau ▶
                        </button>
                    `

                    paginationDiv.innerHTML = paginationHTML
                }

                updateStats()
            }

            function gotoProductPage(page) {
                const q = (
                    document.getElementById('searchProd')?.value || ''
                ).toLowerCase()
                const allProducts = getProducts().filter(
                    (p) =>
                        p.title.toLowerCase().includes(q) ||
                        (p.author || '').toLowerCase().includes(q) ||
                        (p.category || '').toLowerCase().includes(q) ||
                        (p.id || '').toLowerCase().includes(q)
                )
                const totalPages = Math.ceil(
                    allProducts.length / PRODUCTS_PER_PAGE
                )

                if (page >= 1 && page <= totalPages) {
                    currentProductPage = page
                    renderProductsList()
                }
            }

            function saveProduct() {
                // Validation: Kiểm tra tất cả các trường bắt buộc
                const title = document
                    .getElementById('productTitle')
                    .value.trim()
                const author = document
                    .getElementById('productAuthor')
                    .value.trim()
                const price = document.getElementById('productPrice').value
                const stock = document.getElementById('productStock').value
                const category = document
                    .getElementById('productCategory')
                    .value.trim()
                const desc = document.getElementById('productDesc').value.trim()
                const imageFile =
                    document.getElementById('productImage').files[0]

                // Kiểm tra từng trường
                if (!title) {
                    alert('❌ Vui lòng nhập tiêu đề sản phẩm!')
                    document.getElementById('productTitle').focus()
                    return
                }

                if (!author) {
                    alert('❌ Vui lòng nhập tên tác giả!')
                    document.getElementById('productAuthor').focus()
                    return
                }

                if (!price || isNaN(parseInt(price)) || parseInt(price) <= 0) {
                    alert('❌ Vui lòng nhập giá sản phẩm hợp lệ (lớn hơn 0)!')
                    document.getElementById('productPrice').focus()
                    return
                }

                if (!category) {
                    alert('❌ Vui lòng nhập thể loại!')
                    document.getElementById('productCategory').focus()
                    return
                }

                if (!desc) {
                    alert('❌ Vui lòng nhập mô tả sản phẩm!')
                    document.getElementById('productDesc').focus()
                    return
                }

                // Kiểm tra ảnh
                const productId = document.getElementById('productId').value
                const isEditMode = !!productId

                let imageData = null
                if (imageFile) {
                    // Đọc file và convert sang base64
                    const reader = new FileReader()
                    reader.onload = function (e) {
                        imageData = e.target.result
                        saveProductWithImage(imageData)
                    }
                    reader.readAsDataURL(imageFile)
                    return // Đợi file được đọc xong
                } else {
                    // Nếu đang edit và không chọn file mới, giữ nguyên ảnh cũ
                    if (isEditMode) {
                        const existingProduct = getProducts().find(
                            (p) => p.id === productId
                        )
                        if (existingProduct) {
                            imageData =
                                existingProduct.cover || existingProduct.image
                        } else {
                            alert('❌ Không tìm thấy sản phẩm để chỉnh sửa!')
                            return
                        }
                    } else {
                        // Thêm mới thì bắt buộc phải có ảnh
                        alert('❌ Vui lòng chọn ảnh bìa!')
                        document.getElementById('productImage').focus()
                        return
                    }
                }

                saveProductWithImage(imageData)
            }

            function saveProductWithImage(imageData) {
                const id =
                    document.getElementById('productId').value ||
                    'b' + Date.now()
                const title = document
                    .getElementById('productTitle')
                    .value.trim()
                const author = document
                    .getElementById('productAuthor')
                    .value.trim()
                const price = parseInt(
                    document.getElementById('productPrice').value
                )
                const category = document
                    .getElementById('productCategory')
                    .value.trim()
                const desc = document.getElementById('productDesc').value.trim()

                let products = getProducts()
                const idx = products.findIndex((p) => p.id === id)

                let stock = 0
                if (idx >= 0) {
                    // Khi chỉnh sửa, giữ nguyên số lượng tồn kho hiện tại
                    stock =
                        products[idx].stock !== undefined
                            ? products[idx].stock
                            : 0
                } else {
                    // Khi thêm mới, luôn đặt số lượng tồn kho = 0
                    stock = 0
                }

                const product = {
                    id: id,
                    title: title,
                    author: author,
                    price: price,
                    stock: stock,
                    category: category,
                    cover:
                        imageData ||
                        'https://via.placeholder.com/100x150?text=📖',
                    image:
                        imageData ||
                        'https://via.placeholder.com/100x150?text=📖',
                    desc: desc,
                }

                if (idx >= 0) {
                    products[idx] = product
                    alert('✅ Cập nhật sản phẩm thành công!')
                } else {
                    products.push(product)
                    alert('✅ Thêm sản phẩm thành công!')
                }

                saveProducts(products)
                clearProductForm()

                // Auto reload
                renderProductsList()
                renderTopProducts()
                updateStats()
            }

            function previewProductImage(input) {
                if (input.files && input.files[0]) {
                    const reader = new FileReader()
                    reader.onload = function (e) {
                        const preview = document.getElementById(
                            'productImagePreview'
                        )
                        const previewImg = document.getElementById(
                            'productImagePreviewImg'
                        )
                        previewImg.src = e.target.result
                        preview.style.display = 'block'
                    }
                    reader.readAsDataURL(input.files[0])
                } else {
                    document.getElementById(
                        'productImagePreview'
                    ).style.display = 'none'
                }
            }

            function clearProductForm() {
                document.getElementById('productForm').reset()
                document.getElementById('productId').value = ''
                document.getElementById('productStock').value = '0'
                document.getElementById('productImagePreview').style.display =
                    'none'
            }

            function editProduct(id) {
                const p = getProducts().find((x) => x.id === id)
                if (!p) return

                document.getElementById('productId').value = p.id
                document.getElementById('productTitle').value = p.title
                document.getElementById('productAuthor').value = p.author || ''
                document.getElementById('productPrice').value = p.price || 0
                // Số lượng tồn kho không được chỉnh sửa, giữ nguyên giá trị hiện tại
                const currentStock = p.stock !== undefined ? p.stock : 0
                document.getElementById('productStock').value = currentStock
                document.getElementById('productCategory').value =
                    p.category || ''
                document.getElementById('productDesc').value = p.desc || ''

                // Hiển thị preview ảnh cũ nếu có
                const imageUrl = p.cover || p.image || ''
                if (imageUrl) {
                    const preview = document.getElementById(
                        'productImagePreview'
                    )
                    const previewImg = document.getElementById(
                        'productImagePreviewImg'
                    )
                    previewImg.src = imageUrl
                    preview.style.display = 'block'
                } else {
                    document.getElementById(
                        'productImagePreview'
                    ).style.display = 'none'
                }

                // Reset file input (không thể set value cho file input)
                document.getElementById('productImage').value = ''

                document
                    .getElementById('productForm')
                    .scrollIntoView({ behavior: 'smooth' })
            }

            function removeProduct(id) {
                if (!confirm('❓ Bạn có chắc muốn xóa sản phẩm này?')) return

                const products = getProducts().filter((p) => p.id !== id)
                saveProducts(products)

                // Auto reload
                renderProductsList()
                renderTopProducts()
                updateStats()

                alert('✅ Đã xóa sản phẩm!')
            }

            /* ===== ORDERS ===== */
            function renderOrdersList() {
                const q = (
                    document.getElementById('searchOrder')?.value || ''
                ).toLowerCase()
                const body = document.getElementById('ordersBody')
                const orders = getOrders().filter(
                    (o) =>
                        o.id.toLowerCase().includes(q) ||
                        (o.shippingAddress?.fullname || o.customer || '')
                            .toLowerCase()
                            .includes(q)
                )

                if (orders.length === 0) {
                    body.innerHTML =
                        '<tr><td colspan="7" class="empty" style="text-align:center;padding:40px">📭 Không có đơn hàng</td></tr>'
                } else {
                    body.innerHTML = orders
                        .map((o) => {
                            let actionButtons = ''

                            if (o.status === 'Đã giao') {
                                // Đơn hàng đã hoàn thành - chỉ hiển thị nút Xem
                                actionButtons = `<button style="background:#3b82f6;color:white;padding:6px 12px" onclick="viewOrder('${o.id}')">👁️ Xem</button>
                             <span style="color:#10b981;font-weight:bold">✅ Hoàn thành</span>`
                            } else if (o.status === 'Đã hủy') {
                                // Đơn hàng đã hủy - chỉ hiển thị nút Xem
                                actionButtons = `<button style="background:#3b82f6;color:white;padding:6px 12px" onclick="viewOrder('${o.id}')">👁️ Xem</button>
                             <span style="color:#ef4444;font-weight:bold">❌ Đã hủy</span>`
                            } else {
                                // Đơn hàng chưa hoàn thành - hiển thị tất cả nút
                                actionButtons = `<button style="background:#3b82f6;color:white;padding:6px 12px;margin-right:4px" onclick="viewOrder('${o.id}')">👁️ Xem</button>
                             <button style="background:#ff9800;color:white;padding:6px 12px;margin-right:4px" onclick="processOrder('${o.id}')">⚙️ Xử lý</button>
                             <button style="background:#ef4444;color:white;padding:6px 12px" onclick="cancelOrderFromAdmin('${o.id}')">❌ Hủy</button>`
                            }

                            return `
            <tr>
              <td><strong>${o.id}</strong></td>
              <td>${o.shippingAddress?.fullname || o.customer || 'N/A'}</td>
              <td>${o.date}</td>
              <td style="font-weight:700;color:var(--primary)">${(
                  o.total || 0
              ).toLocaleString('vi-VN')}₫</td>
              <td><span class="badge">${o.status}</span></td>
              <td>${actionButtons}</td>
            </tr>
          `
                        })
                        .join('')
                }
            }

            function viewOrder(id) {
                const o = getOrders().find((x) => x.id === id)
                if (!o) return alert('❌ Không tìm thấy đơn hàng!')

                const customerName =
                    o.shippingAddress?.fullname || o.customer || 'N/A'
                const phone = o.shippingAddress?.phone || 'N/A'
                const address = o.shippingAddress
                    ? `${o.shippingAddress.street}, ${o.shippingAddress.district}, ${o.shippingAddress.city}`
                    : 'N/A'
                const items = o.items
                    ? o.items
                          .map(
                              (i) =>
                                  `  • ${i.title} x${i.quantity} = ${(
                                      i.price * i.quantity
                                  ).toLocaleString('vi-VN')}₫`
                          )
                          .join('\n')
                    : '  Không có sản phẩm'

                alert(`📦 CHI TIẾT ĐƠN HÀNG

🆔 Mã đơn: ${o.id}
📅 Ngày đặt: ${o.date}
💰 Tổng tiền: ${(o.total || 0).toLocaleString('vi-VN')}₫
📊 Trạng thái: ${o.status}

👤 THÔNG TIN KHÁCH HÀNG:
  Họ tên: ${customerName}
  SĐT: ${phone}
  Địa chỉ: ${address}

📦 SẢN PHẨM:
${items}`)
            }

            function processOrder(id) {
                const orders = getOrders()
                const o = orders.find((x) => x.id === id)
                if (!o) return alert('❌ Không tìm thấy đơn hàng!')

                // Không cho cập nhật khi đã hoàn thành
                if (o.status === 'Đã giao') {
                    return alert(
                        '⚠️ Đơn hàng đã hoàn thành! Không thể cập nhật trạng thái.'
                    )
                }

                if (o.status === 'Đã hủy') {
                    return alert(
                        '⚠️ Đơn hàng đã bị hủy! Không thể cập nhật trạng thái.'
                    )
                }

                const statuses = [
                    'Chưa xử lý',
                    'Đang xử lý',
                    'Đã gửi',
                    'Đã giao',
                ]
                const currentIdx = statuses.indexOf(o.status)
                const nextIdx = (currentIdx + 1) % statuses.length
                const nextStatus = statuses[nextIdx]

                if (
                    !confirm(
                        `📦 Chuyển trạng thái từ "${o.status}" → "${nextStatus}"?\n\nNếu là "Đang xử lý" sẽ tự trừ số lượng sản phẩm!`
                    )
                ) {
                    return
                }

                // Nếu chuyển sang "Đang xử lý" thì trừ số lượng sản phẩm (chỉ lần đầu)
                if (nextStatus === 'Đang xử lý' && o.status === 'Chưa xử lý') {
                    const products = getProducts()
                    let hasError = false
                    const itemsDetail = []

                    console.log('🔍 DEBUG: Bắt đầu xử lý đơn', id)
                    console.log(
                        '📦 DEBUG: Số lượng sản phẩm trong kho:',
                        products.length
                    )
                    console.log('📦 DEBUG: Items trong đơn:', o.items)

                    o.items.forEach((item) => {
                        console.log(`🔎 Tìm sản phẩm với ID: ${item.id}`)
                        const product = products.find((p) => p.id === item.id)
                        console.log(`✓ Tìm thấy:`, product)

                        if (product) {
                            if (product.stock === undefined) product.stock = 0
                            console.log(
                                `📊 Stock hiện tại: ${product.stock}, cần trừ: ${item.quantity}`
                            )

                            if (product.stock < item.quantity) {
                                alert(
                                    `❌ Sản phẩm "${item.title}" không đủ kho!\nCó: ${product.stock}, cần: ${item.quantity}`
                                )
                                hasError = true
                                return
                            }
                            const oldStock = product.stock
                            product.stock -= item.quantity
                            console.log(
                                `✅ Đã trừ: ${oldStock} → ${product.stock}`
                            )
                            itemsDetail.push(
                                `  ✓ ${item.title}: -${item.quantity} (${oldStock} → ${product.stock})`
                            )
                        } else {
                            console.log(
                                `❌ KHÔNG TÌM THẤY sản phẩm ID ${item.id}`
                            )
                            alert(`❌ Sản phẩm ID ${item.id} không tồn tại!`)
                            hasError = true
                        }
                    })

                    if (hasError) return

                    // Lưu lại số lượng sản phẩm
                    console.log('💾 Lưu products vào localStorage:', products)
                    saveProducts(products)

                    alert(
                        `✅ Chuyển trạng thái thành công!\n📦 Đã trừ khỏi kho:\n${itemsDetail.join(
                            '\n'
                        )}`
                    )
                } else if (
                    nextStatus === 'Đang xử lý' &&
                    o.status !== 'Chưa xử lý'
                ) {
                    alert(
                        '⚠️ Đơn hàng đã được xử lý rồi! Không thể trừ kho lần nữa.'
                    )
                } else {
                    alert(`✅ Trạng thái cập nhật: ${nextStatus}`)
                }

                // Cập nhật trạng thái đơn hàng
                o.status = nextStatus
                saveOrders(orders)
                console.log('✅ Đã cập nhật trạng thái đơn hàng')
                renderOrdersList()
            }

            function cancelOrderFromAdmin(id) {
                const orders = getOrders()
                const o = orders.find((x) => x.id === id)
                if (!o) return alert('❌ Không tìm thấy đơn hàng!')

                if (o.status === 'Đã hủy') {
                    return alert('⚠️ Đơn hàng này đã bị hủy rồi!')
                }

                if (o.status === 'Đã giao') {
                    return alert('⚠️ Đơn hàng đã hoàn thành! Không thể hủy.')
                }

                if (
                    !confirm(
                        `⚠️ Bạn chắc chắn muốn hủy đơn hàng ${id}?\n\n✅ Lưu ý: Số lượng sản phẩm sẽ KHÔNG bị trừ!`
                    )
                ) {
                    return
                }

                o.status = 'Đã hủy'
                saveOrders(orders)
                renderOrdersList()
                alert(
                    `❌ Đơn hàng ${id} đã được hủy.\n✅ Số lượng sản phẩm không bị trừ khỏi kho.`
                )
            }

            /* ===== USERS ===== */
            function renderUsersList() {
                const body = document.getElementById('usersBody')
                const users = getUsers()

                if (users.length === 0) {
                    body.innerHTML =
                        '<tr><td colspan="3" class="empty" style="text-align:center;padding:40px">👤 Chưa có người dùng nào</td></tr>'
                } else {
                    body.innerHTML = users
                        .map((u) => {
                            // Xử lý locked: chuyển đổi thành boolean để đảm bảo tính nhất quán
                            const isLocked =
                                u.locked === true || u.locked === 'true'
                            const identifier = u.email || u.username || 'N/A'
                            // Escape identifier để tránh lỗi khi có ký tự đặc biệt
                            const safeIdentifier = identifier.replace(
                                /'/g,
                                "\\'"
                            )

                            return `
          <tr>
            <td><strong>${identifier}</strong></td>
            <td>
              <span class="badge" style="background:${
                  isLocked ? '#fee2e2' : '#d1fae5'
              };color:${isLocked ? '#991b1b' : '#065f46'}">
                ${isLocked ? '🔒 Đã khóa' : '✅ Hoạt động'}
              </span>
            </td>
            <td>
              <button style="background:${
                  isLocked ? '#10b981' : '#f59e0b'
              };color:white;margin-right:6px" onclick="toggleLock('${safeIdentifier}')">
                ${isLocked ? '🔓 Mở khóa' : '🔒 Khóa'}
              </button>
              <button style="background:#ef4444;color:white" onclick="deleteUser('${safeIdentifier}')">🗑️ Xóa</button>
            </td>
          </tr>
        `
                        })
                        .join('')
                }
                updateStats()
            }

            function toggleLock(identifier) {
                const users = getUsers()
                const u = users.find(
                    (x) => x.email === identifier || x.username === identifier
                )
                if (!u) return alert('❌ Không tìm thấy người dùng!')

                // Đảm bảo locked là boolean và toggle giá trị
                // Xử lý các trường hợp: undefined, null, string 'true'/'false', boolean
                const currentLocked = u.locked === true || u.locked === 'true'
                u.locked = !currentLocked // Toggle: true -> false, false -> true

                console.log(
                    '✅ Toggling lock for:',
                    identifier,
                    'Old:',
                    currentLocked,
                    'New:',
                    u.locked
                )
                saveUsers(users)
                renderUsersList()
                alert(
                    u.locked
                        ? '🔒 Đã khóa tài khoản!'
                        : '🔓 Đã mở khóa tài khoản!'
                )
            }

            function deleteUser(identifier) {
                if (!confirm('❓ Bạn có chắc muốn xóa người dùng này?')) return

                const users = getUsers().filter(
                    (u) => u.email !== identifier && u.username !== identifier
                )
                saveUsers(users)
                renderUsersList()
                alert('✅ Đã xóa người dùng!')
            }

            /* ===== TAB SWITCHING ===== */
            function switchTab(name, el) {
                document
                    .querySelectorAll('.tab')
                    .forEach((t) => (t.style.display = 'none'))
                document.getElementById(name).style.display = 'block'

                document
                    .querySelectorAll('.nav-item')
                    .forEach((n) => n.classList.remove('active'))
                if (el) el.classList.add('active')

                // Render on demand
                if (name === 'dashboard') {
                    renderRecentOrders()
                    renderTopProducts()
                    updateStats()
                }
                if (name === 'products') {
                    renderProductsList()
                }
                if (name === 'orders') {
                    renderOrdersList()
                }
                if (name === 'users') {
                    renderUsersList()
                }
                if (name === 'pricing') {
                    renderPricingList()
                }
                if (name === 'import') {
                    renderImportList()
                    loadProductsToSelect()
                    currentImportItems = []
                    renderImportItems()
                }
                if (name === 'inventory') {
                    renderInventoryList()
                    loadInventoryCategories()
                }

                window.scrollTo({ top: 0, behavior: 'smooth' })
            }

            /* ===== PRICING MANAGEMENT (Theo Sản Phẩm) ===== */
            let editingPricingProductId = null

            // Khởi tạo giá trị mặc định cho sản phẩm
            function initializeProductPricing() {
                let products = getProducts()
                let hasChanges = false

                products.forEach((product) => {
                    if (!product.costPrice) {
                        product.costPrice = product.price // Giá vốn = giá gốc
                        hasChanges = true
                    }
                    if (product.profitPercent === undefined) {
                        product.profitPercent = 30 // Mặc định 30% lợi nhuận
                        hasChanges = true
                    }
                    if (!product.sellPrice) {
                        product.sellPrice = Math.round(
                            product.costPrice *
                                (1 + product.profitPercent / 100)
                        )
                        hasChanges = true
                    }
                })

                if (hasChanges) {
                    saveProducts(products)
                }
            }

            // Render thống kê giá
            function renderPricingStats() {
                const products = getProducts()
                const totalProducts = products.length

                const avgProfit =
                    products.length > 0
                        ? (
                              products.reduce(
                                  (sum, p) => sum + (p.profitPercent || 0),
                                  0
                              ) / products.length
                          ).toFixed(1)
                        : 0

                const totalProfitAmount = products.reduce((sum, p) => {
                    const profit = (p.sellPrice || 0) - (p.costPrice || 0)
                    return sum + profit
                }, 0)

                const avgProfitAmount =
                    totalProducts > 0
                        ? Math.round(totalProfitAmount / totalProducts)
                        : 0
                const highProfitCount = products.filter(
                    (p) => (p.profitPercent || 0) > 40
                ).length

                document.getElementById('avgProfit').textContent =
                    avgProfit + '%'
                document.getElementById('avgProfitAmount').textContent =
                    avgProfitAmount.toLocaleString('vi-VN') + ' ₫'
                document.getElementById('highProfitCount').textContent =
                    highProfitCount
            }

            // Load categories vào filter
            function loadPricingCategories() {
                const products = getProducts()
                const categories = [
                    ...new Set(products.map((p) => p.category).filter(Boolean)),
                ]
                const selectFilter = document.getElementById(
                    'categoryFilterPricing'
                )
                const selectBulk = document.getElementById('bulkUpdateCategory')

                // Load vào select filter
                if (selectFilter) {
                    while (selectFilter.options.length > 1) {
                        selectFilter.remove(1)
                    }
                    categories.forEach((cat) => {
                        const option = document.createElement('option')
                        option.value = cat
                        option.textContent = cat
                        selectFilter.appendChild(option)
                    })
                }

                // Load vào select bulk update
                if (selectBulk) {
                    while (selectBulk.options.length > 1) {
                        selectBulk.remove(1)
                    }
                    categories.forEach((cat) => {
                        const option = document.createElement('option')
                        option.value = cat
                        option.textContent = cat
                        selectBulk.appendChild(option)
                    })
                }
            }

            // Cập nhật tỷ lệ lợi nhuận hàng loạt theo thể loại
            function bulkUpdateProfitByCategory() {
                const category =
                    document.getElementById('bulkUpdateCategory').value
                const profitPercent = parseFloat(
                    document.getElementById('bulkUpdateProfit').value
                )

                // Validation
                if (!category) {
                    alert('❌ Vui lòng chọn thể loại!')
                    return
                }

                if (isNaN(profitPercent) || profitPercent < 0) {
                    alert('❌ Vui lòng nhập tỷ lệ lợi nhuận hợp lệ (>= 0)!')
                    return
                }

                const products = getProducts()
                const productsInCategory = products.filter(
                    (p) => p.category === category
                )

                if (productsInCategory.length === 0) {
                    alert(
                        `❌ Không tìm thấy sản phẩm nào thuộc thể loại "${category}"!`
                    )
                    return
                }

                if (
                    !confirm(
                        `⚠️ Bạn có chắc muốn cập nhật tỷ lệ lợi nhuận ${profitPercent}% cho TẤT CẢ ${productsInCategory.length} sản phẩm thuộc thể loại "${category}"?\n\nGiá bán sẽ được tính lại tự động.`
                    )
                ) {
                    return
                }

                let updatedCount = 0
                products.forEach((product) => {
                    if (product.category === category) {
                        // Cập nhật tỷ lệ lợi nhuận
                        product.profitPercent = profitPercent

                        // Tính lại giá bán
                        const costPrice =
                            product.costPrice || product.price || 0
                        product.sellPrice = Math.round(
                            costPrice * (1 + profitPercent / 100)
                        )
                        product.price = product.sellPrice // Cập nhật giá hiển thị

                        updatedCount++
                    }
                })

                saveProducts(products)

                // Render lại
                renderPricingStats()
                renderPricingTable()

                alert(
                    `✅ Đã cập nhật tỷ lệ lợi nhuận ${profitPercent}% cho ${updatedCount} sản phẩm thuộc thể loại "${category}"!\n\nGiá bán đã được tính lại tự động.`
                )

                // Clear form
                document.getElementById('bulkUpdateCategory').value = ''
                document.getElementById('bulkUpdateProfit').value = ''
            }

            // Lọc sản phẩm cho pricing
            function getFilteredPricingProducts() {
                const products = getProducts()
                const searchTerm = (
                    document.getElementById('searchPricing')?.value || ''
                ).toLowerCase()
                const categoryFilter =
                    document.getElementById('categoryFilterPricing')?.value ||
                    ''
                const profitMin = parseFloat(
                    document.getElementById('profitFilterMin')?.value || ''
                )
                const profitMax = parseFloat(
                    document.getElementById('profitFilterMax')?.value || ''
                )

                return products.filter((product) => {
                    const matchSearch =
                        product.title.toLowerCase().includes(searchTerm) ||
                        product.id.toLowerCase().includes(searchTerm)
                    const matchCategory =
                        !categoryFilter || product.category === categoryFilter

                    // Lọc theo khoảng lợi nhuận tùy ý
                    let matchProfit = true
                    const profitPercent = product.profitPercent || 0

                    if (!isNaN(profitMin) && profitPercent < profitMin) {
                        matchProfit = false
                    }
                    if (!isNaN(profitMax) && profitPercent > profitMax) {
                        matchProfit = false
                    }

                    return matchSearch && matchCategory && matchProfit
                })
            }

            // Render bảng pricing
            function renderPricingTable() {
                const filteredProducts = getFilteredPricingProducts()
                const tbody = document.getElementById('pricingTableBody')

                if (filteredProducts.length === 0) {
                    tbody.innerHTML =
                        '<tr><td colspan="8" style="text-align:center;padding:40px;color:#666">📭 Không tìm thấy sản phẩm nào</td></tr>'
                    return
                }

                tbody.innerHTML = filteredProducts
                    .map((product) => {
                        const costPrice =
                            product.costPrice || product.price || 0
                        const profitPercent = product.profitPercent || 0
                        const sellPrice = product.sellPrice || costPrice
                        const profitAmount = sellPrice - costPrice

                        const profitBadgeColor =
                            profitPercent > 40
                                ? 'background:#fef3c7;color:#92400e'
                                : 'background:#d1fae5;color:#065f46'

                        if (editingPricingProductId === product.id) {
                            return `
                <tr style="background:#f8f9ff">
                    <td><strong>${product.id}</strong></td>
                    <td>${product.title}</td>
                    <td>${product.category || 'N/A'}</td>
                    <td>
                        <input type="number" id="cost-${
                            product.id
                        }" value="${costPrice}" min="0" 
                            style="width:100px;padding:6px;border:1px solid #667eea;border-radius:4px">
                    </td>
                    <td>
                        <div style="display:flex;align-items:center;gap:4px">
                            <input type="number" id="profit-${
                                product.id
                            }" value="${profitPercent}" min="0" max="1000" 
                                style="width:70px;padding:6px;border:1px solid #667eea;border-radius:4px"> %
                        </div>
                    </td>
                    <td><strong style="color:#667eea;font-size:15px">${sellPrice.toLocaleString(
                        'vi-VN'
                    )}₫</strong></td>
                    <td><strong style="color:#10b981">+${profitAmount.toLocaleString(
                        'vi-VN'
                    )}₫</strong></td>
                    <td>
                        <button onclick="savePricingProduct('${product.id}')" 
                            style="background:#10b981;color:white;padding:6px 12px;border:none;border-radius:6px;cursor:pointer;margin-right:4px">
                            💾 Lưu
                        </button>
                        <button onclick="cancelPricingEdit()" 
                            style="background:#6b7280;color:white;padding:6px 12px;border:none;border-radius:6px;cursor:pointer">
                            ❌
                        </button>
                    </td>
                </tr>
            `
                        } else {
                            return `
                <tr>
                    <td><strong>${product.id}</strong></td>
                    <td>${product.title}</td>
                    <td>${product.category || 'N/A'}</td>
                    <td><strong>${costPrice.toLocaleString(
                        'vi-VN'
                    )}₫</strong></td>
                    <td>
                        <span style="display:inline-block;padding:4px 12px;border-radius:12px;font-weight:600;font-size:13px;${profitBadgeColor}">
                            ${profitPercent}%
                        </span>
                    </td>
                    <td><strong style="color:#667eea;font-size:15px">${sellPrice.toLocaleString(
                        'vi-VN'
                    )}₫</strong></td>
                    <td><strong style="color:#10b981">+${profitAmount.toLocaleString(
                        'vi-VN'
                    )}₫</strong></td>
                    <td>
                        <button onclick="editPricingProduct('${product.id}')" 
                            style="background:#3b82f6;color:white;padding:6px 12px;border:none;border-radius:6px;cursor:pointer">
                            ✏️ Sửa giá
                        </button>
                    </td>
                </tr>
            `
                        }
                    })
                    .join('')
            }

            // Chỉnh sửa giá sản phẩm
            function editPricingProduct(productId) {
                editingPricingProductId = productId
                renderPricingTable()
            }

            // Lưu giá sản phẩm
            function savePricingProduct(productId) {
                const costInput = document.getElementById(`cost-${productId}`)
                const profitInput = document.getElementById(
                    `profit-${productId}`
                )

                if (!costInput || !profitInput) return

                const costPrice = parseFloat(costInput.value) || 0
                const profitPercent = parseFloat(profitInput.value) || 0
                const sellPrice = Math.round(
                    costPrice * (1 + profitPercent / 100)
                )

                let products = getProducts()
                const product = products.find((p) => p.id === productId)

                if (product) {
                    product.costPrice = costPrice
                    product.profitPercent = profitPercent
                    product.sellPrice = sellPrice
                    product.price = sellPrice // Cập nhật giá hiển thị trên trang chính

                    saveProducts(products)
                    editingPricingProductId = null

                    renderPricingStats()
                    renderPricingTable()

                    alert('✅ Đã cập nhật giá thành công!')
                }
            }

            // Hủy chỉnh sửa
            function cancelPricingEdit() {
                editingPricingProductId = null
                renderPricingTable()
            }

            // Hàm render pricing list chính (được gọi từ switchTab)
            function renderPricingList() {
                initializeProductPricing()
                loadPricingCategories()
                renderPricingStats()
                renderPricingTable()
            }

            /* ===== CHUYỂN TỪ TAB SẢN PHẨM SANG PRICING ===== */
            function goToPricing(productId) {
                // Chuyển sang tab pricing
                switchTab(
                    'pricing',
                    document.querySelector('[data-tab="pricing"]')
                )

                // Đợi một chút để tab được render
                setTimeout(() => {
                    // Tìm sản phẩm và tự động mở chế độ chỉnh sửa
                    const product = getProducts().find(
                        (p) => p.id === productId
                    )
                    if (product) {
                        // Clear filter để hiển thị sản phẩm
                        document.getElementById('searchPricing').value = ''
                        document.getElementById('categoryFilterPricing').value =
                            ''
                        document.getElementById('profitFilterMin').value = ''
                        document.getElementById('profitFilterMax').value = ''

                        // Render lại bảng
                        renderPricingTable()

                        // Tự động mở chế độ chỉnh sửa
                        editingPricingProductId = productId
                        renderPricingTable()

                        // Scroll đến sản phẩm đó
                        setTimeout(() => {
                            const row = document.querySelector(
                                `#pricingTableBody tr[style*="background:#f8f9ff"]`
                            )
                            if (row) {
                                row.scrollIntoView({
                                    behavior: 'smooth',
                                    block: 'center',
                                })
                                // Highlight effect
                                row.style.boxShadow =
                                    '0 0 20px rgba(102, 126, 234, 0.5)'
                                setTimeout(() => {
                                    row.style.boxShadow = 'none'
                                }, 2000)
                            }
                        }, 100)

                        // Hiển thị thông báo
                        const notification = document.createElement('div')
                        notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 10000;
                font-weight: 600;
                animation: slideIn 0.3s ease;
            `
                        notification.innerHTML = `
                💲 Đang chỉnh sửa giá: <strong>${product.title}</strong>
            `
                        document.body.appendChild(notification)

                        // Tự động xóa notification sau 3 giây
                        setTimeout(() => {
                            notification.style.animation = 'slideOut 0.3s ease'
                            setTimeout(() => notification.remove(), 300)
                        }, 3000)
                    }
                }, 100)
            }

            // Thêm CSS animation cho notification
            const styleAnimation = document.createElement('style')
            styleAnimation.textContent = `
    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(400px);
            opacity: 0;
        }
    }
`
            document.head.appendChild(styleAnimation)

            /* ===== IMPORT RECEIPTS MANAGEMENT ===== */
            const getImportReceipts = () =>
                JSON.parse(localStorage.getItem('bs_import_receipts') || '[]')
            const setImportReceipts = (r) =>
                localStorage.setItem('bs_import_receipts', JSON.stringify(r))

            // Biến lưu danh sách sản phẩm tạm thời trong form
            let currentImportItems = []

            function renderImportItems() {
                const container = document.getElementById(
                    'importItemsContainer'
                )
                if (!container) return

                if (currentImportItems.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--muted);">
                            Chưa có sản phẩm nào trong phiếu
                        </div>
                    `
                    return
                }

                const products = getProducts()
                let totalQuantity = 0
                let totalAmount = 0

                container.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f3f4f6; border-bottom: 2px solid #e5e7eb;">
                                <th style="padding: 10px; text-align: left;">Sản phẩm</th>
                                <th style="padding: 10px; text-align: center;">Số lượng</th>
                                <th style="padding: 10px; text-align: right;">Giá nhập</th>
                                <th style="padding: 10px; text-align: right;">Thành tiền</th>
                                <th style="padding: 10px; text-align: center;">Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${currentImportItems
                                .map((item, index) => {
                                    const product = products.find(
                                        (p) => p.id === item.productId
                                    )
                                    const productName = product
                                        ? product.title
                                        : item.productId
                                    const itemTotal = item.quantity * item.price
                                    totalQuantity += item.quantity
                                    totalAmount += itemTotal
                                    return `
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 10px;">${productName} (${
                                        item.productId
                                    })</td>
                                        <td style="padding: 10px; text-align: center;">${
                                            item.quantity
                                        }</td>
                                        <td style="padding: 10px; text-align: right;">${item.price.toLocaleString(
                                            'vi-VN'
                                        )} ₫</td>
                                        <td style="padding: 10px; text-align: right; font-weight: 600;">${itemTotal.toLocaleString(
                                            'vi-VN'
                                        )} ₫</td>
                                        <td style="padding: 10px; text-align: center;">
                                            <button onclick="removeImportItem(${index})" style="background:#ef4444;color:white;padding:4px 8px;border:none;border-radius:4px;cursor:pointer;">🗑️</button>
                                        </td>
                                    </tr>
                                `
                                })
                                .join('')}
                            <tr style="background: #f9fafb; font-weight: 700; border-top: 2px solid #e5e7eb;">
                                <td style="padding: 10px;" colspan="2">TỔNG CỘNG</td>
                                <td style="padding: 10px; text-align: center;">${totalQuantity}</td>
                                <td style="padding: 10px; text-align: right; color: var(--primary); font-size: 16px;">${totalAmount.toLocaleString(
                                    'vi-VN'
                                )} ₫</td>
                                <td style="padding: 10px;"></td>
                            </tr>
                        </tbody>
                    </table>
                `
            }

            function addProductToReceipt() {
                const productId = document
                    .getElementById('importProductId')
                    .value.trim()
                const quantity = parseInt(
                    document.getElementById('importQuantity').value
                )
                const price = parseInt(
                    document.getElementById('importPrice').value
                )

                if (!productId || !quantity || !price) {
                    alert('❌ Vui lòng điền đầy đủ thông tin sản phẩm!')
                    return
                }

                if (quantity <= 0) {
                    alert('❌ Số lượng phải lớn hơn 0!')
                    return
                }

                if (price < 0) {
                    alert('❌ Giá nhập không được âm!')
                    return
                }

                // Kiểm tra sản phẩm có tồn tại không
                const products = getProducts()
                const product = products.find((p) => p.id === productId)

                if (!product) {
                    alert(
                        `❌ KHÔNG TÌM THẤY SẢN PHẨM!\n\n` +
                            `ID bạn nhập: "${productId}"\n\n` +
                            `Vui lòng kiểm tra lại ID sản phẩm!`
                    )
                    return
                }

                // Kiểm tra sản phẩm đã có trong danh sách chưa
                const existingIndex = currentImportItems.findIndex(
                    (item) => item.productId === productId
                )
                if (existingIndex >= 0) {
                    if (
                        confirm(
                            `Sản phẩm "${product.title}" đã có trong phiếu. Bạn có muốn cập nhật số lượng và giá không?`
                        )
                    ) {
                        currentImportItems[existingIndex].quantity = quantity
                        currentImportItems[existingIndex].price = price
                    } else {
                        return
                    }
                } else {
                    // Thêm sản phẩm mới vào danh sách
                    currentImportItems.push({
                        productId: productId,
                        quantity: quantity,
                        price: price,
                    })
                }

                // Xóa form nhập
                document.getElementById('importProductId').value = ''
                document.getElementById('importQuantity').value = ''
                document.getElementById('importPrice').value = ''
                document.getElementById('importProductSelect').value = ''

                // Render lại danh sách
                renderImportItems()
            }

            function removeImportItem(index) {
                if (confirm('Bạn có chắc muốn xóa sản phẩm này khỏi phiếu?')) {
                    currentImportItems.splice(index, 1)
                    renderImportItems()
                }
            }

            function renderImportList() {
                const receipts = getImportReceipts()
                const tbody = document.querySelector('#importBody')

                if (!receipts.length) {
                    tbody.innerHTML =
                        '<tr><td colspan="6" style="text-align:center;color:#666">Chưa có phiếu nhập</td></tr>'
                    return
                }

                tbody.innerHTML = receipts
                    .map((r) => {
                        // Hỗ trợ cả format cũ (1 sản phẩm) và format mới (nhiều sản phẩm)
                        const items = r.items || [
                            {
                                productId: r.productId,
                                quantity: r.quantity,
                                price: r.price,
                            },
                        ]

                        const products = getProducts()
                        let totalQuantity = 0
                        let totalAmount = 0
                        const itemsList = items
                            .map((item) => {
                                const product = products.find(
                                    (p) => p.id === item.productId
                                )
                                const productName = product
                                    ? product.title
                                    : item.productId
                                const itemTotal = item.quantity * item.price
                                totalQuantity += item.quantity
                                totalAmount += itemTotal
                                return `${productName} (${item.productId}) x${item.quantity}`
                            })
                            .join('<br>')

                        return `
                        <tr>
                            <td>${r.date}</td>
                            <td style="max-width: 300px;">
                                <div style="font-size: 0.9rem;">${itemsList}</div>
                            </td>
                            <td style="text-align: center; font-weight: 600;">${totalQuantity}</td>
                            <td style="text-align: right; font-weight: 600; color: var(--primary);">${totalAmount.toLocaleString(
                                'vi-VN'
                            )} ₫</td>
                            <td>
                                <span class="badge" style="background:${
                                    r.status === 'Chưa vào kho'
                                        ? '#fff3e0'
                                        : '#e8f5e9'
                                };color:${
                            r.status === 'Chưa vào kho' ? '#a65a00' : '#2e7d32'
                        }">
                                    ${
                                        r.status === 'Chưa vào kho'
                                            ? '⏳ Chưa vào kho'
                                            : '✅ Đã nhập kho'
                                    }
                                </span>
                            </td>
                            <td>
                                ${
                                    r.status === 'Chưa vào kho'
                                        ? `<button onclick="editImport('${r.id}')" style="background:#3b82f6;color:white;padding:6px 12px;margin-right:6px;border:none;border-radius:4px;cursor:pointer;">✏️</button>
                                           <button onclick="completeImport('${r.id}')" style="background:#4CAF50;color:white;padding:6px 12px;margin-right:6px;border:none;border-radius:4px;cursor:pointer;">✅</button>`
                                        : ''
                                }
                                <button onclick="deleteImport('${
                                    r.id
                                }')" style="background:#ff6b6b;color:white;padding:6px 12px;border:none;border-radius:4px;cursor:pointer;">🗑️</button>
                            </td>
                        </tr>
                    `
                    })
                    .join('')
            }

            function saveImportReceipt() {
                const date = document.getElementById('importDate').value
                const id = document.getElementById('importId').value

                // ✅ VALIDATION
                if (!date) {
                    alert('❌ Vui lòng chọn ngày nhập!')
                    return
                }

                if (currentImportItems.length === 0) {
                    alert(
                        '❌ Vui lòng thêm ít nhất một sản phẩm vào phiếu nhập!'
                    )
                    return
                }

                const receipts = getImportReceipts()
                const dateObj = new Date(date)
                const formattedDate = dateObj.toLocaleDateString('vi-VN')

                const newReceipt = {
                    id: id || 'imp' + Date.now(),
                    date: formattedDate,
                    items: [...currentImportItems], // Lưu mảng sản phẩm
                    status: 'Chưa vào kho',
                }

                if (id) {
                    // EDIT MODE
                    const idx = receipts.findIndex((r) => r.id === id)
                    if (idx >= 0 && receipts[idx].status === 'Đã nhập kho') {
                        alert('❌ Phiếu đã hoàn thành không thể sửa!')
                        return
                    }
                    if (idx >= 0) {
                        receipts[idx] = newReceipt
                        alert('✅ Cập nhật phiếu nhập thành công!')
                    }
                } else {
                    // CREATE MODE
                    receipts.push(newReceipt)
                    const totalAmount = currentImportItems.reduce(
                        (sum, item) => sum + item.quantity * item.price,
                        0
                    )
                    const totalQuantity = currentImportItems.reduce(
                        (sum, item) => sum + item.quantity,
                        0
                    )
                    alert(`✅ Tạo phiếu nhập thành công!\n\n`)
                }

                setImportReceipts(receipts)
                resetImportForm()
                renderImportList()
            }
            function editImport(id) {
                const receipts = getImportReceipts()
                const receipt = receipts.find((r) => r.id === id)
                if (receipt && receipt.status === 'Đã nhập kho')
                    return alert('❌ Phiếu đã hoàn thành!')
                if (receipt) {
                    document.getElementById('importId').value = receipt.id
                    const [day, month, year] = receipt.date.split('/')
                    document.getElementById(
                        'importDate'
                    ).value = `${year}-${month}-${day}`

                    // Load danh sách sản phẩm vào form
                    if (receipt.items && receipt.items.length > 0) {
                        currentImportItems = [...receipt.items]
                    } else {
                        // Hỗ trợ format cũ (1 sản phẩm)
                        currentImportItems = [
                            {
                                productId: receipt.productId,
                                quantity: receipt.quantity,
                                price: receipt.price,
                            },
                        ]
                    }
                    renderImportItems()
                }
            }

            function loadProductsToSelect() {
                const products = getProducts()
                const select = document.getElementById('importProductSelect')

                if (!select) return

                // Xóa các option cũ (giữ lại option đầu tiên)
                while (select.options.length > 1) {
                    select.remove(1)
                }

                // Thêm các sản phẩm
                products.forEach((product) => {
                    const option = document.createElement('option')
                    option.value = product.id
                    option.textContent = `${product.id} - ${
                        product.title
                    } (Tồn: ${product.stock || 0})`
                    select.appendChild(option)
                })
            }

            // Hàm điền ID khi chọn từ dropdown
            function fillProductId(productId) {
                const input = document.getElementById('importProductId')
                if (input && productId) {
                    input.value = productId

                    // Hiển thị thông tin sản phẩm
                    const products = getProducts()
                    const product = products.find((p) => p.id === productId)
                    if (product) {
                        // Tạo notification nhỏ
                        const notification = document.createElement('div')
                        notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-size: 14px;
            `
                        notification.innerHTML = `
                ✅ Đã chọn: <strong>${product.title}</strong><br>
                <small>Tồn kho hiện tại: ${product.stock || 0} cái</small>
            `
                        document.body.appendChild(notification)

                        // Tự động xóa sau 2 giây
                        setTimeout(() => notification.remove(), 2000)
                    }
                }
            }

            function completeImport(id) {
                if (
                    !confirm(
                        'Hoàn thành phiếu? (Sẽ cộng số lượng vào kho cho tất cả sản phẩm trong phiếu)'
                    )
                )
                    return
                const receipts = getImportReceipts()
                const receipt = receipts.find((r) => r.id === id)

                if (receipt && receipt.status === 'Chưa vào kho') {
                    // Lấy danh sách sản phẩm (hỗ trợ cả format cũ và mới)
                    const items = receipt.items || [
                        {
                            productId: receipt.productId,
                            quantity: receipt.quantity,
                            price: receipt.price,
                        },
                    ]

                    const products = getProducts()
                    const updateDetails = []
                    let hasError = false

                    // ✅ CỘNG SỐ LƯỢNG VÀO KHO CHO TẤT CẢ SẢN PHẨM
                    items.forEach((item) => {
                        const product = products.find(
                            (p) => p.id === item.productId
                        )
                        if (!product) {
                            alert(
                                `❌ Không tìm thấy sản phẩm với ID: "${item.productId}"!\n\n` +
                                    `Vui lòng kiểm tra lại!`
                            )
                            hasError = true
                            return
                        }

                        if (product.stock === undefined) product.stock = 0
                        const oldStock = product.stock
                        product.stock += item.quantity
                        updateDetails.push(
                            `  • ${product.title} (${item.productId}): +${item.quantity} (${oldStock} → ${product.stock})`
                        )
                    })

                    if (hasError) return

                    saveProducts(products)

                    // ✅ CẬP NHẬT TRẠNG THÁI PHIẾU
                    receipt.status = 'Đã nhập kho'
                    setImportReceipts(receipts)

                    // ✅ RENDER LẠI
                    renderImportList()

                    // Render lại danh sách sản phẩm nếu đang ở tab products
                    const activeTab = document.querySelector(
                        '.tab:not([style*="display: none"])'
                    )
                    if (activeTab && activeTab.id === 'products') {
                        renderProductsList()
                    }

                    const totalAmount = items.reduce(
                        (sum, item) => sum + item.quantity * item.price,
                        0
                    )
                    const totalQuantity = items.reduce(
                        (sum, item) => sum + item.quantity,
                        0
                    )

                    alert(
                        `✅ Phiếu nhập đã hoàn thành!\n\n` +
                            `📦 Số sản phẩm: ${items.length}\n` +
                            `➕ Tổng số lượng nhập: ${totalQuantity} cái\n` +
                            `💰 Tổng giá trị: ${totalAmount.toLocaleString(
                                'vi-VN'
                            )} ₫\n\n` +
                            `📊 Chi tiết cập nhật kho:\n${updateDetails.join(
                                '\n'
                            )}`
                    )
                }
            }
            function deleteImport(id) {
                if (confirm('Xóa phiếu?')) {
                    let receipts = getImportReceipts()
                    receipts = receipts.filter((r) => r.id !== id)
                    setImportReceipts(receipts)
                    renderImportList()
                }
            }

            function resetImportForm() {
                document.getElementById('importForm').reset()
                document.getElementById('importId').value = ''
                const today = new Date().toISOString().split('T')[0]
                document.getElementById('importDate').value = today
                currentImportItems = []
                renderImportItems()
            }

            /* ===== INVENTORY TRACKING (Nhập - Xuất - Tồn) ===== */
            function loadInventoryCategories() {
                const products = getProducts()
                const categories = [
                    ...new Set(products.map((p) => p.category).filter(Boolean)),
                ]
                const select = document.getElementById(
                    'inventoryCategoryFilter'
                )

                if (!select) return

                // Xóa các option cũ (giữ lại option đầu tiên)
                while (select.options.length > 1) {
                    select.remove(1)
                }

                categories.forEach((cat) => {
                    const option = document.createElement('option')
                    option.value = cat
                    option.textContent = cat
                    select.appendChild(option)
                })
            }

            function renderInventoryList() {
                const products = getProducts()
                const receipts = getImportReceipts()
                const orders = getOrders()

                const searchTerm = (
                    document.getElementById('inventorySearch')?.value || ''
                ).toLowerCase()
                const categoryFilter =
                    document.getElementById('inventoryCategoryFilter')?.value ||
                    ''

                // Lọc sản phẩm
                let filteredProducts = products.filter((p) => {
                    const matchSearch =
                        p.title.toLowerCase().includes(searchTerm) ||
                        (p.author || '').toLowerCase().includes(searchTerm) ||
                        (p.id || '').toLowerCase().includes(searchTerm)
                    const matchCategory =
                        !categoryFilter || p.category === categoryFilter
                    return matchSearch && matchCategory
                })

                const tbody = document.getElementById('inventoryBody')

                if (filteredProducts.length === 0) {
                    tbody.innerHTML =
                        '<tr><td colspan="8" style="text-align:center;padding:40px;color:#666">📭 Không tìm thấy sản phẩm</td></tr>'
                    return
                }

                tbody.innerHTML = filteredProducts
                    .map((product) => {
                        const productId = product.id

                        // Tính tổng nhập (từ phiếu nhập đã hoàn thành)
                        let totalImport = 0
                        receipts.forEach((receipt) => {
                            if (receipt.status === 'Đã nhập kho') {
                                const items = receipt.items || [
                                    {
                                        productId: receipt.productId,
                                        quantity: receipt.quantity,
                                    },
                                ]
                                items.forEach((item) => {
                                    if (item.productId === productId) {
                                        totalImport += item.quantity || 0
                                    }
                                })
                            }
                        })

                        // Tính tổng xuất (từ đơn hàng đã xử lý)
                        let totalExport = 0
                        orders.forEach((order) => {
                            if (
                                order.status === 'Đang xử lý' ||
                                order.status === 'Đã gửi' ||
                                order.status === 'Đã giao'
                            ) {
                                if (order.items) {
                                    order.items.forEach((item) => {
                                        if (item.id === productId) {
                                            totalExport += item.quantity || 0
                                        }
                                    })
                                }
                            }
                        })

                        // Tồn đầu kỳ: giả sử là 0 (vì mặc định stock = 0 khi thêm sản phẩm)
                        const openingStock = 0

                        // Tồn cuối kỳ: số lượng hiện tại
                        const closingStock = product.stock || 0

                        // Kiểm tra công thức: Tồn đầu + Nhập - Xuất = Tồn cuối
                        const calculatedStock =
                            openingStock + totalImport - totalExport

                        // Màu sắc cảnh báo
                        let stockColor = 'color:#10b981'
                        if (closingStock === 0) {
                            stockColor = 'color:#ef4444;font-weight:800'
                        } else if (closingStock < 5) {
                            stockColor = 'color:#dc2626;font-weight:800'
                        } else if (closingStock < 10) {
                            stockColor = 'color:#f59e0b;font-weight:700'
                        }

                        return `
                            <tr>
                                <td><strong>${product.id}</strong></td>
                                <td>${product.title}</td>
                                <td>${product.author || ''}</td>
                                <td style="text-align: center; font-weight: 600;">${openingStock}</td>
                                <td style="text-align: center; font-weight: 600; color: #10b981;">+${totalImport}</td>
                                <td style="text-align: center; font-weight: 600; color: #ef4444;">-${totalExport}</td>
                                <td style="text-align: center; font-weight: 700; ${stockColor};">${closingStock}</td>
                                <td>
                                    <button onclick="viewInventoryDetail('${
                                        product.id
                                    }')" style="background:#3b82f6;color:white;padding:6px 12px;border:none;border-radius:4px;cursor:pointer;">
                                        👁️ Chi tiết
                                    </button>
                                </td>
                            </tr>
                        `
                    })
                    .join('')
            }

            function viewInventoryDetail(productId) {
                const products = getProducts()
                const product = products.find((p) => p.id === productId)
                if (!product) {
                    alert('❌ Không tìm thấy sản phẩm!')
                    return
                }

                const receipts = getImportReceipts()
                const orders = getOrders()

                // Lấy danh sách phiếu nhập
                const importList = []
                receipts.forEach((receipt) => {
                    if (receipt.status === 'Đã nhập kho') {
                        const items = receipt.items || [
                            {
                                productId: receipt.productId,
                                quantity: receipt.quantity,
                                price: receipt.price,
                            },
                        ]
                        items.forEach((item) => {
                            if (item.productId === productId) {
                                importList.push({
                                    date: receipt.date,
                                    quantity: item.quantity,
                                    price: item.price,
                                    receiptId: receipt.id,
                                })
                            }
                        })
                    }
                })

                // Lấy danh sách đơn hàng xuất
                const exportList = []
                orders.forEach((order) => {
                    if (
                        order.status === 'Đang xử lý' ||
                        order.status === 'Đã gửi' ||
                        order.status === 'Đã giao'
                    ) {
                        if (order.items) {
                            order.items.forEach((item) => {
                                if (item.id === productId) {
                                    exportList.push({
                                        date: order.date,
                                        quantity: item.quantity,
                                        orderId: order.id,
                                        customer:
                                            order.shippingAddress?.fullname ||
                                            order.customer ||
                                            'N/A',
                                    })
                                }
                            })
                        }
                    }
                })

                const totalImport = importList.reduce(
                    (sum, item) => sum + item.quantity,
                    0
                )
                const totalExport = exportList.reduce(
                    (sum, item) => sum + item.quantity,
                    0
                )
                const openingStock = 0
                const closingStock = product.stock || 0

                const importDetails = importList
                    .map(
                        (item) =>
                            `  • ${item.date}: +${
                                item.quantity
                            } cái (Giá: ${item.price.toLocaleString(
                                'vi-VN'
                            )} ₫)`
                    )
                    .join('\n')
                const exportDetails = exportList
                    .map(
                        (item) =>
                            `  • ${item.date}: -${item.quantity} cái (Đơn: ${item.orderId}, KH: ${item.customer})`
                    )
                    .join('\n')

                alert(`📊 CHI TIẾT NHẬP - XUẤT - TỒN


📈 TỔNG KẾT:
  Tồn đầu kỳ: ${openingStock} cái
  Tổng nhập: +${totalImport} cái
  Tổng xuất: -${totalExport} cái
  Tồn cuối kỳ: ${closingStock} cái

📥 LỊCH SỬ NHẬP (${importList.length} phiếu):
${importDetails || '  Chưa có phiếu nhập nào'}

📤 LỊCH SỬ XUẤT (${exportList.length} đơn hàng):
${exportDetails || '  Chưa có đơn hàng nào'}`)
            }

            /* ===== LOGOUT ===== */
            function logout() {
                if (confirm('❓ Bạn có chắc muốn đăng xuất?')) {
                    localStorage.removeItem('bs_admin_session')
                    localStorage.removeItem('bs_auth')
                    sessionStorage.removeItem('bs_auth')
                    window.location.href = 'index.html'
                }
            }

            /* ===== EXPORT DATA ===== */
            function exportData() {
                const data = {
                    products: getProducts(),
                    orders: getOrders(),
                    users: getUsers().map((u) => ({ ...u, password: '***' })), // Ẩn password
                    exportDate: new Date().toISOString(),
                }

                const json = JSON.stringify(data, null, 2)
                const blob = new Blob([json], { type: 'application/json' })
                const url = URL.createObjectURL(blob)
                const a = document.createElement('a')
                a.href = url
                a.download = `bookstore-backup-${Date.now()}.json`
                a.click()
                URL.revokeObjectURL(url)

                alert('✅ Đã xuất dữ liệu thành công!')
            }

            /* ===== INIT ===== */
            ;(async function init() {
                // Check admin auth
                const adminAuth = localStorage.getItem('bs_admin_session')
                if (!adminAuth) {
                    alert('⚠️ Vui lòng đăng nhập với tài khoản admin!')
                    window.location.href = 'admin-login.html'
                    return
                }

                // Seed data
                await seedData()

                // Initial render
                updateStats()
                renderRecentOrders()
                renderTopProducts()
                renderProductsList()
                renderOrdersList()
                renderUsersList()

                console.log('✅ Admin panel loaded successfully!')
                console.log('📊 Stats:', {
                    products: getProducts().length,
                    orders: getOrders().length,
                    users: getUsers().length,
                })
            })()
        </script>
    </body>
</html>
