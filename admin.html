<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>BookStore Admin</title>
        <link rel="stylesheet" href="css/admin.css" />
    </head>
    <body>
        <header class="topbar">
            <div class="brand">
                <div class="logo">B</div>
                <div>BookStore Admin</div>
            </div>

            <nav class="navlist" aria-label="Main navigation">
                <div
                    class="nav-item active"
                    data-tab="dashboard"
                    onclick="switchTab('dashboard', this)"
                >
                    🏠 Dashboard
                </div>
                <div
                    class="nav-item"
                    data-tab="products"
                    onclick="switchTab('products', this)"
                >
                    📚 Sản phẩm
                </div>
                <div
                    class="nav-item"
                    data-tab="orders"
                    onclick="switchTab('orders', this)"
                >
                    🧾 Đơn hàng
                </div>
                <div
                    class="nav-item"
                    data-tab="users"
                    onclick="switchTab('users', this)"
                >
                    👥 Người dùng
                </div>
                <div
                    class="nav-item"
                    data-tab="import"
                    onclick="switchTab('import', this)"
                >
                    📦 Nhập hàng
                </div>
                <div
                    class="nav-item"
                    data-tab="pricing"
                    onclick="switchTab('pricing', this)"
                >
                    💲 Giá bán
                </div>
            </nav>

            <div class="top-actions">
                <div class="btn-pill">Admin</div>
                <div class="btn-pill" onclick="logout()">Đăng xuất</div>
            </div>
        </header>

        <main class="container">
            <!-- DASHBOARD -->
            <section id="dashboard" class="tab">
                <h1 class="page-title">📊 Dashboard</h1>

                <div class="stats-grid" id="statsGrid">
                    <div class="card">
                        <div class="icon">📚</div>
                        <div class="meta">
                            <div class="label">Tổng sản phẩm</div>
                            <div class="value" id="statProducts">0</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="icon">💰</div>
                        <div class="meta">
                            <div class="label">Doanh thu</div>
                            <div class="value" id="statRevenue">0 ₫</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="icon">🛒</div>
                        <div class="meta">
                            <div class="label">Đơn hàng</div>
                            <div class="value" id="statOrders">0</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="icon">👥</div>
                        <div class="meta">
                            <div class="label">Người dùng</div>
                            <div class="value" id="statUsers">0</div>
                        </div>
                    </div>
                </div>

                <div class="panel" style="margin-bottom: 22px">
                    <div
                        style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 12px;
                        "
                    >
                        <div class="section-title">⚡ Thao tác nhanh</div>
                        <div style="color: var(--muted); font-size: 14px">
                            Thêm, xem hoặc báo cáo nhanh
                        </div>
                    </div>
                    <div class="quick-grid">
                        <div
                            class="quick"
                            onclick="switchTab('products', document.querySelector('[data-tab=products]'))"
                        >
                            <div class="big">➕</div>
                            <div>Thêm sản phẩm</div>
                        </div>
                        <div
                            class="quick"
                            onclick="switchTab('orders', document.querySelector('[data-tab=orders]'))"
                        >
                            <div class="big">📦</div>
                            <div>Xem đơn hàng</div>
                        </div>
                        <div
                            class="quick"
                            onclick="switchTab('users', document.querySelector('[data-tab=users]'))"
                        >
                            <div class="big">👥</div>
                            <div>Quản lý người dùng</div>
                        </div>
                        <div class="quick" onclick="exportData()">
                            <div class="big">📈</div>
                            <div>Xuất dữ liệu</div>
                        </div>
                    </div>
                </div>

                <div class="panel" style="margin-bottom: 18px">
                    <div
                        style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 12px;
                        "
                    >
                        <div class="section-title">🛒 Đơn hàng gần đây</div>
                        <div
                            style="color: teal; cursor: pointer"
                            onclick="switchTab('orders', document.querySelector('[data-tab=orders]'))"
                        >
                            Xem tất cả →
                        </div>
                    </div>
                    <table class="table" id="recentOrdersTable">
                        <thead>
                            <tr>
                                <th>Mã đơn</th>
                                <th>Khách hàng</th>
                                <th>Ngày đặt</th>
                                <th>Tổng tiền</th>
                                <th>Trạng thái</th>
                            </tr>
                        </thead>
                        <tbody id="recentOrdersBody"></tbody>
                    </table>
                </div>

                <div class="panel">
                    <div
                        style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 12px;
                        "
                    >
                        <div class="section-title">🔥 Sản phẩm bán chạy</div>
                        <div
                            style="color: teal; cursor: pointer"
                            onclick="switchTab('products', document.querySelector('[data-tab=products]'))"
                        >
                            Xem tất cả →
                        </div>
                    </div>
                    <div id="topProducts" style="min-height: 120px"></div>
                </div>
            </section>

            <!-- PRODUCTS -->
            <section id="products" class="tab" style="display: none">
                <h1 class="page-title">📚 Quản lý sản phẩm</h1>

                <div class="panel" style="margin-bottom: 18px">
                    <div class="section-title">➕ Thêm/Sửa sản phẩm</div>
                    <form id="productForm" onsubmit="return false">
                        <input type="hidden" id="productId" />

                        <div class="form-row">
                            <div class="form-group">
                                <label>Tiêu đề *</label>
                                <input
                                    id="productTitle"
                                    placeholder="Nhập tên sách"
                                    required
                                />
                            </div>
                            <div class="form-group">
                                <label>Tác giả</label>
                                <input
                                    id="productAuthor"
                                    placeholder="Tên tác giả"
                                />
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Giá (VNĐ) *</label>
                                <input
                                    id="productPrice"
                                    type="number"
                                    placeholder="0"
                                    required
                                />
                            </div>
                            <div class="form-group">
                                <label>Số lượng tồn kho *</label>
                                <input
                                    id="productStock"
                                    type="number"
                                    placeholder="0"
                                    min="0"
                                    required
                                />
                            </div>
                            <div class="form-group">
                                <label>Thể loại</label>
                                <input
                                    id="productCategory"
                                    placeholder="VD: Văn học, Công nghệ..."
                                />
                            </div>
                        </div>

                        <div class="form-group">
                            <label>URL ảnh bìa</label>
                            <input
                                id="productImage"
                                placeholder="https://example.com/image.jpg"
                            />
                        </div>

                        <div class="form-group">
                            <label>Mô tả</label>
                            <textarea
                                id="productDesc"
                                rows="3"
                                placeholder="Mô tả ngắn về sách..."
                            ></textarea>
                        </div>

                        <div style="display: flex; gap: 10px">
                            <button
                                style="
                                    background: var(--primary);
                                    color: white;
                                    flex: 1;
                                "
                                onclick="saveProduct()"
                            >
                                💾 Lưu sản phẩm
                            </button>
                            <button
                                style="background: #e5e7eb; color: #374151"
                                onclick="clearProductForm()"
                            >
                                🔄 Xóa form
                            </button>
                        </div>
                    </form>
                </div>

                <div class="panel">
                    <div
                        style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 12px;
                            flex-wrap: wrap;
                            gap: 12px;
                        "
                    >
                        <div class="section-title">📋 Danh sách sản phẩm</div>
                        <div style="display: flex; gap: 8px">
                            <input
                                id="searchProd"
                                placeholder="🔍 Tìm kiếm (ID, tên, tác giả)..."
                                style="
                                    width: 300px;
                                    padding: 8px;
                                    border: 1px solid #eef3f6;
                                    border-radius: 8px;
                                "
                                oninput="renderProductsList()"
                            />
                        </div>
                    </div>

                    <table class="table" id="productsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tiêu đề</th>
                                <th>Tác giả</th>
                                <th>Giá</th>
                                <th>Số lượng</th>
                                <th>Thể loại</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="productsBody"></tbody>
                    </table>

                    <!-- Pagination -->
                    <div id="productsPagination" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px; padding: 15px 0; flex-wrap: wrap;">
                    </div>
                </div>
            </section>

            <!-- ORDERS -->
            <section id="orders" class="tab" style="display: none">
                <h1 class="page-title">🧾 Quản lý đơn hàng</h1>
                <div class="panel">
                    <div
                        style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 12px;
                            flex-wrap: wrap;
                            gap: 12px;
                        "
                    >
                        <div class="section-title">📦 Danh sách đơn hàng</div>
                        <div>
                            <input
                                id="searchOrder"
                                placeholder="🔍 Tìm mã đơn/khách"
                                style="
                                    padding: 8px;
                                    border: 1px solid #eef3f6;
                                    border-radius: 8px;
                                    width: 200px;
                                "
                                oninput="renderOrdersList()"
                            />
                        </div>
                    </div>

                    <table class="table">
                        <thead>
                            <tr>
                                <th>Mã đơn</th>
                                <th>Khách hàng</th>
                                <th>Ngày</th>
                                <th>Tổng tiền</th>
                                <th>Trạng thái</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="ordersBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- USERS -->
            <section id="users" class="tab" style="display: none">
                <h1 class="page-title">👥 Quản lý người dùng</h1>
                <div class="panel">
                    <div
                        style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 12px;
                        "
                    >
                        <div class="section-title">👤 Danh sách người dùng</div>
                    </div>

                    <table class="table">
                        <thead>
                            <tr>
                                <th>Email/Username</th>
                                <th>Trạng thái</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="usersBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- PRICING -->
          <!-- PRICING -->
<section id="pricing" class="tab" style="display: none">
    <h1 class="page-title">💲 Quản lý Giá Bán Theo Sản Phẩm</h1>

    <!-- Thống kê tổng quan -->
    <div class="stats-grid" style="margin-bottom: 20px">
        <div class="card">
            <div class="icon">📊</div>
            <div class="meta">
                <div class="label">% Lợi nhuận TB</div>
                <div class="value" id="avgProfit">0%</div>
            </div>
        </div>
        <div class="card">
            <div class="icon">💰</div>
            <div class="meta">
                <div class="label">Lợi nhuận/SP TB</div>
                <div class="value" id="avgProfitAmount">0 ₫</div>
            </div>
        </div>
        <div class="card">
            <div class="icon">🔥</div>
            <div class="meta">
                <div class="label">SP lợi nhuận cao</div>
                <div class="value" id="highProfitCount">0</div>
            </div>
        </div>
    </div>

    <!-- Bảng quản lý giá -->
    <div class="panel">
        <div class="section-title">📋 Danh sách sản phẩm và giá bán</div>
        
        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; margin-bottom: 15px">
            <input 
                type="text" 
                id="searchPricing" 
                placeholder="🔍 Tìm kiếm theo tên sách hoặc ID..."
                style="padding: 10px; border: 1px solid #eef3f6; border-radius: 8px"
                oninput="renderPricingTable()"
            >
            <select 
                id="categoryFilterPricing" 
                style="padding: 10px; border: 1px solid #eef3f6; border-radius: 8px"
                onchange="renderPricingTable()"
            >
                <option value="">-- Tất cả thể loại --</option>
            </select>
            <select 
                id="profitFilterPricing" 
                style="padding: 10px; border: 1px solid #eef3f6; border-radius: 8px"
                onchange="renderPricingTable()"
            >
                <option value="">-- Lọc theo lợi nhuận --</option>
                <option value="low">0-20%</option>
                <option value="medium">20-40%</option>
                <option value="high">>40%</option>
            </select>
        </div>

        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Tên sách</th>
                    <th>Thể loại</th>
                    <th>Giá vốn (₫)</th>
                    <th>% Lợi nhuận</th>
                    <th>Giá bán (₫)</th>
                    <th>Lợi nhuận/SP (₫)</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody id="pricingTableBody"></tbody>
        </table>
    </div>
</section>

            <!-- IMPORT -->
            <section id="import" class="tab" style="display: none">
                <h1 class="page-title">📦 Nhập hàng / Quản lý phiếu nhập</h1>

                <div class="panel" style="margin-bottom: 18px">
                    <div class="section-title">
                        ➕ Thêm / Hoàn thành Phiếu Nhập
                    </div>
                    <form id="importForm" onsubmit="return false">
                        <input type="hidden" id="importId" />
                        <div class="form-row">
                            <div class="form-group">
                                <label>Ngày nhập (dd/mm/yyyy):</label>
                                <input type="date" id="importDate" required />
                            </div>
                            <div class="form-group">
    <label>Chọn sản phẩm:</label>
    <select 
        id="importProductSelect" 
        style="padding: 10px; border: 1px solid #eef3f6; border-radius: 8px; width: 100%"
        onchange="fillProductId(this.value)"
    >
        <option value="">-- Chọn sản phẩm từ danh sách --</option>
    </select>
</div>

<div class="form-group">
    <label>Hoặc nhập ID Sản phẩm thủ công:</label>
    <input
        type="text"
        id="importProductId"
        placeholder="b001"
        required
    />
    <div style="margin-top: 8px; padding: 8px; background: #f0f9ff; border-left: 3px solid #3b82f6; border-radius: 4px; font-size: 0.85rem">
        💡 <strong>Gợi ý:</strong> Chọn từ dropdown hoặc nhập ID thủ công (VD: b001, b002...)
    </div>
</div>
                            <div class="form-group">
                                <label>Số lượng nhập:</label>
                                <input
                                    type="number"
                                    id="importQuantity"
                                    placeholder="0"
                                    min="1"
                                    required
                                />
                            </div>
                            <div class="form-group">
                                <label>Giá nhập (VNĐ) / 1 sản phẩm:</label>
                                <input
                                    type="number"
                                    id="importPrice"
                                    placeholder="0"
                                    min="0"
                                    required
                                />
                            </div>
                        </div>
                        <button
                            type="button"
                            onclick="saveImportReceipt()"
                            style="background: teal; color: white; width: 200px"
                        >
                            📥 Lưu / Hoàn thành phiếu kho
                        </button>
                        <button
                            type="button"
                            onclick="resetImportForm()"
                            style="background: #ddd; width: 200px"
                        >
                            🗑️ Xóa form
                        </button>
                        <div
                            style="
                                margin-top: 12px;
                                padding: 12px;
                                background: #e8f5e9;
                                border-radius: 8px;
                                color: #2e7d32;
                                font-size: 14px;
                            "
                        >
                            <strong>💡 Hướng dẫn:</strong>
                            <ul style="margin: 8px 0 0 20px">
                                <li>
                                    Bước 1: Điền thông tin và nhấn "Lưu" → Tạo
                                    phiếu nhập (chưa vào kho)
                                </li>
                                <li>
                                    Bước 2: Nhấn "✅ Sửa" → Kiểm tra lại → Nhấn
                                    "Lưu" → Số lượng tự động cộng vào kho
                                </li>
                                <li>
                                    Lưu ý: Phiếu đã hoàn thành không thể sửa!
                                </li>
                            </ul>
                        </div>
                    </form>
                </div>

                <div class="panel">
                    <div class="section-title">📋 Danh sách Phiếu Nhập</div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Ngày nhập</th>
                                <th>ID Sản phẩm</th>
                                <th>Số lượng</th>
                                <th>Giá nhập</th>
                                <th>Tổng tiền</th>
                                <th>Trạng thái</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="importBody"></tbody>
                    </table>
                </div>
            </section>
        </main>

        <script>
            /* ===== STORAGE HELPERS ===== */
            const getProducts = () =>
                JSON.parse(localStorage.getItem('bs_products') || '[]')
            const saveProducts = (arr) =>
                localStorage.setItem('bs_products', JSON.stringify(arr))
            const getOrders = () =>
                JSON.parse(localStorage.getItem('orders') || '[]')
            const saveOrders = (arr) =>
                localStorage.setItem('orders', JSON.stringify(arr))
            const getUsers = () =>
                JSON.parse(localStorage.getItem('bs_users') || '[]')
            const saveUsers = (arr) =>
                localStorage.setItem('bs_users', JSON.stringify(arr))
            const getCategories = () =>
                JSON.parse(localStorage.getItem('bs_categories') || '[]')
            const saveCategories = (arr) =>
                localStorage.setItem('bs_categories', JSON.stringify(arr))

            /* ===== SEED DATA ===== */
            async function seedData() {
                // Load products từ books.json nếu chưa có
                if (getProducts().length === 0) {
                    try {
                        const res = await fetch('data/books.json')
                        const books = await res.json()
                        // Thêm stock mặc định cho mỗi sản phẩm
                        books.forEach((book) => {
                            if (book.stock === undefined) book.stock = 100
                        })
                        saveProducts(books)
                        console.log(
                            '✅ Đã load',
                            books.length,
                            'sản phẩm từ books.json'
                        )
                    } catch (e) {
                        console.warn(
                            '⚠️ Không load được books.json, sử dụng dữ liệu mẫu'
                        )
                        const sampleProducts = [
                            {
                                id: 'b001',
                                title: 'Atomic Habits',
                                author: 'James Clear',
                                price: 195000,
                                stock: 100,
                                category: 'Phát triển bản thân',
                                cover: 'https://images.unsplash.com/photo-1515378791036-0648a3ef77b2?w=800',
                                desc: 'Cẩm nang thay đổi thói quen hiệu quả',
                            },
                            {
                                id: 'b002',
                                title: 'Clean Code',
                                author: 'Robert C. Martin',
                                price: 250000,
                                stock: 50,
                                category: 'Công nghệ',
                                cover: 'https://images.unsplash.com/photo-1518770660439-4636190af475?w=800',
                                desc: 'Nguyên tắc viết code sạch',
                            },
                            {
                                id: 'b003',
                                title: 'Sapiens',
                                author: 'Yuval Noah Harari',
                                price: 180000,
                                stock: 75,
                                category: 'Lịch sử',
                                cover: 'https://images.unsplash.com/photo-1457369804613-52c61a468e7d?w=800',
                                desc: 'Lược sử loài người',
                            },
                        ]
                        saveProducts(sampleProducts)
                    }
                }

                // Load users từ users.json nếu chưa có
                if (getUsers().length === 0) {
                    try {
                        const res = await fetch('data/users.json')
                        const users = await res.json()
                        // Đảm bảo mỗi user có thuộc tính locked (boolean)
                        users.forEach((user) => {
                            if (
                                user.locked === undefined ||
                                user.locked === null
                            ) {
                                user.locked = false
                            } else {
                                // Chuyển đổi string/truthy thành boolean
                                user.locked =
                                    user.locked === true ||
                                    user.locked === 'true'
                            }
                        })
                        saveUsers(users)
                        console.log(
                            '✅ Đã load',
                            users.length,
                            'người dùng từ users.json'
                        )
                    } catch (e) {
                        console.warn(
                            '⚠️ Không load được users.json, bỏ qua (users sẽ được tạo khi đăng ký)'
                        )
                    }
                }

                // Load categories từ categories.json nếu chưa có
                if (getCategories().length === 0) {
                    try {
                        const res = await fetch('data/categories.json')
                        const categories = await res.json()
                        saveCategories(categories)
                        console.log(
                            '✅ Đã load',
                            categories.length,
                            'danh mục từ categories.json'
                        )
                    } catch (e) {
                        console.warn(
                            '⚠️ Không load được categories.json, bỏ qua (categories có thể được tạo thủ công)'
                        )
                    }
                }
            }

            /* ===== DASHBOARD ===== */
            function updateStats() {
                const products = getProducts()
                const orders = getOrders()
                const users = getUsers()

                document.getElementById('statProducts').textContent =
                    products.length

                const revenue = orders.reduce((s, o) => s + (o.total || 0), 0)
                document.getElementById('statRevenue').textContent =
                    revenue.toLocaleString('vi-VN') + ' ₫'

                document.getElementById('statOrders').textContent =
                    orders.length
                document.getElementById('statUsers').textContent = users.length
            }

            function renderRecentOrders() {
                const rows = document.getElementById('recentOrdersBody')
                const orders = getOrders().slice().reverse().slice(0, 5)

                if (orders.length === 0) {
                    rows.innerHTML =
                        '<tr><td colspan="5" class="empty" style="text-align:center;padding:40px">📭 Chưa có đơn hàng nào</td></tr>'
                    return
                }

                rows.innerHTML = orders
                    .map(
                        (o) => `
        <tr>
          <td><strong>${o.id}</strong></td>
          <td>${o.shippingAddress?.fullname || o.customer || 'N/A'}</td>
          <td>${o.date}</td>
          <td style="font-weight:700;color:var(--primary)">${o.total.toLocaleString(
              'vi-VN'
          )}₫</td>
          <td><span class="badge">${o.status}</span></td>
        </tr>
      `
                    )
                    .join('')
            }

            function renderTopProducts() {
                const el = document.getElementById('topProducts')
                const products = getProducts()

                if (products.length === 0) {
                    el.innerHTML =
                        '<div class="empty"><div style="font-size:50px">📚</div><div style="margin-top:12px">Chưa có sản phẩm nào</div></div>'
                    return
                }

                el.innerHTML =
                    '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:14px">' +
                    products
                        .slice(0, 4)
                        .map(
                            (p) => `
        <div style="background:#fff;border-radius:10px;padding:14px;display:flex;gap:12px;align-items:center;box-shadow:0 4px 12px rgba(9,40,58,0.04);border:1px solid #f0f4f6">
          <img src="${p.cover || p.image}" alt="${
                                p.title
                            }" style="width:50px;height:70px;object-fit:cover;border-radius:6px" onerror="this.src='https://via.placeholder.com/50x70?text=📖'">
          <div style="flex:1">
            <div style="font-weight:700;font-size:0.95rem;margin-bottom:4px">${
                p.title
            }</div>
            <div style="color:var(--muted);font-size:0.85rem;margin-bottom:6px">${
                p.author
            }</div>
            <div style="font-weight:700;color:var(--primary)">${(
                p.price || 0
            ).toLocaleString('vi-VN')} ₫</div>
          </div>
        </div>
      `
                        )
                        .join('') +
                    '</div>'
            }

            /* ===== PRODUCTS ===== */
            const PRODUCTS_PER_PAGE = 10
            let currentProductPage = 1

            function renderProductsList() {
                const q = (
                    document.getElementById('searchProd')?.value || ''
                ).toLowerCase()
                const allProducts = getProducts().filter(
                    (p) =>
                        p.title.toLowerCase().includes(q) ||
                        (p.author || '').toLowerCase().includes(q) ||
                        (p.category || '').toLowerCase().includes(q) ||
                        (p.id || '').toLowerCase().includes(q)
                )

                // Reset to page 1 when search changes
                if (document.getElementById('searchProd')?.value !== '') {
                    currentProductPage = 1
                }

                const totalPages = Math.ceil(allProducts.length / PRODUCTS_PER_PAGE)
                const startIdx = (currentProductPage - 1) * PRODUCTS_PER_PAGE
                const products = allProducts.slice(startIdx, startIdx + PRODUCTS_PER_PAGE)

                const body = document.getElementById('productsBody')

                if (allProducts.length === 0) {
                    body.innerHTML =
                        '<tr><td colspan="7" class="empty" style="text-align:center;padding:40px">📭 Không tìm thấy sản phẩm</td></tr>'
                } else {
                    body.innerHTML = products
                        .map((p) => {
                            const stock = p.stock !== undefined ? p.stock : 0
                            const stockColor =
                                stock === 0
                                    ? 'color:#ef4444'
                                    : stock < 10
                                    ? 'color:#f59e0b'
                                    : 'color:#10b981'
                            return `
          <tr>
            <td><strong>${p.id}</strong></td>
            <td>${p.title}</td>
            <td>${p.author || ''}</td>
            <td style="font-weight:700;color:var(--primary)">${(
                p.price || 0
            ).toLocaleString('vi-VN')}₫</td>
            <td style="font-weight:700;${stockColor}">${stock}</td>
            <td>${p.category || ''}</td>
            <td>
              <button style="background:#3b82f6;color:white;margin-right:6px" onclick="editProduct('${
                  p.id
              }')">✏️ Sửa</button>
              <button style="background:#ef4444;color:white" onclick="removeProduct('${
                  p.id
              }')">🗑️ Xóa</button>
            </td>
          </tr>
        `
                        })
                        .join('')
                }

                // Render pagination
                const paginationDiv = document.getElementById('productsPagination')
                if (totalPages <= 1) {
                    paginationDiv.innerHTML = ''
                } else {
                    let paginationHTML = ''

                    // Previous button
                    paginationHTML += `
                        <button onclick="gotoProductPage(${currentProductPage - 1})" 
                            ${currentProductPage === 1 ? 'disabled style="opacity:0.5;cursor:not-allowed"' : 'style="background:#3b82f6;color:white;padding:8px 12px;border:none;border-radius:6px;cursor:pointer"'}>
                            ◀ Trước
                        </button>
                    `

                    // Page info
                    paginationHTML += `
                        <span style="color:#6b7280;font-weight:600;min-width:120px;text-align:center">
                            Trang ${currentProductPage} / ${totalPages}
                        </span>
                    `

                    // Next button
                    paginationHTML += `
                        <button onclick="gotoProductPage(${currentProductPage + 1})" 
                            ${currentProductPage === totalPages ? 'disabled style="opacity:0.5;cursor:not-allowed"' : 'style="background:#3b82f6;color:white;padding:8px 12px;border:none;border-radius:6px;cursor:pointer"'}>
                            Sau ▶
                        </button>
                    `

                    paginationDiv.innerHTML = paginationHTML
                }

                updateStats()
            }

            function gotoProductPage(page) {
                const q = (
                    document.getElementById('searchProd')?.value || ''
                ).toLowerCase()
                const allProducts = getProducts().filter(
                    (p) =>
                        p.title.toLowerCase().includes(q) ||
                        (p.author || '').toLowerCase().includes(q) ||
                        (p.category || '').toLowerCase().includes(q) ||
                        (p.id || '').toLowerCase().includes(q)
                )
                const totalPages = Math.ceil(allProducts.length / PRODUCTS_PER_PAGE)

                if (page >= 1 && page <= totalPages) {
                    currentProductPage = page
                    renderProductsList()
                }
            }

            function saveProduct() {
                const id =
                    document.getElementById('productId').value ||
                    'b' + Date.now()
                const title = document
                    .getElementById('productTitle')
                    .value.trim()

                if (!title) {
                    alert('❌ Vui lòng nhập tiêu đề sản phẩm!')
                    return
                }

                const stock = parseInt(
                    document.getElementById('productStock').value
                )
                if (isNaN(stock) || stock < 0) {
                    alert('❌ Vui lòng nhập số lượng tồn kho hợp lệ (>= 0)!')
                    return
                }

                const product = {
                    id: id,
                    title: title,
                    author: document
                        .getElementById('productAuthor')
                        .value.trim(),
                    price:
                        parseInt(
                            document.getElementById('productPrice').value
                        ) || 0,
                    stock: stock,
                    category: document
                        .getElementById('productCategory')
                        .value.trim(),
                    cover:
                        document.getElementById('productImage').value.trim() ||
                        'https://via.placeholder.com/100x150?text=📖',
                    image:
                        document.getElementById('productImage').value.trim() ||
                        'https://via.placeholder.com/100x150?text=📖',
                    desc: document.getElementById('productDesc').value.trim(),
                }

                let products = getProducts()
                const idx = products.findIndex((p) => p.id === id)

                if (idx >= 0) {
                    products[idx] = product
                    alert('✅ Cập nhật sản phẩm thành công!')
                } else {
                    products.push(product)
                    alert('✅ Thêm sản phẩm thành công!')
                }

                saveProducts(products)
                clearProductForm()

                // Auto reload
                renderProductsList()
                renderTopProducts()
                updateStats()
            }

            function clearProductForm() {
                document.getElementById('productForm').reset()
                document.getElementById('productId').value = ''
                document.getElementById('productStock').value = '0'
            }

            function editProduct(id) {
                const p = getProducts().find((x) => x.id === id)
                if (!p) return

                document.getElementById('productId').value = p.id
                document.getElementById('productTitle').value = p.title
                document.getElementById('productAuthor').value = p.author || ''
                document.getElementById('productPrice').value = p.price || 0
                document.getElementById('productStock').value =
                    p.stock !== undefined ? p.stock : 0
                document.getElementById('productCategory').value =
                    p.category || ''
                document.getElementById('productImage').value =
                    p.cover || p.image || ''
                document.getElementById('productDesc').value = p.desc || ''

                document
                    .getElementById('productForm')
                    .scrollIntoView({ behavior: 'smooth' })
            }

            function removeProduct(id) {
                if (!confirm('❓ Bạn có chắc muốn xóa sản phẩm này?')) return

                const products = getProducts().filter((p) => p.id !== id)
                saveProducts(products)

                // Auto reload
                renderProductsList()
                renderTopProducts()
                updateStats()

                alert('✅ Đã xóa sản phẩm!')
            }

            /* ===== ORDERS ===== */
            function renderOrdersList() {
                const q = (
                    document.getElementById('searchOrder')?.value || ''
                ).toLowerCase()
                const body = document.getElementById('ordersBody')
                const orders = getOrders().filter(
                    (o) =>
                        o.id.toLowerCase().includes(q) ||
                        (o.shippingAddress?.fullname || o.customer || '')
                            .toLowerCase()
                            .includes(q)
                )

                if (orders.length === 0) {
                    body.innerHTML =
                        '<tr><td colspan="7" class="empty" style="text-align:center;padding:40px">📭 Không có đơn hàng</td></tr>'
                } else {
                    body.innerHTML = orders
                        .map((o) => {
                            let actionButtons = ''

                            if (o.status === 'Đã giao') {
                                // Đơn hàng đã hoàn thành - chỉ hiển thị nút Xem
                                actionButtons = `<button style="background:#3b82f6;color:white;padding:6px 12px" onclick="viewOrder('${o.id}')">👁️ Xem</button>
                             <span style="color:#10b981;font-weight:bold">✅ Hoàn thành</span>`
                            } else if (o.status === 'Đã hủy') {
                                // Đơn hàng đã hủy - chỉ hiển thị nút Xem
                                actionButtons = `<button style="background:#3b82f6;color:white;padding:6px 12px" onclick="viewOrder('${o.id}')">👁️ Xem</button>
                             <span style="color:#ef4444;font-weight:bold">❌ Đã hủy</span>`
                            } else {
                                // Đơn hàng chưa hoàn thành - hiển thị tất cả nút
                                actionButtons = `<button style="background:#3b82f6;color:white;padding:6px 12px;margin-right:4px" onclick="viewOrder('${o.id}')">👁️ Xem</button>
                             <button style="background:#ff9800;color:white;padding:6px 12px;margin-right:4px" onclick="processOrder('${o.id}')">⚙️ Xử lý</button>
                             <button style="background:#ef4444;color:white;padding:6px 12px" onclick="cancelOrderFromAdmin('${o.id}')">❌ Hủy</button>`
                            }

                            return `
            <tr>
              <td><strong>${o.id}</strong></td>
              <td>${o.shippingAddress?.fullname || o.customer || 'N/A'}</td>
              <td>${o.date}</td>
              <td style="font-weight:700;color:var(--primary)">${(
                  o.total || 0
              ).toLocaleString('vi-VN')}₫</td>
              <td><span class="badge">${o.status}</span></td>
              <td>${actionButtons}</td>
            </tr>
          `
                        })
                        .join('')
                }
            }

            function viewOrder(id) {
                const o = getOrders().find((x) => x.id === id)
                if (!o) return alert('❌ Không tìm thấy đơn hàng!')

                const customerName =
                    o.shippingAddress?.fullname || o.customer || 'N/A'
                const phone = o.shippingAddress?.phone || 'N/A'
                const address = o.shippingAddress
                    ? `${o.shippingAddress.street}, ${o.shippingAddress.district}, ${o.shippingAddress.city}`
                    : 'N/A'
                const items = o.items
                    ? o.items
                          .map(
                              (i) =>
                                  `  • ${i.title} x${i.quantity} = ${(
                                      i.price * i.quantity
                                  ).toLocaleString('vi-VN')}₫`
                          )
                          .join('\n')
                    : '  Không có sản phẩm'

                alert(`📦 CHI TIẾT ĐƠN HÀNG

🆔 Mã đơn: ${o.id}
📅 Ngày đặt: ${o.date}
💰 Tổng tiền: ${(o.total || 0).toLocaleString('vi-VN')}₫
📊 Trạng thái: ${o.status}

👤 THÔNG TIN KHÁCH HÀNG:
  Họ tên: ${customerName}
  SĐT: ${phone}
  Địa chỉ: ${address}

📦 SẢN PHẨM:
${items}`)
            }

            function processOrder(id) {
                const orders = getOrders()
                const o = orders.find((x) => x.id === id)
                if (!o) return alert('❌ Không tìm thấy đơn hàng!')

                // Không cho cập nhật khi đã hoàn thành
                if (o.status === 'Đã giao') {
                    return alert(
                        '⚠️ Đơn hàng đã hoàn thành! Không thể cập nhật trạng thái.'
                    )
                }

                if (o.status === 'Đã hủy') {
                    return alert(
                        '⚠️ Đơn hàng đã bị hủy! Không thể cập nhật trạng thái.'
                    )
                }

                const statuses = [
                    'Chưa xử lý',
                    'Đang xử lý',
                    'Đã gửi',
                    'Đã giao',
                ]
                const currentIdx = statuses.indexOf(o.status)
                const nextIdx = (currentIdx + 1) % statuses.length
                const nextStatus = statuses[nextIdx]

                if (
                    !confirm(
                        `📦 Chuyển trạng thái từ "${o.status}" → "${nextStatus}"?\n\nNếu là "Đang xử lý" sẽ tự trừ số lượng sản phẩm!`
                    )
                ) {
                    return
                }

                // Nếu chuyển sang "Đang xử lý" thì trừ số lượng sản phẩm (chỉ lần đầu)
                if (nextStatus === 'Đang xử lý' && o.status === 'Chưa xử lý') {
                    const products = getProducts()
                    let hasError = false
                    const itemsDetail = []

                    console.log('🔍 DEBUG: Bắt đầu xử lý đơn', id)
                    console.log(
                        '📦 DEBUG: Số lượng sản phẩm trong kho:',
                        products.length
                    )
                    console.log('📦 DEBUG: Items trong đơn:', o.items)

                    o.items.forEach((item) => {
                        console.log(`🔎 Tìm sản phẩm với ID: ${item.id}`)
                        const product = products.find((p) => p.id === item.id)
                        console.log(`✓ Tìm thấy:`, product)

                        if (product) {
                            if (product.stock === undefined) product.stock = 0
                            console.log(
                                `📊 Stock hiện tại: ${product.stock}, cần trừ: ${item.quantity}`
                            )

                            if (product.stock < item.quantity) {
                                alert(
                                    `❌ Sản phẩm "${item.title}" không đủ kho!\nCó: ${product.stock}, cần: ${item.quantity}`
                                )
                                hasError = true
                                return
                            }
                            const oldStock = product.stock
                            product.stock -= item.quantity
                            console.log(
                                `✅ Đã trừ: ${oldStock} → ${product.stock}`
                            )
                            itemsDetail.push(
                                `  ✓ ${item.title}: -${item.quantity} (${oldStock} → ${product.stock})`
                            )
                        } else {
                            console.log(
                                `❌ KHÔNG TÌM THẤY sản phẩm ID ${item.id}`
                            )
                            alert(`❌ Sản phẩm ID ${item.id} không tồn tại!`)
                            hasError = true
                        }
                    })

                    if (hasError) return

                    // Lưu lại số lượng sản phẩm
                    console.log('💾 Lưu products vào localStorage:', products)
                    saveProducts(products)

                    alert(
                        `✅ Chuyển trạng thái thành công!\n📦 Đã trừ khỏi kho:\n${itemsDetail.join(
                            '\n'
                        )}`
                    )
                } else if (
                    nextStatus === 'Đang xử lý' &&
                    o.status !== 'Chưa xử lý'
                ) {
                    alert(
                        '⚠️ Đơn hàng đã được xử lý rồi! Không thể trừ kho lần nữa.'
                    )
                } else {
                    alert(`✅ Trạng thái cập nhật: ${nextStatus}`)
                }

                // Cập nhật trạng thái đơn hàng
                o.status = nextStatus
                saveOrders(orders)
                console.log('✅ Đã cập nhật trạng thái đơn hàng')
                renderOrdersList()
            }

            function cancelOrderFromAdmin(id) {
                const orders = getOrders()
                const o = orders.find((x) => x.id === id)
                if (!o) return alert('❌ Không tìm thấy đơn hàng!')

                if (o.status === 'Đã hủy') {
                    return alert('⚠️ Đơn hàng này đã bị hủy rồi!')
                }

                if (o.status === 'Đã giao') {
                    return alert('⚠️ Đơn hàng đã hoàn thành! Không thể hủy.')
                }

                if (
                    !confirm(
                        `⚠️ Bạn chắc chắn muốn hủy đơn hàng ${id}?\n\n✅ Lưu ý: Số lượng sản phẩm sẽ KHÔNG bị trừ!`
                    )
                ) {
                    return
                }

                o.status = 'Đã hủy'
                saveOrders(orders)
                renderOrdersList()
                alert(
                    `❌ Đơn hàng ${id} đã được hủy.\n✅ Số lượng sản phẩm không bị trừ khỏi kho.`
                )
            }

            /* ===== USERS ===== */
            function renderUsersList() {
                const body = document.getElementById('usersBody')
                const users = getUsers()

                if (users.length === 0) {
                    body.innerHTML =
                        '<tr><td colspan="3" class="empty" style="text-align:center;padding:40px">👤 Chưa có người dùng nào</td></tr>'
                } else {
                    body.innerHTML = users
                        .map((u) => {
                            // Xử lý locked: chuyển đổi thành boolean để đảm bảo tính nhất quán
                            const isLocked =
                                u.locked === true || u.locked === 'true'
                            const identifier = u.email || u.username || 'N/A'
                            // Escape identifier để tránh lỗi khi có ký tự đặc biệt
                            const safeIdentifier = identifier.replace(
                                /'/g,
                                "\\'"
                            )

                            return `
          <tr>
            <td><strong>${identifier}</strong></td>
            <td>
              <span class="badge" style="background:${
                  isLocked ? '#fee2e2' : '#d1fae5'
              };color:${isLocked ? '#991b1b' : '#065f46'}">
                ${isLocked ? '🔒 Đã khóa' : '✅ Hoạt động'}
              </span>
            </td>
            <td>
              <button style="background:${
                  isLocked ? '#10b981' : '#f59e0b'
              };color:white;margin-right:6px" onclick="toggleLock('${safeIdentifier}')">
                ${isLocked ? '🔓 Mở khóa' : '🔒 Khóa'}
              </button>
              <button style="background:#ef4444;color:white" onclick="deleteUser('${safeIdentifier}')">🗑️ Xóa</button>
            </td>
          </tr>
        `
                        })
                        .join('')
                }
                updateStats()
            }

            function toggleLock(identifier) {
                const users = getUsers()
                const u = users.find(
                    (x) => x.email === identifier || x.username === identifier
                )
                if (!u) return alert('❌ Không tìm thấy người dùng!')

                // Đảm bảo locked là boolean và toggle giá trị
                // Xử lý các trường hợp: undefined, null, string 'true'/'false', boolean
                const currentLocked = u.locked === true || u.locked === 'true'
                u.locked = !currentLocked // Toggle: true -> false, false -> true

                console.log(
                    '✅ Toggling lock for:',
                    identifier,
                    'Old:',
                    currentLocked,
                    'New:',
                    u.locked
                )
                saveUsers(users)
                renderUsersList()
                alert(
                    u.locked
                        ? '🔒 Đã khóa tài khoản!'
                        : '🔓 Đã mở khóa tài khoản!'
                )
            }

            function deleteUser(identifier) {
                if (!confirm('❓ Bạn có chắc muốn xóa người dùng này?')) return

                const users = getUsers().filter(
                    (u) => u.email !== identifier && u.username !== identifier
                )
                saveUsers(users)
                renderUsersList()
                alert('✅ Đã xóa người dùng!')
            }

            /* ===== TAB SWITCHING ===== */
            function switchTab(name, el) {
                document
                    .querySelectorAll('.tab')
                    .forEach((t) => (t.style.display = 'none'))
                document.getElementById(name).style.display = 'block'

                document
                    .querySelectorAll('.nav-item')
                    .forEach((n) => n.classList.remove('active'))
                if (el) el.classList.add('active')

                // Render on demand
                if (name === 'dashboard') {
                    renderRecentOrders()
                    renderTopProducts()
                    updateStats()
                }
                if (name === 'products') {
                    renderProductsList()
                }
                if (name === 'orders') {
                    renderOrdersList()
                }
                if (name === 'users') {
                    renderUsersList()
                }
                if (name === 'pricing') {
                    renderPricingList()
                }
                if (name === 'import') {
                    renderImportList()
                    loadProductsToSelect()
                }

                window.scrollTo({ top: 0, behavior: 'smooth' })
            }

           /* ===== PRICING MANAGEMENT (Theo Sản Phẩm) ===== */
let editingPricingProductId = null

// Khởi tạo giá trị mặc định cho sản phẩm
function initializeProductPricing() {
    let products = getProducts()
    let hasChanges = false
    
    products.forEach(product => {
        if (!product.costPrice) {
            product.costPrice = product.price // Giá vốn = giá gốc
            hasChanges = true
        }
        if (product.profitPercent === undefined) {
            product.profitPercent = 30 // Mặc định 30% lợi nhuận
            hasChanges = true
        }
        if (!product.sellPrice) {
            product.sellPrice = Math.round(product.costPrice * (1 + product.profitPercent / 100))
            hasChanges = true
        }
    })
    
    if (hasChanges) {
        saveProducts(products)
    }
}

// Render thống kê giá
function renderPricingStats() {
    const products = getProducts()
    const totalProducts = products.length
    
    const avgProfit = products.length > 0 
        ? (products.reduce((sum, p) => sum + (p.profitPercent || 0), 0) / products.length).toFixed(1)
        : 0
    
    const totalProfitAmount = products.reduce((sum, p) => {
        const profit = (p.sellPrice || 0) - (p.costPrice || 0)
        return sum + profit
    }, 0)
    
    const avgProfitAmount = totalProducts > 0 ? Math.round(totalProfitAmount / totalProducts) : 0
    const highProfitCount = products.filter(p => (p.profitPercent || 0) > 40).length

    document.getElementById('avgProfit').textContent = avgProfit + '%'
    document.getElementById('avgProfitAmount').textContent = avgProfitAmount.toLocaleString('vi-VN') + ' ₫'
    document.getElementById('highProfitCount').textContent = highProfitCount
}

// Load categories vào filter
function loadPricingCategories() {
    const products = getProducts()
    const categories = [...new Set(products.map(p => p.category).filter(Boolean))]
    const select = document.getElementById('categoryFilterPricing')
    
    // Xóa các option cũ (giữ lại option đầu tiên)
    while(select.options.length > 1) {
        select.remove(1)
    }
    
    categories.forEach(cat => {
        const option = document.createElement('option')
        option.value = cat
        option.textContent = cat
        select.appendChild(option)
    })
}

// Lọc sản phẩm cho pricing
function getFilteredPricingProducts() {
    const products = getProducts()
    const searchTerm = (document.getElementById('searchPricing')?.value || '').toLowerCase()
    const categoryFilter = document.getElementById('categoryFilterPricing')?.value || ''
    const profitFilter = document.getElementById('profitFilterPricing')?.value || ''

    return products.filter(product => {
        const matchSearch = product.title.toLowerCase().includes(searchTerm) || 
                           product.id.toLowerCase().includes(searchTerm)
        const matchCategory = !categoryFilter || product.category === categoryFilter
        
        let matchProfit = true
        if (profitFilter === 'low') {
            matchProfit = (product.profitPercent || 0) < 20
        } else if (profitFilter === 'medium') {
            matchProfit = (product.profitPercent || 0) >= 20 && (product.profitPercent || 0) <= 40
        } else if (profitFilter === 'high') {
            matchProfit = (product.profitPercent || 0) > 40
        }

        return matchSearch && matchCategory && matchProfit
    })
}

// Render bảng pricing
function renderPricingTable() {
    const filteredProducts = getFilteredPricingProducts()
    const tbody = document.getElementById('pricingTableBody')
    
    if (filteredProducts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;color:#666">📭 Không tìm thấy sản phẩm nào</td></tr>'
        return
    }

    tbody.innerHTML = filteredProducts.map(product => {
        const costPrice = product.costPrice || product.price || 0
        const profitPercent = product.profitPercent || 0
        const sellPrice = product.sellPrice || costPrice
        const profitAmount = sellPrice - costPrice
        
        const profitBadgeColor = profitPercent > 40 ? 'background:#fef3c7;color:#92400e' : 'background:#d1fae5;color:#065f46'

        if (editingPricingProductId === product.id) {
            return `
                <tr style="background:#f8f9ff">
                    <td><strong>${product.id}</strong></td>
                    <td>${product.title}</td>
                    <td>${product.category || 'N/A'}</td>
                    <td>
                        <input type="number" id="cost-${product.id}" value="${costPrice}" min="0" 
                            style="width:100px;padding:6px;border:1px solid #667eea;border-radius:4px">
                    </td>
                    <td>
                        <div style="display:flex;align-items:center;gap:4px">
                            <input type="number" id="profit-${product.id}" value="${profitPercent}" min="0" max="1000" 
                                style="width:70px;padding:6px;border:1px solid #667eea;border-radius:4px"> %
                        </div>
                    </td>
                    <td><strong style="color:#667eea;font-size:15px">${sellPrice.toLocaleString('vi-VN')}₫</strong></td>
                    <td><strong style="color:#10b981">+${profitAmount.toLocaleString('vi-VN')}₫</strong></td>
                    <td>
                        <button onclick="savePricingProduct('${product.id}')" 
                            style="background:#10b981;color:white;padding:6px 12px;border:none;border-radius:6px;cursor:pointer;margin-right:4px">
                            💾 Lưu
                        </button>
                        <button onclick="cancelPricingEdit()" 
                            style="background:#6b7280;color:white;padding:6px 12px;border:none;border-radius:6px;cursor:pointer">
                            ❌
                        </button>
                    </td>
                </tr>
            `
        } else {
            return `
                <tr>
                    <td><strong>${product.id}</strong></td>
                    <td>${product.title}</td>
                    <td>${product.category || 'N/A'}</td>
                    <td><strong>${costPrice.toLocaleString('vi-VN')}₫</strong></td>
                    <td>
                        <span style="display:inline-block;padding:4px 12px;border-radius:12px;font-weight:600;font-size:13px;${profitBadgeColor}">
                            ${profitPercent}%
                        </span>
                    </td>
                    <td><strong style="color:#667eea;font-size:15px">${sellPrice.toLocaleString('vi-VN')}₫</strong></td>
                    <td><strong style="color:#10b981">+${profitAmount.toLocaleString('vi-VN')}₫</strong></td>
                    <td>
                        <button onclick="editPricingProduct('${product.id}')" 
                            style="background:#3b82f6;color:white;padding:6px 12px;border:none;border-radius:6px;cursor:pointer">
                            ✏️ Sửa giá
                        </button>
                    </td>
                </tr>
            `
        }
    }).join('')
}

// Chỉnh sửa giá sản phẩm
function editPricingProduct(productId) {
    editingPricingProductId = productId
    renderPricingTable()
}

// Lưu giá sản phẩm
function savePricingProduct(productId) {
    const costInput = document.getElementById(`cost-${productId}`)
    const profitInput = document.getElementById(`profit-${productId}`)
    
    if (!costInput || !profitInput) return

    const costPrice = parseFloat(costInput.value) || 0
    const profitPercent = parseFloat(profitInput.value) || 0
    const sellPrice = Math.round(costPrice * (1 + profitPercent / 100))

    let products = getProducts()
    const product = products.find(p => p.id === productId)
    
    if (product) {
        product.costPrice = costPrice
        product.profitPercent = profitPercent
        product.sellPrice = sellPrice
        product.price = sellPrice // Cập nhật giá hiển thị trên trang chính
        
        saveProducts(products)
        editingPricingProductId = null
        
        renderPricingStats()
        renderPricingTable()
        
        alert('✅ Đã cập nhật giá thành công!')
    }
}

// Hủy chỉnh sửa
function cancelPricingEdit() {
    editingPricingProductId = null
    renderPricingTable()
}

// Hàm render pricing list chính (được gọi từ switchTab)
function renderPricingList() {
    initializeProductPricing()
    loadPricingCategories()
    renderPricingStats()
    renderPricingTable()
}

/* ===== CHUYỂN TỪ TAB SẢN PHẨM SANG PRICING ===== */
function goToPricing(productId) {
    // Chuyển sang tab pricing
    switchTab('pricing', document.querySelector('[data-tab="pricing"]'))
    
    // Đợi một chút để tab được render
    setTimeout(() => {
        // Tìm sản phẩm và tự động mở chế độ chỉnh sửa
        const product = getProducts().find(p => p.id === productId)
        if (product) {
            // Clear filter để hiển thị sản phẩm
            document.getElementById('searchPricing').value = ''
            document.getElementById('categoryFilterPricing').value = ''
            document.getElementById('profitFilterPricing').value = ''
            
            // Render lại bảng
            renderPricingTable()
            
            // Tự động mở chế độ chỉnh sửa
            editingPricingProductId = productId
            renderPricingTable()
            
            // Scroll đến sản phẩm đó
            setTimeout(() => {
                const row = document.querySelector(`#pricingTableBody tr[style*="background:#f8f9ff"]`)
                if (row) {
                    row.scrollIntoView({ behavior: 'smooth', block: 'center' })
                    // Highlight effect
                    row.style.boxShadow = '0 0 20px rgba(102, 126, 234, 0.5)'
                    setTimeout(() => {
                        row.style.boxShadow = 'none'
                    }, 2000)
                }
            }, 100)
            
            // Hiển thị thông báo
            const notification = document.createElement('div')
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 10000;
                font-weight: 600;
                animation: slideIn 0.3s ease;
            `
            notification.innerHTML = `
                💲 Đang chỉnh sửa giá: <strong>${product.title}</strong>
            `
            document.body.appendChild(notification)
            
            // Tự động xóa notification sau 3 giây
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease'
                setTimeout(() => notification.remove(), 300)
            }, 3000)
        }
    }, 100)
}

// Thêm CSS animation cho notification
const styleAnimation = document.createElement('style')
styleAnimation.textContent = `
    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(400px);
            opacity: 0;
        }
    }
`
document.head.appendChild(styleAnimation)

            /* ===== IMPORT RECEIPTS MANAGEMENT ===== */
            const getImportReceipts = () =>
                JSON.parse(localStorage.getItem('bs_import_receipts') || '[]')
            const setImportReceipts = (r) =>
                localStorage.setItem('bs_import_receipts', JSON.stringify(r))

            function renderImportList() {
                const receipts = getImportReceipts()
                const tbody = document.querySelector('#importBody')
                tbody.innerHTML = receipts
                    .map(
                        (r) => `
        <tr>
          <td>${r.date}</td>
          <td>${r.productId}</td>
          <td>${r.quantity}</td>
          <td>${r.price.toLocaleString('vi-VN')} ₫</td>
          <td>${(r.quantity * r.price).toLocaleString('vi-VN')} ₫</td>
          <td><span class="badge" style="background:${
              r.status === 'Chưa vào kho' ? '#fff3e0' : '#e8f5e9'
          };color:${r.status === 'Chưa vào kho' ? '#a65a00' : '#2e7d32'}">${
                            r.status === 'Chưa vào kho'
                                ? '⏳ Chưa vào kho'
                                : '✅ Đã nhập kho'
                        }</span></td>
          <td>
            ${
                r.status === 'Chưa vào kho'
                    ? `<button onclick="editImport('${r.id}')" style="background:#3b82f6;color:white;padding:6px 12px;margin-right:6px">✏️</button><button onclick="completeImport('${r.id}')" style="background:#4CAF50;color:white;padding:6px 12px;margin-right:6px">✅</button>`
                    : ''
            }
            <button onclick="deleteImport('${
                r.id
            }')" style="background:#ff6b6b;color:white;padding:6px 12px">🗑️</button>
          </td>
        </tr>
      `
                    )
                    .join('')
                if (!receipts.length)
                    tbody.innerHTML =
                        '<tr><td colspan="7" style="text-align:center;color:#666">Chưa có phiếu nhập</td></tr>'
            }

            function saveImportReceipt() {
    const date = document.getElementById('importDate').value
    const productId = document
        .getElementById('importProductId')
        .value.trim()
    const quantity = parseInt(
        document.getElementById('importQuantity').value
    )
    const price = parseInt(
        document.getElementById('importPrice').value
    )
    const id = document.getElementById('importId').value
    
    // ✅ VALIDATION CƠ BẢN
    if (!date || !productId || !quantity || !price) {
        alert('❌ Vui lòng điền đầy đủ thông tin!')
        return
    }
    
    // ✅ KIỂM TRA SẢN PHẨM CÓ TỒN TẠI KHÔNG
    const products = getProducts()
    const product = products.find((p) => p.id === productId)
    
    if (!product) {
        alert(
            `❌ KHÔNG TÌM THẤY SẢN PHẨM!\n\n` +
            `ID bạn nhập: "${productId}"\n\n` +
            `Vui lòng:\n` +
            `1. Kiểm tra lại ID sản phẩm (VD: b001, b002...)\n` +
            `2. Đảm bảo sản phẩm đã được tạo trong tab "Sản phẩm"\n` +
            `3. Nhập đúng chữ hoa/thường (phân biệt b001 ≠ B001)`
        )
        return
    }
    
    const receipts = getImportReceipts()
    const dateObj = new Date(date)
    const formattedDate = dateObj.toLocaleDateString('vi-VN')
    
    const newReceipt = {
        id: id || 'imp' + Date.now(),
        date: formattedDate,
        productId,
        quantity,
        price,
        status: 'Chưa vào kho',
    }
    
    if (id) {
        // EDIT MODE
        const idx = receipts.findIndex((r) => r.id === id)
        if (idx >= 0 && receipts[idx].status === 'Đã nhập kho') {
            alert('❌ Phiếu đã hoàn thành không thể sửa!')
            return
        }
        if (idx >= 0) {
            receipts[idx] = newReceipt
            alert(
                `✅ Cập nhật phiếu nhập thành công!\n\n` +
                `📦 Sản phẩm: ${product.title}\n` +
                `📊 Số lượng: ${quantity} cái\n` +
                `💰 Giá nhập: ${price.toLocaleString('vi-VN')} ₫/cái\n` +
                `💵 Tổng: ${(quantity * price).toLocaleString('vi-VN')} ₫\n\n` +
                `⚠️ Chưa vào kho - Nhấn "✅" để hoàn thành`
            )
        }
    } else {
        // CREATE MODE
        receipts.push(newReceipt)
        alert(
            `✅ Tạo phiếu nhập thành công!\n\n` +
            `📦 Sản phẩm: ${product.title} (ID: ${productId})\n` +
            `📊 Số lượng: ${quantity} cái\n` +
            `💰 Giá nhập: ${price.toLocaleString('vi-VN')} ₫/cái\n` +
            `💵 Tổng giá trị: ${(quantity * price).toLocaleString('vi-VN')} ₫\n\n` +
            `⏳ Trạng thái: Chưa vào kho\n` +
            `💡 Nhấn nút "✅" để hoàn thành và cộng vào kho`
        )
    }
    
    setImportReceipts(receipts)
    resetImportForm()
    renderImportList()
}
            function editImport(id) {
                const receipts = getImportReceipts()
                const receipt = receipts.find((r) => r.id === id)
                if (receipt && receipt.status === 'Đã nhập kho')
                    return alert('❌ Phiếu đã hoàn thành!')
                if (receipt) {
                    document.getElementById('importId').value = receipt.id
                    const [day, month, year] = receipt.date.split('/')
                    document.getElementById(
                        'importDate'
                    ).value = `${year}-${month}-${day}`
                    document.getElementById('importProductId').value =
                        receipt.productId
                    document.getElementById('importQuantity').value =
                        receipt.quantity
                    document.getElementById('importPrice').value = receipt.price
                }
            }

            function loadProductsToSelect() {
    const products = getProducts()
    const select = document.getElementById('importProductSelect')
    
    if (!select) return
    
    // Xóa các option cũ (giữ lại option đầu tiên)
    while(select.options.length > 1) {
        select.remove(1)
    }
    
    // Thêm các sản phẩm
    products.forEach(product => {
        const option = document.createElement('option')
        option.value = product.id
        option.textContent = `${product.id} - ${product.title} (Tồn: ${product.stock || 0})`
        select.appendChild(option)
    })
}

// Hàm điền ID khi chọn từ dropdown
function fillProductId(productId) {
    const input = document.getElementById('importProductId')
    if (input && productId) {
        input.value = productId
        
        // Hiển thị thông tin sản phẩm
        const products = getProducts()
        const product = products.find(p => p.id === productId)
        if (product) {
            // Tạo notification nhỏ
            const notification = document.createElement('div')
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-size: 14px;
            `
            notification.innerHTML = `
                ✅ Đã chọn: <strong>${product.title}</strong><br>
                <small>Tồn kho hiện tại: ${product.stock || 0} cái</small>
            `
            document.body.appendChild(notification)
            
            // Tự động xóa sau 2 giây
            setTimeout(() => notification.remove(), 2000)
        }
    }
}


    function completeImport(id) {
    if (
        !confirm(
            'Hoàn thành phiếu? (Sẽ cộng số lượng vào kho sản phẩm)'
        )
    )
        return
    const receipts = getImportReceipts()
    const receipt = receipts.find((r) => r.id === id)
    
    if (receipt && receipt.status === 'Chưa vào kho') {
        // ✅ KIỂM TRA SẢN PHẨM CÓ TỒN TẠI KHÔNG
        const products = getProducts()
        const product = products.find(
            (p) => p.id === receipt.productId
        )

        if (!product) {
            alert(
                `❌ Không tìm thấy sản phẩm với ID: "${receipt.productId}"!\n\n` +
                `Vui lòng kiểm tra lại:\n` +
                `- ID sản phẩm có đúng không?\n` +
                `- Sản phẩm đã được tạo trong hệ thống chưa?`
            )
            return
        }

        // ✅ CỘNG SỐ LƯỢNG VÀO KHO
        if (product.stock === undefined) product.stock = 0
        const oldStock = product.stock
        product.stock += receipt.quantity
        saveProducts(products)

        // ✅ CẬP NHẬT TRẠNG THÁI PHIẾU
        receipt.status = 'Đã nhập kho'
        setImportReceipts(receipts)
        
        // ✅ RENDER LẠI
        renderImportList()
        
        // Render lại danh sách sản phẩm nếu đang ở tab products
        const activeTab = document.querySelector('.tab:not([style*="display: none"])')
        if (activeTab && activeTab.id === 'products') {
            renderProductsList()
        }
        
        alert(
            `✅ Phiếu nhập đã hoàn thành!\n\n` +
            `📦 Sản phẩm: ${product.title} (ID: ${receipt.productId})\n` +
            `➕ Nhập: ${receipt.quantity} cái\n` +
            `📊 Tồn kho: ${oldStock} → ${product.stock} cái\n` +
            `💰 Tổng giá trị: ${(receipt.quantity * receipt.price).toLocaleString('vi-VN')} ₫`
        )
    }
}
            function deleteImport(id) {
                if (confirm('Xóa phiếu?')) {
                    let receipts = getImportReceipts()
                    receipts = receipts.filter((r) => r.id !== id)
                    setImportReceipts(receipts)
                    renderImportList()
                }
            }

            function resetImportForm() {
                document.getElementById('importForm').reset()
                document.getElementById('importId').value = ''
                const today = new Date().toISOString().split('T')[0]
                document.getElementById('importDate').value = today
            }

            /* ===== LOGOUT ===== */
            function logout() {
                if (confirm('❓ Bạn có chắc muốn đăng xuất?')) {
                    localStorage.removeItem('bs_admin_session')
                    localStorage.removeItem('bs_auth')
                    sessionStorage.removeItem('bs_auth')
                    window.location.href = 'index.html'
                }
            }

            /* ===== EXPORT DATA ===== */
            function exportData() {
                const data = {
                    products: getProducts(),
                    orders: getOrders(),
                    users: getUsers().map((u) => ({ ...u, password: '***' })), // Ẩn password
                    exportDate: new Date().toISOString(),
                }

                const json = JSON.stringify(data, null, 2)
                const blob = new Blob([json], { type: 'application/json' })
                const url = URL.createObjectURL(blob)
                const a = document.createElement('a')
                a.href = url
                a.download = `bookstore-backup-${Date.now()}.json`
                a.click()
                URL.revokeObjectURL(url)

                alert('✅ Đã xuất dữ liệu thành công!')
            }

            /* ===== INIT ===== */
            ;(async function init() {
                // Check admin auth
                const adminAuth = localStorage.getItem('bs_admin_session')
                if (!adminAuth) {
                    alert('⚠️ Vui lòng đăng nhập với tài khoản admin!')
                    window.location.href = 'admin-login.html'
                    return
                }

                // Seed data
                await seedData()

                // Initial render
                updateStats()
                renderRecentOrders()
                renderTopProducts()
                renderProductsList()
                renderOrdersList()
                renderUsersList()

                console.log('✅ Admin panel loaded successfully!')
                console.log('📊 Stats:', {
                    products: getProducts().length,
                    orders: getOrders().length,
                    users: getUsers().length,
                })
            })()
        </script>
    </body>
</html>
