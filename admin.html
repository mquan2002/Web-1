<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>BookStore Admin</title>
        <link rel="stylesheet" href="css/admin.css" />
    </head>
    <body>
        <header class="topbar">
            <div class="brand">
                <div class="logo">B</div>
                <div>BookStore Admin</div>
            </div>

            <nav class="navlist" aria-label="Main navigation">
                <div
                    class="nav-item active"
                    data-tab="dashboard"
                    onclick="switchTab('dashboard', this)"
                >
                    🏠 Dashboard
                </div>
                <div
                    class="nav-item"
                    data-tab="products"
                    onclick="switchTab('products', this)"
                >
                    📚 Sản phẩm
                </div>
                <div
                    class="nav-item"
                    data-tab="orders"
                    onclick="switchTab('orders', this)"
                >
                    🧾 Đơn hàng
                </div>
                <div
                    class="nav-item"
                    data-tab="users"
                    onclick="switchTab('users', this)"
                >
                    👥 Người dùng
                </div>
                <div
                    class="nav-item"
                    data-tab="import"
                    onclick="switchTab('import', this)"
                >
                    📦 Nhập hàng
                </div>
                <div
                    class="nav-item"
                    data-tab="pricing"
                    onclick="switchTab('pricing', this)"
                >
                    💲 Giá bán
                </div>
            </nav>

            <div class="top-actions">
                <div class="btn-pill">Admin</div>
                <div class="btn-pill" onclick="logout()">Đăng xuất</div>
            </div>
        </header>

        <main class="container">
            <!-- DASHBOARD -->
            <section id="dashboard" class="tab">
                <h1 class="page-title">📊 Dashboard</h1>

                <div class="stats-grid" id="statsGrid">
                    <div class="card">
                        <div class="icon">📚</div>
                        <div class="meta">
                            <div class="label">Tổng sản phẩm</div>
                            <div class="value" id="statProducts">0</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="icon">💰</div>
                        <div class="meta">
                            <div class="label">Doanh thu</div>
                            <div class="value" id="statRevenue">0 ₫</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="icon">🛒</div>
                        <div class="meta">
                            <div class="label">Đơn hàng</div>
                            <div class="value" id="statOrders">0</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="icon">👥</div>
                        <div class="meta">
                            <div class="label">Người dùng</div>
                            <div class="value" id="statUsers">0</div>
                        </div>
                    </div>
                </div>

                <div class="panel" style="margin-bottom: 22px">
                    <div
                        style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 12px;
                        "
                    >
                        <div class="section-title">⚡ Thao tác nhanh</div>
                        <div style="color: var(--muted); font-size: 14px">
                            Thêm, xem hoặc báo cáo nhanh
                        </div>
                    </div>
                    <div class="quick-grid">
                        <div
                            class="quick"
                            onclick="switchTab('products', document.querySelector('[data-tab=products]'))"
                        >
                            <div class="big">➕</div>
                            <div>Thêm sản phẩm</div>
                        </div>
                        <div
                            class="quick"
                            onclick="switchTab('orders', document.querySelector('[data-tab=orders]'))"
                        >
                            <div class="big">📦</div>
                            <div>Xem đơn hàng</div>
                        </div>
                        <div
                            class="quick"
                            onclick="switchTab('users', document.querySelector('[data-tab=users]'))"
                        >
                            <div class="big">👥</div>
                            <div>Quản lý người dùng</div>
                        </div>
                        <div class="quick" onclick="exportData()">
                            <div class="big">📈</div>
                            <div>Xuất dữ liệu</div>
                        </div>
                    </div>
                </div>

                <div class="panel" style="margin-bottom: 18px">
                    <div
                        style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 12px;
                        "
                    >
                        <div class="section-title">🛒 Đơn hàng gần đây</div>
                        <div
                            style="color: teal; cursor: pointer"
                            onclick="switchTab('orders', document.querySelector('[data-tab=orders]'))"
                        >
                            Xem tất cả →
                        </div>
                    </div>
                    <table class="table" id="recentOrdersTable">
                        <thead>
                            <tr>
                                <th>Mã đơn</th>
                                <th>Khách hàng</th>
                                <th>Ngày đặt</th>
                                <th>Tổng tiền</th>
                                <th>Trạng thái</th>
                            </tr>
                        </thead>
                        <tbody id="recentOrdersBody"></tbody>
                    </table>
                </div>

                <div class="panel">
                    <div
                        style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 12px;
                        "
                    >
                        <div class="section-title">🔥 Sản phẩm bán chạy</div>
                        <div
                            style="color: teal; cursor: pointer"
                            onclick="switchTab('products', document.querySelector('[data-tab=products]'))"
                        >
                            Xem tất cả →
                        </div>
                    </div>
                    <div id="topProducts" style="min-height: 120px"></div>
                </div>
            </section>

            <!-- PRODUCTS -->
            <section id="products" class="tab" style="display: none">
                <h1 class="page-title">📚 Quản lý sản phẩm</h1>

                <div class="panel" style="margin-bottom: 18px">
                    <div class="section-title">➕ Thêm/Sửa sản phẩm</div>
                    <form id="productForm" onsubmit="return false">
                        <input type="hidden" id="productId" />

                        <div class="form-row">
                            <div class="form-group">
                                <label>Tiêu đề *</label>
                                <input
                                    id="productTitle"
                                    placeholder="Nhập tên sách"
                                    required
                                />
                            </div>
                            <div class="form-group">
                                <label>Tác giả</label>
                                <input
                                    id="productAuthor"
                                    placeholder="Tên tác giả"
                                />
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Giá (VNĐ) *</label>
                                <input
                                    id="productPrice"
                                    type="number"
                                    placeholder="0"
                                    required
                                />
                            </div>
                            <div class="form-group">
                                <label>Số lượng tồn kho *</label>
                                <input
                                    id="productStock"
                                    type="number"
                                    placeholder="0"
                                    min="0"
                                    required
                                />
                            </div>
                            <div class="form-group">
                                <label>Thể loại</label>
                                <input
                                    id="productCategory"
                                    placeholder="VD: Văn học, Công nghệ..."
                                />
                            </div>
                        </div>

                        <div class="form-group">
                            <label>URL ảnh bìa</label>
                            <input
                                id="productImage"
                                placeholder="https://example.com/image.jpg"
                            />
                        </div>

                        <div class="form-group">
                            <label>Mô tả</label>
                            <textarea
                                id="productDesc"
                                rows="3"
                                placeholder="Mô tả ngắn về sách..."
                            ></textarea>
                        </div>

                        <div style="display: flex; gap: 10px">
                            <button
                                style="
                                    background: var(--primary);
                                    color: white;
                                    flex: 1;
                                "
                                onclick="saveProduct()"
                            >
                                💾 Lưu sản phẩm
                            </button>
                            <button
                                style="background: #e5e7eb; color: #374151"
                                onclick="clearProductForm()"
                            >
                                🔄 Xóa form
                            </button>
                        </div>
                    </form>
                </div>

                <div class="panel">
                    <div
                        style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 12px;
                            flex-wrap: wrap;
                            gap: 12px;
                        "
                    >
                        <div class="section-title">📋 Danh sách sản phẩm</div>
                        <div style="display: flex; gap: 8px">
                            <input
                                id="searchProd"
                                placeholder="🔍 Tìm kiếm (ID, tên, tác giả)..."
                                style="
                                    width: 300px;
                                    padding: 8px;
                                    border: 1px solid #eef3f6;
                                    border-radius: 8px;
                                "
                                oninput="renderProductsList()"
                            />
                        </div>
                    </div>

                    <table class="table" id="productsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tiêu đề</th>
                                <th>Tác giả</th>
                                <th>Giá</th>
                                <th>Số lượng</th>
                                <th>Thể loại</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="productsBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- ORDERS -->
            <section id="orders" class="tab" style="display: none">
                <h1 class="page-title">🧾 Quản lý đơn hàng</h1>
                <div class="panel">
                    <div
                        style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 12px;
                            flex-wrap: wrap;
                            gap: 12px;
                        "
                    >
                        <div class="section-title">📦 Danh sách đơn hàng</div>
                        <div>
                            <input
                                id="searchOrder"
                                placeholder="🔍 Tìm mã đơn/khách"
                                style="
                                    padding: 8px;
                                    border: 1px solid #eef3f6;
                                    border-radius: 8px;
                                    width: 200px;
                                "
                                oninput="renderOrdersList()"
                            />
                        </div>
                    </div>

                    <table class="table">
                        <thead>
                            <tr>
                                <th>Mã đơn</th>
                                <th>Khách hàng</th>
                                <th>Ngày</th>
                                <th>Tổng tiền</th>
                                <th>Trạng thái</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="ordersBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- USERS -->
            <section id="users" class="tab" style="display: none">
                <h1 class="page-title">👥 Quản lý người dùng</h1>
                <div class="panel">
                    <div
                        style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 12px;
                        "
                    >
                        <div class="section-title">👤 Danh sách người dùng</div>
                    </div>

                    <table class="table">
                        <thead>
                            <tr>
                                <th>Email/Username</th>
                                <th>Trạng thái</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="usersBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- PRICING -->
            <section id="pricing" class="tab" style="display: none">
                <h1 class="page-title">💲 Quản lý bảng giá</h1>

                <div class="panel" style="margin-bottom: 18px">
                    <div class="section-title">➕ Thêm/Sửa mức giá</div>
                    <form id="pricingForm" onsubmit="return false">
                        <input type="hidden" id="pricingId" />
                        <div class="form-row">
                            <div class="form-group">
                                <label>Tên mức giá:</label>
                                <input
                                    type="text"
                                    id="pricingName"
                                    placeholder="VD: Giá bình thường, Giá khuyến mãi..."
                                    required
                                />
                            </div>
                            <div class="form-group">
                                <label>Phần trăm chiết khấu (%):</label>
                                <input
                                    type="number"
                                    id="pricingDiscount"
                                    placeholder="0-100"
                                    min="0"
                                    max="100"
                                    value="0"
                                    required
                                />
                            </div>
                            <div class="form-group">
                                <label>Mô tả:</label>
                                <input
                                    type="text"
                                    id="pricingDesc"
                                    placeholder="Mô tả mức giá này"
                                />
                            </div>
                        </div>
                        <button
                            type="button"
                            onclick="savePricingForm()"
                            style="background: teal; color: white; width: 200px"
                        >
                            💾 Lưu mức giá
                        </button>
                        <button
                            type="button"
                            onclick="resetPricingForm()"
                            style="background: #ddd; width: 200px"
                        >
                            Xóa form
                        </button>
                    </form>
                </div>

                <div class="panel">
                    <div class="section-title">📋 Danh sách bảng giá</div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Tên</th>
                                <th>Chiết khấu</th>
                                <th>Mô tả</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="pricingBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- IMPORT -->
            <section id="import" class="tab" style="display: none">
                <h1 class="page-title">📦 Nhập hàng / Quản lý phiếu nhập</h1>

                <div class="panel" style="margin-bottom: 18px">
                    <div class="section-title">
                        ➕ Thêm / Hoàn thành Phiếu Nhập
                    </div>
                    <form id="importForm" onsubmit="return false">
                        <input type="hidden" id="importId" />
                        <div class="form-row">
                            <div class="form-group">
                                <label>Ngày nhập (dd/mm/yyyy):</label>
                                <input type="date" id="importDate" required />
                            </div>
                            <div class="form-group">
                                <label>ID Sản phẩm (VD: b001, b002...):</label>
                                <input
                                    type="text"
                                    id="importProductId"
                                    placeholder="b001"
                                    required
                                />
                            </div>
                            <div class="form-group">
                                <label>Số lượng nhập:</label>
                                <input
                                    type="number"
                                    id="importQuantity"
                                    placeholder="0"
                                    min="1"
                                    required
                                />
                            </div>
                            <div class="form-group">
                                <label>Giá nhập (VNĐ) / 1 sản phẩm:</label>
                                <input
                                    type="number"
                                    id="importPrice"
                                    placeholder="0"
                                    min="0"
                                    required
                                />
                            </div>
                        </div>
                        <button
                            type="button"
                            onclick="saveImportReceipt()"
                            style="background: teal; color: white; width: 200px"
                        >
                            📥 Lưu / Hoàn thành phiếu kho
                        </button>
                        <button
                            type="button"
                            onclick="resetImportForm()"
                            style="background: #ddd; width: 200px"
                        >
                            🗑️ Xóa form
                        </button>
                        <div
                            style="
                                margin-top: 12px;
                                padding: 12px;
                                background: #e8f5e9;
                                border-radius: 8px;
                                color: #2e7d32;
                                font-size: 14px;
                            "
                        >
                            <strong>💡 Hướng dẫn:</strong>
                            <ul style="margin: 8px 0 0 20px">
                                <li>
                                    Bước 1: Điền thông tin và nhấn "Lưu" → Tạo
                                    phiếu nhập (chưa vào kho)
                                </li>
                                <li>
                                    Bước 2: Nhấn "✅ Sửa" → Kiểm tra lại → Nhấn
                                    "Lưu" → Số lượng tự động cộng vào kho
                                </li>
                                <li>
                                    Lưu ý: Phiếu đã hoàn thành không thể sửa!
                                </li>
                            </ul>
                        </div>
                    </form>
                </div>

                <div class="panel">
                    <div class="section-title">📋 Danh sách Phiếu Nhập</div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Ngày nhập</th>
                                <th>ID Sản phẩm</th>
                                <th>Số lượng</th>
                                <th>Giá nhập</th>
                                <th>Tổng tiền</th>
                                <th>Trạng thái</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="importBody"></tbody>
                    </table>
                </div>
            </section>
        </main>

        <script>
            /* ===== STORAGE HELPERS ===== */
            const getProducts = () =>
                JSON.parse(localStorage.getItem('bs_products') || '[]')
            const saveProducts = (arr) =>
                localStorage.setItem('bs_products', JSON.stringify(arr))
            const getOrders = () =>
                JSON.parse(localStorage.getItem('orders') || '[]')
            const saveOrders = (arr) =>
                localStorage.setItem('orders', JSON.stringify(arr))
            const getUsers = () =>
                JSON.parse(localStorage.getItem('bs_users') || '[]')
            const saveUsers = (arr) =>
                localStorage.setItem('bs_users', JSON.stringify(arr))
            const getCategories = () =>
                JSON.parse(localStorage.getItem('bs_categories') || '[]')
            const saveCategories = (arr) =>
                localStorage.setItem('bs_categories', JSON.stringify(arr))

            /* ===== SEED DATA ===== */
            async function seedData() {
                // Load products từ books.json nếu chưa có
                if (getProducts().length === 0) {
                    try {
                        const res = await fetch('data/books.json')
                        const books = await res.json()
                        // Thêm stock mặc định cho mỗi sản phẩm
                        books.forEach((book) => {
                            if (book.stock === undefined) book.stock = 100
                        })
                        saveProducts(books)
                        console.log(
                            '✅ Đã load',
                            books.length,
                            'sản phẩm từ books.json'
                        )
                    } catch (e) {
                        console.warn(
                            '⚠️ Không load được books.json, sử dụng dữ liệu mẫu'
                        )
                        const sampleProducts = [
                            {
                                id: 'b001',
                                title: 'Atomic Habits',
                                author: 'James Clear',
                                price: 195000,
                                stock: 100,
                                category: 'Phát triển bản thân',
                                cover: 'https://images.unsplash.com/photo-1515378791036-0648a3ef77b2?w=800',
                                desc: 'Cẩm nang thay đổi thói quen hiệu quả',
                            },
                            {
                                id: 'b002',
                                title: 'Clean Code',
                                author: 'Robert C. Martin',
                                price: 250000,
                                stock: 50,
                                category: 'Công nghệ',
                                cover: 'https://images.unsplash.com/photo-1518770660439-4636190af475?w=800',
                                desc: 'Nguyên tắc viết code sạch',
                            },
                            {
                                id: 'b003',
                                title: 'Sapiens',
                                author: 'Yuval Noah Harari',
                                price: 180000,
                                stock: 75,
                                category: 'Lịch sử',
                                cover: 'https://images.unsplash.com/photo-1457369804613-52c61a468e7d?w=800',
                                desc: 'Lược sử loài người',
                            },
                        ]
                        saveProducts(sampleProducts)
                    }
                }

                // Load users từ users.json nếu chưa có
                if (getUsers().length === 0) {
                    try {
                        const res = await fetch('data/users.json')
                        const users = await res.json()
                        // Đảm bảo mỗi user có thuộc tính locked (boolean)
                        users.forEach((user) => {
                            if (
                                user.locked === undefined ||
                                user.locked === null
                            ) {
                                user.locked = false
                            } else {
                                // Chuyển đổi string/truthy thành boolean
                                user.locked =
                                    user.locked === true ||
                                    user.locked === 'true'
                            }
                        })
                        saveUsers(users)
                        console.log(
                            '✅ Đã load',
                            users.length,
                            'người dùng từ users.json'
                        )
                    } catch (e) {
                        console.warn(
                            '⚠️ Không load được users.json, bỏ qua (users sẽ được tạo khi đăng ký)'
                        )
                    }
                }

                // Load categories từ categories.json nếu chưa có
                if (getCategories().length === 0) {
                    try {
                        const res = await fetch('data/categories.json')
                        const categories = await res.json()
                        saveCategories(categories)
                        console.log(
                            '✅ Đã load',
                            categories.length,
                            'danh mục từ categories.json'
                        )
                    } catch (e) {
                        console.warn(
                            '⚠️ Không load được categories.json, bỏ qua (categories có thể được tạo thủ công)'
                        )
                    }
                }
            }

            /* ===== DASHBOARD ===== */
            function updateStats() {
                const products = getProducts()
                const orders = getOrders()
                const users = getUsers()

                document.getElementById('statProducts').textContent =
                    products.length

                const revenue = orders.reduce((s, o) => s + (o.total || 0), 0)
                document.getElementById('statRevenue').textContent =
                    revenue.toLocaleString('vi-VN') + ' ₫'

                document.getElementById('statOrders').textContent =
                    orders.length
                document.getElementById('statUsers').textContent = users.length
            }

            function renderRecentOrders() {
                const rows = document.getElementById('recentOrdersBody')
                const orders = getOrders().slice().reverse().slice(0, 5)

                if (orders.length === 0) {
                    rows.innerHTML =
                        '<tr><td colspan="5" class="empty" style="text-align:center;padding:40px">📭 Chưa có đơn hàng nào</td></tr>'
                    return
                }

                rows.innerHTML = orders
                    .map(
                        (o) => `
        <tr>
          <td><strong>${o.id}</strong></td>
          <td>${o.shippingAddress?.fullname || o.customer || 'N/A'}</td>
          <td>${o.date}</td>
          <td style="font-weight:700;color:var(--primary)">${o.total.toLocaleString(
              'vi-VN'
          )}₫</td>
          <td><span class="badge">${o.status}</span></td>
        </tr>
      `
                    )
                    .join('')
            }

            function renderTopProducts() {
                const el = document.getElementById('topProducts')
                const products = getProducts()

                if (products.length === 0) {
                    el.innerHTML =
                        '<div class="empty"><div style="font-size:50px">📚</div><div style="margin-top:12px">Chưa có sản phẩm nào</div></div>'
                    return
                }

                el.innerHTML =
                    '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:14px">' +
                    products
                        .slice(0, 4)
                        .map(
                            (p) => `
        <div style="background:#fff;border-radius:10px;padding:14px;display:flex;gap:12px;align-items:center;box-shadow:0 4px 12px rgba(9,40,58,0.04);border:1px solid #f0f4f6">
          <img src="${p.cover || p.image}" alt="${
                                p.title
                            }" style="width:50px;height:70px;object-fit:cover;border-radius:6px" onerror="this.src='https://via.placeholder.com/50x70?text=📖'">
          <div style="flex:1">
            <div style="font-weight:700;font-size:0.95rem;margin-bottom:4px">${
                p.title
            }</div>
            <div style="color:var(--muted);font-size:0.85rem;margin-bottom:6px">${
                p.author
            }</div>
            <div style="font-weight:700;color:var(--primary)">${(
                p.price || 0
            ).toLocaleString('vi-VN')} ₫</div>
          </div>
        </div>
      `
                        )
                        .join('') +
                    '</div>'
            }

            /* ===== PRODUCTS ===== */
            function renderProductsList() {
                const q = (
                    document.getElementById('searchProd')?.value || ''
                ).toLowerCase()
                const body = document.getElementById('productsBody')
                const products = getProducts().filter(
                    (p) =>
                        p.title.toLowerCase().includes(q) ||
                        (p.author || '').toLowerCase().includes(q) ||
                        (p.category || '').toLowerCase().includes(q) ||
                        (p.id || '').toLowerCase().includes(q)
                )

                if (products.length === 0) {
                    body.innerHTML =
                        '<tr><td colspan="7" class="empty" style="text-align:center;padding:40px">📭 Không tìm thấy sản phẩm</td></tr>'
                } else {
                    body.innerHTML = products
                        .map((p) => {
                            const stock = p.stock !== undefined ? p.stock : 0
                            const stockColor =
                                stock === 0
                                    ? 'color:#ef4444'
                                    : stock < 10
                                    ? 'color:#f59e0b'
                                    : 'color:#10b981'
                            return `
          <tr>
            <td><strong>${p.id}</strong></td>
            <td>${p.title}</td>
            <td>${p.author || ''}</td>
            <td style="font-weight:700;color:var(--primary)">${(
                p.price || 0
            ).toLocaleString('vi-VN')}₫</td>
            <td style="font-weight:700;${stockColor}">${stock}</td>
            <td>${p.category || ''}</td>
            <td>
              <button style="background:#3b82f6;color:white;margin-right:6px" onclick="editProduct('${
                  p.id
              }')">✏️ Sửa</button>
              <button style="background:#ef4444;color:white" onclick="removeProduct('${
                  p.id
              }')">🗑️ Xóa</button>
            </td>
          </tr>
        `
                        })
                        .join('')
                }
                updateStats()
            }

            function saveProduct() {
                const id =
                    document.getElementById('productId').value ||
                    'b' + Date.now()
                const title = document
                    .getElementById('productTitle')
                    .value.trim()

                if (!title) {
                    alert('❌ Vui lòng nhập tiêu đề sản phẩm!')
                    return
                }

                const stock = parseInt(
                    document.getElementById('productStock').value
                )
                if (isNaN(stock) || stock < 0) {
                    alert('❌ Vui lòng nhập số lượng tồn kho hợp lệ (>= 0)!')
                    return
                }

                const product = {
                    id: id,
                    title: title,
                    author: document
                        .getElementById('productAuthor')
                        .value.trim(),
                    price:
                        parseInt(
                            document.getElementById('productPrice').value
                        ) || 0,
                    stock: stock,
                    category: document
                        .getElementById('productCategory')
                        .value.trim(),
                    cover:
                        document.getElementById('productImage').value.trim() ||
                        'https://via.placeholder.com/100x150?text=📖',
                    image:
                        document.getElementById('productImage').value.trim() ||
                        'https://via.placeholder.com/100x150?text=📖',
                    desc: document.getElementById('productDesc').value.trim(),
                }

                let products = getProducts()
                const idx = products.findIndex((p) => p.id === id)

                if (idx >= 0) {
                    products[idx] = product
                    alert('✅ Cập nhật sản phẩm thành công!')
                } else {
                    products.push(product)
                    alert('✅ Thêm sản phẩm thành công!')
                }

                saveProducts(products)
                clearProductForm()

                // Auto reload
                renderProductsList()
                renderTopProducts()
                updateStats()
            }

            function clearProductForm() {
                document.getElementById('productForm').reset()
                document.getElementById('productId').value = ''
                document.getElementById('productStock').value = '0'
            }

            function editProduct(id) {
                const p = getProducts().find((x) => x.id === id)
                if (!p) return

                document.getElementById('productId').value = p.id
                document.getElementById('productTitle').value = p.title
                document.getElementById('productAuthor').value = p.author || ''
                document.getElementById('productPrice').value = p.price || 0
                document.getElementById('productStock').value =
                    p.stock !== undefined ? p.stock : 0
                document.getElementById('productCategory').value =
                    p.category || ''
                document.getElementById('productImage').value =
                    p.cover || p.image || ''
                document.getElementById('productDesc').value = p.desc || ''

                document
                    .getElementById('productForm')
                    .scrollIntoView({ behavior: 'smooth' })
            }

            function removeProduct(id) {
                if (!confirm('❓ Bạn có chắc muốn xóa sản phẩm này?')) return

                const products = getProducts().filter((p) => p.id !== id)
                saveProducts(products)

                // Auto reload
                renderProductsList()
                renderTopProducts()
                updateStats()

                alert('✅ Đã xóa sản phẩm!')
            }

            /* ===== ORDERS ===== */
            function renderOrdersList() {
                const q = (
                    document.getElementById('searchOrder')?.value || ''
                ).toLowerCase()
                const body = document.getElementById('ordersBody')
                const orders = getOrders().filter(
                    (o) =>
                        o.id.toLowerCase().includes(q) ||
                        (o.shippingAddress?.fullname || o.customer || '')
                            .toLowerCase()
                            .includes(q)
                )

                if (orders.length === 0) {
                    body.innerHTML =
                        '<tr><td colspan="7" class="empty" style="text-align:center;padding:40px">📭 Không có đơn hàng</td></tr>'
                } else {
                    body.innerHTML = orders
                        .map((o) => {
                            let actionButtons = ''

                            if (o.status === 'Đã giao') {
                                // Đơn hàng đã hoàn thành - chỉ hiển thị nút Xem
                                actionButtons = `<button style="background:#3b82f6;color:white;padding:6px 12px" onclick="viewOrder('${o.id}')">👁️ Xem</button>
                             <span style="color:#10b981;font-weight:bold">✅ Hoàn thành</span>`
                            } else if (o.status === 'Đã hủy') {
                                // Đơn hàng đã hủy - chỉ hiển thị nút Xem
                                actionButtons = `<button style="background:#3b82f6;color:white;padding:6px 12px" onclick="viewOrder('${o.id}')">👁️ Xem</button>
                             <span style="color:#ef4444;font-weight:bold">❌ Đã hủy</span>`
                            } else {
                                // Đơn hàng chưa hoàn thành - hiển thị tất cả nút
                                actionButtons = `<button style="background:#3b82f6;color:white;padding:6px 12px;margin-right:4px" onclick="viewOrder('${o.id}')">👁️ Xem</button>
                             <button style="background:#ff9800;color:white;padding:6px 12px;margin-right:4px" onclick="processOrder('${o.id}')">⚙️ Xử lý</button>
                             <button style="background:#ef4444;color:white;padding:6px 12px" onclick="cancelOrderFromAdmin('${o.id}')">❌ Hủy</button>`
                            }

                            return `
            <tr>
              <td><strong>${o.id}</strong></td>
              <td>${o.shippingAddress?.fullname || o.customer || 'N/A'}</td>
              <td>${o.date}</td>
              <td style="font-weight:700;color:var(--primary)">${(
                  o.total || 0
              ).toLocaleString('vi-VN')}₫</td>
              <td><span class="badge">${o.status}</span></td>
              <td>${actionButtons}</td>
            </tr>
          `
                        })
                        .join('')
                }
            }

            function viewOrder(id) {
                const o = getOrders().find((x) => x.id === id)
                if (!o) return alert('❌ Không tìm thấy đơn hàng!')

                const customerName =
                    o.shippingAddress?.fullname || o.customer || 'N/A'
                const phone = o.shippingAddress?.phone || 'N/A'
                const address = o.shippingAddress
                    ? `${o.shippingAddress.street}, ${o.shippingAddress.district}, ${o.shippingAddress.city}`
                    : 'N/A'
                const items = o.items
                    ? o.items
                          .map(
                              (i) =>
                                  `  • ${i.title} x${i.quantity} = ${(
                                      i.price * i.quantity
                                  ).toLocaleString('vi-VN')}₫`
                          )
                          .join('\n')
                    : '  Không có sản phẩm'

                alert(`📦 CHI TIẾT ĐƠN HÀNG

🆔 Mã đơn: ${o.id}
📅 Ngày đặt: ${o.date}
💰 Tổng tiền: ${(o.total || 0).toLocaleString('vi-VN')}₫
📊 Trạng thái: ${o.status}

👤 THÔNG TIN KHÁCH HÀNG:
  Họ tên: ${customerName}
  SĐT: ${phone}
  Địa chỉ: ${address}

📦 SẢN PHẨM:
${items}`)
            }

            function processOrder(id) {
                const orders = getOrders()
                const o = orders.find((x) => x.id === id)
                if (!o) return alert('❌ Không tìm thấy đơn hàng!')

                // Không cho cập nhật khi đã hoàn thành
                if (o.status === 'Đã giao') {
                    return alert(
                        '⚠️ Đơn hàng đã hoàn thành! Không thể cập nhật trạng thái.'
                    )
                }

                if (o.status === 'Đã hủy') {
                    return alert(
                        '⚠️ Đơn hàng đã bị hủy! Không thể cập nhật trạng thái.'
                    )
                }

                const statuses = [
                    'Chưa xử lý',
                    'Đang xử lý',
                    'Đã gửi',
                    'Đã giao',
                ]
                const currentIdx = statuses.indexOf(o.status)
                const nextIdx = (currentIdx + 1) % statuses.length
                const nextStatus = statuses[nextIdx]

                if (
                    !confirm(
                        `📦 Chuyển trạng thái từ "${o.status}" → "${nextStatus}"?\n\nNếu là "Đang xử lý" sẽ tự trừ số lượng sản phẩm!`
                    )
                ) {
                    return
                }

                // Nếu chuyển sang "Đang xử lý" thì trừ số lượng sản phẩm (chỉ lần đầu)
                if (nextStatus === 'Đang xử lý' && o.status === 'Chưa xử lý') {
                    const products = getProducts()
                    let hasError = false
                    const itemsDetail = []

                    console.log('🔍 DEBUG: Bắt đầu xử lý đơn', id)
                    console.log(
                        '📦 DEBUG: Số lượng sản phẩm trong kho:',
                        products.length
                    )
                    console.log('📦 DEBUG: Items trong đơn:', o.items)

                    o.items.forEach((item) => {
                        console.log(`🔎 Tìm sản phẩm với ID: ${item.id}`)
                        const product = products.find((p) => p.id === item.id)
                        console.log(`✓ Tìm thấy:`, product)

                        if (product) {
                            if (product.stock === undefined) product.stock = 0
                            console.log(
                                `📊 Stock hiện tại: ${product.stock}, cần trừ: ${item.quantity}`
                            )

                            if (product.stock < item.quantity) {
                                alert(
                                    `❌ Sản phẩm "${item.title}" không đủ kho!\nCó: ${product.stock}, cần: ${item.quantity}`
                                )
                                hasError = true
                                return
                            }
                            const oldStock = product.stock
                            product.stock -= item.quantity
                            console.log(
                                `✅ Đã trừ: ${oldStock} → ${product.stock}`
                            )
                            itemsDetail.push(
                                `  ✓ ${item.title}: -${item.quantity} (${oldStock} → ${product.stock})`
                            )
                        } else {
                            console.log(
                                `❌ KHÔNG TÌM THẤY sản phẩm ID ${item.id}`
                            )
                            alert(`❌ Sản phẩm ID ${item.id} không tồn tại!`)
                            hasError = true
                        }
                    })

                    if (hasError) return

                    // Lưu lại số lượng sản phẩm
                    console.log('💾 Lưu products vào localStorage:', products)
                    saveProducts(products)

                    alert(
                        `✅ Chuyển trạng thái thành công!\n📦 Đã trừ khỏi kho:\n${itemsDetail.join(
                            '\n'
                        )}`
                    )
                } else if (
                    nextStatus === 'Đang xử lý' &&
                    o.status !== 'Chưa xử lý'
                ) {
                    alert(
                        '⚠️ Đơn hàng đã được xử lý rồi! Không thể trừ kho lần nữa.'
                    )
                } else {
                    alert(`✅ Trạng thái cập nhật: ${nextStatus}`)
                }

                // Cập nhật trạng thái đơn hàng
                o.status = nextStatus
                saveOrders(orders)
                console.log('✅ Đã cập nhật trạng thái đơn hàng')
                renderOrdersList()
            }

            function cancelOrderFromAdmin(id) {
                const orders = getOrders()
                const o = orders.find((x) => x.id === id)
                if (!o) return alert('❌ Không tìm thấy đơn hàng!')

                if (o.status === 'Đã hủy') {
                    return alert('⚠️ Đơn hàng này đã bị hủy rồi!')
                }

                if (o.status === 'Đã giao') {
                    return alert('⚠️ Đơn hàng đã hoàn thành! Không thể hủy.')
                }

                if (
                    !confirm(
                        `⚠️ Bạn chắc chắn muốn hủy đơn hàng ${id}?\n\n✅ Lưu ý: Số lượng sản phẩm sẽ KHÔNG bị trừ!`
                    )
                ) {
                    return
                }

                o.status = 'Đã hủy'
                saveOrders(orders)
                renderOrdersList()
                alert(
                    `❌ Đơn hàng ${id} đã được hủy.\n✅ Số lượng sản phẩm không bị trừ khỏi kho.`
                )
            }

            /* ===== USERS ===== */
            function renderUsersList() {
                const body = document.getElementById('usersBody')
                const users = getUsers()

                if (users.length === 0) {
                    body.innerHTML =
                        '<tr><td colspan="3" class="empty" style="text-align:center;padding:40px">👤 Chưa có người dùng nào</td></tr>'
                } else {
                    body.innerHTML = users
                        .map((u) => {
                            // Xử lý locked: chuyển đổi thành boolean để đảm bảo tính nhất quán
                            const isLocked =
                                u.locked === true || u.locked === 'true'
                            const identifier = u.email || u.username || 'N/A'
                            // Escape identifier để tránh lỗi khi có ký tự đặc biệt
                            const safeIdentifier = identifier.replace(
                                /'/g,
                                "\\'"
                            )

                            return `
          <tr>
            <td><strong>${identifier}</strong></td>
            <td>
              <span class="badge" style="background:${
                  isLocked ? '#fee2e2' : '#d1fae5'
              };color:${isLocked ? '#991b1b' : '#065f46'}">
                ${isLocked ? '🔒 Đã khóa' : '✅ Hoạt động'}
              </span>
            </td>
            <td>
              <button style="background:${
                  isLocked ? '#10b981' : '#f59e0b'
              };color:white;margin-right:6px" onclick="toggleLock('${safeIdentifier}')">
                ${isLocked ? '🔓 Mở khóa' : '🔒 Khóa'}
              </button>
              <button style="background:#ef4444;color:white" onclick="deleteUser('${safeIdentifier}')">🗑️ Xóa</button>
            </td>
          </tr>
        `
                        })
                        .join('')
                }
                updateStats()
            }

            function toggleLock(identifier) {
                const users = getUsers()
                const u = users.find(
                    (x) => x.email === identifier || x.username === identifier
                )
                if (!u) return alert('❌ Không tìm thấy người dùng!')

                // Đảm bảo locked là boolean và toggle giá trị
                // Xử lý các trường hợp: undefined, null, string 'true'/'false', boolean
                const currentLocked = u.locked === true || u.locked === 'true'
                u.locked = !currentLocked // Toggle: true -> false, false -> true

                console.log(
                    '✅ Toggling lock for:',
                    identifier,
                    'Old:',
                    currentLocked,
                    'New:',
                    u.locked
                )
                saveUsers(users)
                renderUsersList()
                alert(
                    u.locked
                        ? '🔒 Đã khóa tài khoản!'
                        : '🔓 Đã mở khóa tài khoản!'
                )
            }

            function deleteUser(identifier) {
                if (!confirm('❓ Bạn có chắc muốn xóa người dùng này?')) return

                const users = getUsers().filter(
                    (u) => u.email !== identifier && u.username !== identifier
                )
                saveUsers(users)
                renderUsersList()
                alert('✅ Đã xóa người dùng!')
            }

            /* ===== TAB SWITCHING ===== */
            function switchTab(name, el) {
                document
                    .querySelectorAll('.tab')
                    .forEach((t) => (t.style.display = 'none'))
                document.getElementById(name).style.display = 'block'

                document
                    .querySelectorAll('.nav-item')
                    .forEach((n) => n.classList.remove('active'))
                if (el) el.classList.add('active')

                // Render on demand
                if (name === 'dashboard') {
                    renderRecentOrders()
                    renderTopProducts()
                    updateStats()
                }
                if (name === 'products') {
                    renderProductsList()
                }
                if (name === 'orders') {
                    renderOrdersList()
                }
                if (name === 'users') {
                    renderUsersList()
                }
                if (name === 'pricing') {
                    renderPricingList()
                }
                if (name === 'import') {
                    renderImportList()
                }

                window.scrollTo({ top: 0, behavior: 'smooth' })
            }

            /* ===== PRICING MANAGEMENT ===== */
            const getPricing = () =>
                JSON.parse(localStorage.getItem('bs_pricing') || '[]')
            const setPricing = (p) =>
                localStorage.setItem('bs_pricing', JSON.stringify(p))

            function renderPricingList() {
                const pricing = getPricing()
                const tbody = document.querySelector('#pricingBody')
                tbody.innerHTML = pricing
                    .map(
                        (p) => `
        <tr>
          <td>${p.name}</td>
          <td>${p.discount}%</td>
          <td>${p.desc || 'N/A'}</td>
          <td>
            <button onclick="editPricing('${
                p.id
            }')" style="background:#3b82f6;color:white;padding:6px 12px">✏️</button>
            <button onclick="deletePricing('${
                p.id
            }')" style="background:#ff6b6b;color:white;padding:6px 12px">🗑️</button>
          </td>
        </tr>
      `
                    )
                    .join('')
                if (!pricing.length)
                    tbody.innerHTML =
                        '<tr><td colspan="4" style="text-align:center;color:#666">Chưa có mức giá</td></tr>'
            }

            function savePricingForm() {
                const id =
                    document.getElementById('pricingId').value ||
                    'p' + Date.now()
                const name = document.getElementById('pricingName').value.trim()
                const discount =
                    parseInt(
                        document.getElementById('pricingDiscount').value
                    ) || 0
                const desc = document.getElementById('pricingDesc').value.trim()
                if (!name) return alert('❌ Nhập tên mức giá!')
                const pricing = getPricing()
                const idx = pricing.findIndex((x) => x.id === id)
                if (idx >= 0) pricing[idx] = { id, name, discount, desc }
                else pricing.push({ id, name, discount, desc })
                setPricing(pricing)
                document.getElementById('pricingForm').reset()
                document.getElementById('pricingId').value = ''
                renderPricingList()
                alert('✅ Lưu thành công!')
            }

            function editPricing(id) {
                const pricing = getPricing()
                const p = pricing.find((x) => x.id === id)
                if (p) {
                    document.getElementById('pricingId').value = p.id
                    document.getElementById('pricingName').value = p.name
                    document.getElementById('pricingDiscount').value =
                        p.discount
                    document.getElementById('pricingDesc').value = p.desc
                }
            }

            function deletePricing(id) {
                if (confirm('Xóa mức giá này?')) {
                    let pricing = getPricing()
                    pricing = pricing.filter((p) => p.id !== id)
                    setPricing(pricing)
                    renderPricingList()
                }
            }

            function resetPricingForm() {
                document.getElementById('pricingForm').reset()
                document.getElementById('pricingId').value = ''
            }

            /* ===== IMPORT RECEIPTS MANAGEMENT ===== */
            const getImportReceipts = () =>
                JSON.parse(localStorage.getItem('bs_import_receipts') || '[]')
            const setImportReceipts = (r) =>
                localStorage.setItem('bs_import_receipts', JSON.stringify(r))

            function renderImportList() {
                const receipts = getImportReceipts()
                const tbody = document.querySelector('#importBody')
                tbody.innerHTML = receipts
                    .map(
                        (r) => `
        <tr>
          <td>${r.date}</td>
          <td>${r.productId}</td>
          <td>${r.quantity}</td>
          <td>${r.price.toLocaleString('vi-VN')} ₫</td>
          <td>${(r.quantity * r.price).toLocaleString('vi-VN')} ₫</td>
          <td><span class="badge" style="background:${
              r.status === 'Chưa vào kho' ? '#fff3e0' : '#e8f5e9'
          };color:${r.status === 'Chưa vào kho' ? '#a65a00' : '#2e7d32'}">${
                            r.status === 'Chưa vào kho'
                                ? '⏳ Chưa vào kho'
                                : '✅ Đã nhập kho'
                        }</span></td>
          <td>
            ${
                r.status === 'Chưa vào kho'
                    ? `<button onclick="editImport('${r.id}')" style="background:#3b82f6;color:white;padding:6px 12px;margin-right:6px">✏️</button><button onclick="completeImport('${r.id}')" style="background:#4CAF50;color:white;padding:6px 12px;margin-right:6px">✅</button>`
                    : ''
            }
            <button onclick="deleteImport('${
                r.id
            }')" style="background:#ff6b6b;color:white;padding:6px 12px">🗑️</button>
          </td>
        </tr>
      `
                    )
                    .join('')
                if (!receipts.length)
                    tbody.innerHTML =
                        '<tr><td colspan="7" style="text-align:center;color:#666">Chưa có phiếu nhập</td></tr>'
            }

            function saveImportReceipt() {
                const date = document.getElementById('importDate').value
                const productId = document
                    .getElementById('importProductId')
                    .value.trim()
                const quantity = parseInt(
                    document.getElementById('importQuantity').value
                )
                const price = parseInt(
                    document.getElementById('importPrice').value
                )
                const id = document.getElementById('importId').value
                if (!date || !productId || !quantity || !price)
                    return alert('❌ Điền đầy đủ!')
                const receipts = getImportReceipts()
                const dateObj = new Date(date)
                const formattedDate = dateObj.toLocaleDateString('vi-VN')
                const newReceipt = {
                    id: id || 'imp' + Date.now(),
                    date: formattedDate,
                    productId,
                    quantity,
                    price,
                    status: 'Chưa vào kho',
                }
                if (id) {
                    const idx = receipts.findIndex((r) => r.id === id)
                    if (idx >= 0 && receipts[idx].status === 'Đã nhập kho')
                        return alert('❌ Phiếu đã hoàn thành!')
                    if (idx >= 0) receipts[idx] = newReceipt
                } else receipts.push(newReceipt)
                setImportReceipts(receipts)
                resetImportForm()
                renderImportList()
                alert(id ? '✅ Cập nhật!' : '✅ Tạo phiếu!')
            }

            function editImport(id) {
                const receipts = getImportReceipts()
                const receipt = receipts.find((r) => r.id === id)
                if (receipt && receipt.status === 'Đã nhập kho')
                    return alert('❌ Phiếu đã hoàn thành!')
                if (receipt) {
                    document.getElementById('importId').value = receipt.id
                    const [day, month, year] = receipt.date.split('/')
                    document.getElementById(
                        'importDate'
                    ).value = `${year}-${month}-${day}`
                    document.getElementById('importProductId').value =
                        receipt.productId
                    document.getElementById('importQuantity').value =
                        receipt.quantity
                    document.getElementById('importPrice').value = receipt.price
                }
            }

            function completeImport(id) {
                if (
                    !confirm(
                        'Hoàn thành phiếu? (Sẽ cộng số lượng vào kho sản phẩm)'
                    )
                )
                    return
                const receipts = getImportReceipts()
                const receipt = receipts.find((r) => r.id === id)
                if (receipt && receipt.status === 'Chưa vào kho') {
                    // Cập nhật stock của sản phẩm
                    const products = getProducts()
                    const product = products.find(
                        (p) => p.id === receipt.productId
                    )

                    if (product) {
                        // Nếu sản phẩm chưa có stock, khởi tạo = 0
                        if (product.stock === undefined) product.stock = 0
                        product.stock += receipt.quantity
                        saveProducts(products)

                        // Cập nhật trạng thái phiếu
                        receipt.status = 'Đã nhập kho'
                        setImportReceipts(receipts)
                        renderImportList()
                        alert(
                            `✅ Phiếu hoàn thành!\n📦 Sản phẩm ${receipt.productId} + ${receipt.quantity} = ${product.stock} cái`
                        )

                        // Render lại danh sách sản phẩm nếu đang hiển thị
                        if (document.querySelector('#productTable tbody'))
                            renderProductsList()
                    } else {
                        alert(
                            '❌ Sản phẩm không tồn tại! ID: ' +
                                receipt.productId
                        )
                    }
                }
            }

            function deleteImport(id) {
                if (confirm('Xóa phiếu?')) {
                    let receipts = getImportReceipts()
                    receipts = receipts.filter((r) => r.id !== id)
                    setImportReceipts(receipts)
                    renderImportList()
                }
            }

            function resetImportForm() {
                document.getElementById('importForm').reset()
                document.getElementById('importId').value = ''
                const today = new Date().toISOString().split('T')[0]
                document.getElementById('importDate').value = today
            }

            /* ===== LOGOUT ===== */
            function logout() {
                if (confirm('❓ Bạn có chắc muốn đăng xuất?')) {
                    localStorage.removeItem('bs_admin_session')
                    localStorage.removeItem('bs_auth')
                    window.location.href = 'admin-login.html'
                }
            }

            /* ===== EXPORT DATA ===== */
            function exportData() {
                const data = {
                    products: getProducts(),
                    orders: getOrders(),
                    users: getUsers().map((u) => ({ ...u, password: '***' })), // Ẩn password
                    exportDate: new Date().toISOString(),
                }

                const json = JSON.stringify(data, null, 2)
                const blob = new Blob([json], { type: 'application/json' })
                const url = URL.createObjectURL(blob)
                const a = document.createElement('a')
                a.href = url
                a.download = `bookstore-backup-${Date.now()}.json`
                a.click()
                URL.revokeObjectURL(url)

                alert('✅ Đã xuất dữ liệu thành công!')
            }

            /* ===== INIT ===== */
            ;(async function init() {
                // Check admin auth
                const adminAuth = localStorage.getItem('bs_admin_session')
                if (!adminAuth) {
                    alert('⚠️ Vui lòng đăng nhập với tài khoản admin!')
                    window.location.href = 'admin-login.html'
                    return
                }

                // Seed data
                await seedData()

                // Initial render
                updateStats()
                renderRecentOrders()
                renderTopProducts()
                renderProductsList()
                renderOrdersList()
                renderUsersList()

                console.log('✅ Admin panel loaded successfully!')
                console.log('📊 Stats:', {
                    products: getProducts().length,
                    orders: getOrders().length,
                    users: getUsers().length,
                })
            })()
        </script>
    </body>
</html>
