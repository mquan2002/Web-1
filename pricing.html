<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu·∫£n l√Ω gi√° b√°n theo s·∫£n ph·∫©m</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 25px 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .header h1 {
      color: #667eea;
      font-size: 28px;
      margin-bottom: 10px;
    }

    .header nav {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .header nav a {
      padding: 8px 16px;
      background: #f0f0f0;
      border-radius: 8px;
      text-decoration: none;
      color: #333;
      font-weight: 500;
      transition: all 0.3s;
    }

    .header nav a:hover, .header nav a.active {
      background: #667eea;
      color: white;
    }

    .card {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .card h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 22px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }

    .search-filter {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }

    input, select {
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 15px;
      transition: border-color 0.3s;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 10px;
      text-align: left;
      font-weight: 600;
    }

    td {
      padding: 15px 10px;
      border-bottom: 1px solid #e0e0e0;
    }

    tr:hover {
      background: #f8f9ff;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover {
      background: #059669;
      transform: translateY(-2px);
    }

    .profit-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 13px;
    }

    .profit-positive {
      background: #d1fae5;
      color: #065f46;
    }

    .profit-high {
      background: #fef3c7;
      color: #92400e;
    }

    .price-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .price-input {
      width: 120px;
      padding: 6px 10px;
      font-size: 14px;
    }

    .profit-input {
      width: 80px;
      padding: 6px 10px;
      font-size: 14px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      text-align: center;
    }

    .stat-card .icon {
      font-size: 36px;
      margin-bottom: 10px;
    }

    .stat-card .label {
      color: #666;
      font-size: 14px;
      margin-bottom: 5px;
    }

    .stat-card .value {
      color: #667eea;
      font-size: 24px;
      font-weight: 700;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-state .icon {
      font-size: 64px;
      margin-bottom: 15px;
      opacity: 0.3;
    }

    @media (max-width: 768px) {
      .search-filter {
        grid-template-columns: 1fr;
      }

      table {
        font-size: 13px;
      }

      th, td {
        padding: 10px 5px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üí≤ Qu·∫£n l√Ω Gi√° B√°n Theo S·∫£n Ph·∫©m</h1>
      <nav>
        <a href="index.html">üè† Trang ch·ªß</a>
        <a href="admin.html">üìò Qu·∫£n tr·ªã</a>
        <a class="active" href="#">üí≤ Gi√° b√°n</a>
      </nav>
    </div>

    <!-- Th·ªëng k√™ t·ªïng quan -->
    <div class="stats-grid" id="statsGrid"></div>

    <!-- B·∫£ng qu·∫£n l√Ω gi√° -->
    <div class="card">
      <h2>üìã Danh s√°ch s·∫£n ph·∫©m v√† gi√° b√°n</h2>
      
      <div class="search-filter">
        <input type="text" id="searchProduct" placeholder="üîç T√¨m ki·∫øm theo t√™n s√°ch ho·∫∑c ID...">
        <select id="categoryFilter">
          <option value="">-- T·∫•t c·∫£ th·ªÉ lo·∫°i --</option>
        </select>
        <select id="profitFilter">
          <option value="">-- L·ªçc theo l·ª£i nhu·∫≠n --</option>
          <option value="low">0-20%</option>
          <option value="medium">20-40%</option>
          <option value="high">>40%</option>
        </select>
      </div>

      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>T√™n s√°ch</th>
            <th>Th·ªÉ lo·∫°i</th>
            <th>Gi√° v·ªën (‚Ç´)</th>
            <th>% L·ª£i nhu·∫≠n</th>
            <th>Gi√° b√°n (‚Ç´)</th>
            <th>L·ª£i nhu·∫≠n/SP (‚Ç´)</th>
            <th>H√†nh ƒë·ªông</th>
          </tr>
        </thead>
        <tbody id="priceTable"></tbody>
      </table>
    </div>
  </div>

  <script>
    // L·∫•y d·ªØ li·ªáu t·ª´ localStorage
    const getProducts = () => JSON.parse(localStorage.getItem('bs_products') || '[]');
    const saveProducts = (arr) => localStorage.setItem('bs_products', JSON.stringify(arr));

    let products = getProducts();
    let editingProductId = null;

    // Kh·ªüi t·∫°o gi√° tr·ªã m·∫∑c ƒë·ªãnh cho s·∫£n ph·∫©m ch∆∞a c√≥ pricing
    function initializeProductPricing() {
      let hasChanges = false;
      products.forEach(product => {
        if (!product.costPrice) {
          product.costPrice = product.price; // Gi√° v·ªën = gi√° g·ªëc
          hasChanges = true;
        }
        if (product.profitPercent === undefined) {
          product.profitPercent = 30; // M·∫∑c ƒë·ªãnh 30% l·ª£i nhu·∫≠n
          hasChanges = true;
        }
        if (!product.sellPrice) {
          product.sellPrice = Math.round(product.costPrice * (1 + product.profitPercent / 100));
          hasChanges = true;
        }
      });
      
      if (hasChanges) {
        saveProducts(products);
      }
    }

    // Render th·ªëng k√™
    function renderStats() {
      const totalProducts = products.length;
      const avgProfit = products.length > 0 
        ? (products.reduce((sum, p) => sum + (p.profitPercent || 0), 0) / products.length).toFixed(1)
        : 0;
      
      const totalRevenue = products.reduce((sum, p) => {
        const profit = (p.sellPrice || 0) - (p.costPrice || 0);
        return sum + profit;
      }, 0);

      const highProfitCount = products.filter(p => (p.profitPercent || 0) > 40).length;

      document.getElementById('statsGrid').innerHTML = `
        <div class="stat-card">
          <div class="icon">üìö</div>
          <div class="label">T·ªïng s·∫£n ph·∫©m</div>
          <div class="value">${totalProducts}</div>
        </div>
        <div class="stat-card">
          <div class="icon">üìä</div>
          <div class="label">% L·ª£i nhu·∫≠n TB</div>
          <div class="value">${avgProfit}%</div>
        </div>
        <div class="stat-card">
          <div class="icon">üí∞</div>
          <div class="label">L·ª£i nhu·∫≠n/SP TB</div>
          <div class="value">${Math.round(totalRevenue / (totalProducts || 1)).toLocaleString()}‚Ç´</div>
        </div>
        <div class="stat-card">
          <div class="icon">üî•</div>
          <div class="label">SP l·ª£i nhu·∫≠n cao</div>
          <div class="value">${highProfitCount}</div>
        </div>
      `;
    }

    // Render b·∫£ng gi√°
    function renderPriceTable(filteredProducts = products) {
      const tbody = document.getElementById('priceTable');
      
      if (filteredProducts.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8">
              <div class="empty-state">
                <div class="icon">üì≠</div>
                <p>Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o</p>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = filteredProducts.map(product => {
        const costPrice = product.costPrice || product.price || 0;
        const profitPercent = product.profitPercent || 0;
        const sellPrice = product.sellPrice || costPrice;
        const profitAmount = sellPrice - costPrice;
        
        const profitClass = profitPercent > 40 ? 'profit-high' : 'profit-positive';

        return `
          <tr>
            <td><strong>${product.id}</strong></td>
            <td>${product.title}</td>
            <td>${product.category || 'N/A'}</td>
            <td>
              ${editingProductId === product.id 
                ? `<input type="number" class="price-input" id="cost-${product.id}" value="${costPrice}" min="0">`
                : `<strong>${costPrice.toLocaleString()}‚Ç´</strong>`
              }
            </td>
            <td>
              ${editingProductId === product.id
                ? `<div class="price-group"><input type="number" class="profit-input" id="profit-${product.id}" value="${profitPercent}" min="0" max="1000"> %</div>`
                : `<span class="profit-badge ${profitClass}">${profitPercent}%</span>`
              }
            </td>
            <td>
              <strong style="color: #667eea; font-size: 16px">${sellPrice.toLocaleString()}‚Ç´</strong>
            </td>
            <td>
              <strong style="color: #10b981">+${profitAmount.toLocaleString()}‚Ç´</strong>
            </td>
            <td>
              ${editingProductId === product.id
                ? `<button class="btn btn-success" onclick="savePricing('${product.id}')">üíæ L∆∞u</button> <button class="btn" onclick="cancelEdit()">‚ùå</button>`
                : `<button class="btn btn-primary" onclick="editPricing('${product.id}')">‚úèÔ∏è S·ª≠a gi√°</button>`
              }
            </td>
          </tr>
        `;
      }).join('');
    }

    // Load categories v√†o filter
    function loadCategories() {
      const categories = [...new Set(products.map(p => p.category).filter(Boolean))];
      const select = document.getElementById('categoryFilter');
      
      categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        select.appendChild(option);
      });
    }

    // Ch·ªânh s·ª≠a gi√°
    function editPricing(productId) {
      editingProductId = productId;
      renderPriceTable(getFilteredProducts());
    }

    // L∆∞u gi√° m·ªõi
    function savePricing(productId) {
      const costInput = document.getElementById(`cost-${productId}`);
      const profitInput = document.getElementById(`profit-${productId}`);
      
      if (!costInput || !profitInput) return;

      const costPrice = parseFloat(costInput.value) || 0;
      const profitPercent = parseFloat(profitInput.value) || 0;
      const sellPrice = Math.round(costPrice * (1 + profitPercent / 100));

      const product = products.find(p => p.id === productId);
      if (product) {
        product.costPrice = costPrice;
        product.profitPercent = profitPercent;
        product.sellPrice = sellPrice;
        product.price = sellPrice; // C·∫≠p nh·∫≠t gi√° hi·ªÉn th·ªã tr√™n trang ch√≠nh
        
        saveProducts(products);
        editingProductId = null;
        
        renderStats();
        renderPriceTable(getFilteredProducts());
        
        alert('‚úÖ ƒê√£ c·∫≠p nh·∫≠t gi√° th√†nh c√¥ng!');
      }
    }

    // H·ªßy ch·ªânh s·ª≠a
    function cancelEdit() {
      editingProductId = null;
      renderPriceTable(getFilteredProducts());
    }

    // L·ªçc s·∫£n ph·∫©m
    function getFilteredProducts() {
      const searchTerm = document.getElementById('searchProduct').value.toLowerCase();
      const categoryFilter = document.getElementById('categoryFilter').value;
      const profitFilter = document.getElementById('profitFilter').value;

      return products.filter(product => {
        const matchSearch = product.title.toLowerCase().includes(searchTerm) || 
                           product.id.toLowerCase().includes(searchTerm);
        const matchCategory = !categoryFilter || product.category === categoryFilter;
        
        let matchProfit = true;
        if (profitFilter === 'low') {
          matchProfit = (product.profitPercent || 0) < 20;
        } else if (profitFilter === 'medium') {
          matchProfit = (product.profitPercent || 0) >= 20 && (product.profitPercent || 0) <= 40;
        } else if (profitFilter === 'high') {
          matchProfit = (product.profitPercent || 0) > 40;
        }

        return matchSearch && matchCategory && matchProfit;
      });
    }

    // X·ª≠ l√Ω s·ª± ki·ªán filter
    function setupFilters() {
      document.getElementById('searchProduct').addEventListener('input', () => {
        renderPriceTable(getFilteredProducts());
      });

      document.getElementById('categoryFilter').addEventListener('change', () => {
        renderPriceTable(getFilteredProducts());
      });

      document.getElementById('profitFilter').addEventListener('change', () => {
        renderPriceTable(getFilteredProducts());
      });
    }

    // Kh·ªüi t·∫°o
    initializeProductPricing();
    loadCategories();
    renderStats();
    renderPriceTable();
    setupFilters();
  </script>
</body>
</html>